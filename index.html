<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Print Business Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0A0A0A;
            --bg-secondary: #1A1A1A;
            --bg-card: #1E1E1E;
            --bg-elevated: #262626;
            --border-primary: #2A2A2A;
            --border-secondary: #3A3A3A;
            --text-primary: #FFFFFF;
            --text-secondary: #B3B3B3;
            --text-muted: #7A7A7A;
            --accent-primary: #22c55e;
            --accent-hover: #16a34a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Cloudflare Usage Bar */
        .cloudflare-usage-bar {
            background: linear-gradient(135deg, #1a1a1a 0%, #262626 100%);
            border-bottom: 1px solid var(--border-primary);
            padding: 12px 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
            font-size: 13px;
        }

        .cf-usage-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #f97316;
        }

        .cf-usage-stats {
            display: flex;
            gap: 2rem;
            flex: 1;
        }

        .cf-usage-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cf-usage-label {
            color: var(--text-muted);
            font-weight: 500;
        }

        .cf-usage-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .cf-usage-bar-wrapper {
            flex: 1;
            max-width: 200px;
        }

        .cf-usage-progress {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }

        .cf-usage-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f97316 0%, #fb923c 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .cf-status-badge {
            padding: 4px 12px;
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border-radius: 12px;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cf-delete-all-btn {
            padding: 6px 16px;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: auto;
        }

        .cf-delete-all-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .nav-tabs {
            background: var(--bg-secondary);
            padding: 0 2rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            gap: 0;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .nav-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
            background: rgba(34, 197, 94, 0.05);
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .form-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-secondary);
            color: var(--text-primary);
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.1);
        }

        /* Fix ALL select dropdowns to have dark background */
        select {
            background: #1e1e2e !important;
            background-color: #1e1e2e !important;
            color: #e1e1e3 !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        select option {
            background: #1e1e2e !important;
            background-color: #1e1e2e !important;
            color: #e1e1e3 !important;
            padding: 8px !important;
        }

        select option:hover,
        select option:focus,
        select option:checked,
        select option:active {
            background: #2a2a3e !important;
            background-color: #2a2a3e !important;
            color: #22c55e !important;
        }

        /* Ensure all select elements including dynamically created ones */
        select.form-input,
        .modal select,
        #addMaterialModal select,
        #addPrinterModal select,
        #addOrderModal select,
        #editInquiryModal select,
        #printerSelectModal select,
        #statusSelectModal select {
            background: #1e1e2e !important;
            background-color: #1e1e2e !important;
            color: #e1e1e3 !important;
        }

        /* Fix select arrow color */
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e1e1e3' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 0.7rem center !important;
            background-size: 1.2em 1.2em !important;
            padding-right: 2.5rem !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: rgba(34, 197, 94, 0.9);
            color: white;
        }

        .notification.error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }

        .notification.info {
            background: rgba(59, 130, 246, 0.9);
            color: white;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Inquiries Table Styling to match screenshot */
        #inquiriesTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #inquiriesTable th {
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: #6b7280;
            background: transparent;
            border-bottom: 1px solid #374151;
        }

        #inquiriesTable tbody tr {
            border-bottom: 1px solid #1f2937;
        }

        #inquiriesTable tbody tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        #inquiriesTable td {
            padding: 16px 12px;
            color: #e5e7eb;
            font-size: 14px;
        }

        /* Material badge styling */
        .material-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Quote amount styling */
        .quote-amount {
            color: #22c55e !important;
            font-weight: 600;
            font-size: 16px;
        }

        /* Status badge styling */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
            border: 1px solid rgba(251, 146, 60, 0.3);
        }

        .status-purchased {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* Action buttons styling to match screenshot */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-buttons button {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid;
        }

        .btn-edit {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.3) !important;
        }

        .btn-edit:hover {
            background: rgba(59, 130, 246, 0.25);
        }

        .btn-purchase {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3) !important;
        }

        .btn-purchase:hover {
            background: rgba(34, 197, 94, 0.25);
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3) !important;
        }

        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }

            #inquiriesTable {
                font-size: 12px;
            }

            #inquiriesTable th,
            #inquiriesTable td {
                padding: 8px 6px !important;
                min-width: 60px !important;
            }

            .action-btn {
                padding: 4px 6px !important;
                font-size: 10px !important;
            }

            /* Stack action buttons vertically on mobile */
            #inquiriesTable td:last-child > div {
                flex-direction: column !important;
                gap: 4px !important;
            }

            /* Hide less important columns on mobile */
            #inquiriesTable th:nth-child(4),
            #inquiriesTable td:nth-child(4),
            #inquiriesTable th:nth-child(6),
            #inquiriesTable td:nth-child(6),
            #inquiriesTable th:nth-child(7),
            #inquiriesTable td:nth-child(7) {
                display: none;
            }
        }

        @media (max-width: 480px) {
            #inquiriesTable th:nth-child(3),
            #inquiriesTable td:nth-child(3),
            #inquiriesTable th:nth-child(5),
            #inquiriesTable td:nth-child(5) {
                display: none;
            }
        }

        /* Modal styling improvements */
        .modal {
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal > div {
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translate(-50%, -60%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Cloudflare Usage Bar -->
    <div class="cloudflare-usage-bar" id="cloudflareUsageBar">
        <div class="cf-usage-title">
            ‚òÅÔ∏è Cloudflare
        </div>
        <div class="cf-usage-stats">
            <div class="cf-usage-item">
                <span class="cf-usage-label">Storage:</span>
                <div class="cf-usage-bar-wrapper">
                    <div class="cf-usage-value" id="cfStorageText">0 MB / 10 GB</div>
                    <div class="cf-usage-progress">
                        <div class="cf-usage-progress-fill" id="cfStorageBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="cf-usage-item">
                <span class="cf-usage-label">Files:</span>
                <span class="cf-usage-value" id="cfFilesCount">0</span>
            </div>
            <div class="cf-usage-item">
                <span class="cf-usage-label">Inquiries:</span>
                <span class="cf-usage-value" id="cfInquiriesCount">0</span>
            </div>
            <div class="cf-usage-item">
                <span class="cf-usage-label">Orders:</span>
                <span class="cf-usage-value" id="cfOrdersCount">0</span>
            </div>
        </div>
        <div class="cf-status-badge" id="cfStatusBadge">
            Connected
        </div>
        <button class="cf-delete-all-btn" onclick="deleteAllCloudflareData()">
            üóëÔ∏è Delete All Data
        </button>
    </div>

    <!-- Login Overlay -->
    <div id="loginOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); z-index: 10000; display: flex; align-items: center; justify-content: center;">
        <div style="background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 3rem; width: 100%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
            <div id="loginForm">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 48px; margin-bottom: 1rem;">üñ®Ô∏è</div>
                    <h1 style="font-size: 24px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">3D Print Manager</h1>
                    <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 14px;">Sign in to continue</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Username or Email</label>
                    <input type="text" id="loginUsername" class="form-input" placeholder="Enter your username" onkeypress="if(event.key==='Enter')doLogin()">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" onkeypress="if(event.key==='Enter')doLogin()">
                </div>
                <div id="loginError" style="display: none; color: #ef4444; font-size: 13px; margin-bottom: 1rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px;"></div>
                <button class="btn" onclick="doLogin()" style="width: 100%; padding: 1rem; font-size: 16px;">
                    Sign In
                </button>
            </div>

            <!-- Setup Form (shown only if no users exist) -->
            <div id="setupForm" style="display: none;">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 48px; margin-bottom: 1rem;">üîß</div>
                    <h1 style="font-size: 24px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Initial Setup</h1>
                    <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 14px;">Create your admin account</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="setupUsername" class="form-input" placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="setupEmail" class="form-input" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Display Name</label>
                    <input type="text" id="setupDisplayName" class="form-input" placeholder="Your display name">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="setupPassword" class="form-input" placeholder="Choose a secure password">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" id="setupPasswordConfirm" class="form-input" placeholder="Confirm your password" onkeypress="if(event.key==='Enter')doSetup()">
                </div>
                <div id="setupError" style="display: none; color: #ef4444; font-size: 13px; margin-bottom: 1rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px;"></div>
                <button class="btn" onclick="doSetup()" style="width: 100%; padding: 1rem; font-size: 16px;">
                    Create Admin Account
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav-tabs" id="mainNav" style="display: none;">
        <div class="nav-tab active" onclick="switchTab('dashboard')">Dashboard</div>
        <div class="nav-tab" onclick="switchTab('calculator')">Quote Calculator</div>
        <div class="nav-tab" onclick="switchTab('inquiries')">Inquiries</div>
        <div class="nav-tab" onclick="switchTab('orders')">Orders</div>
        <div class="nav-tab" onclick="switchTab('completed')">Completed Orders</div>
        <div class="nav-tab" onclick="switchTab('ebay-orders')">eBay Orders</div>
        <div class="nav-tab" onclick="switchTab('inventory')">Inventory</div>
        <div class="nav-tab" onclick="switchTab('printers')">Printers</div>
        <div class="nav-tab" id="usersTab" style="display: none;" onclick="switchTab('users')">Users</div>
        <div class="nav-tab" onclick="switchTab('settings')">Settings</div>
        <div style="margin-left: auto; display: flex; align-items: center; gap: 1rem; padding-right: 1rem;">
            <span id="currentUserDisplay" style="font-size: 13px; color: var(--text-secondary);"></span>
            <button onclick="doLogout()" style="background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">Logout</button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard -->
        <div class="page-content active" id="dashboard">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Business Dashboard</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">3D Printing Business Management & Analytics</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" style="padding: 8px 16px;" onclick="exportDashboardReport()">üìä Export Report</button>
                    <button class="btn" style="padding: 8px 16px;" onclick="loadDashboard(); showNotification('Dashboard refreshed', 'success')">üîÑ Refresh Data</button>
                </div>
            </div>

            <!-- Key Performance Indicators -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 3rem;">
                <div class="card" style="padding: 24px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="background: rgba(34, 197, 94, 0.15); padding: 12px; border-radius: 12px;">
                            <span style="font-size: 24px;">üí∞</span>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.1); padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: #22c55e;">+12% ‚Üó</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px; font-weight: 500;">Daily Revenue</div>
                        <div style="font-size: 32px; font-weight: 800; color: var(--text-primary); line-height: 1; margin-bottom: 4px;">$1,482</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">$124 above yesterday</div>
                    </div>
                </div>

                <div class="card" style="padding: 24px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="background: rgba(59, 130, 246, 0.15); padding: 12px; border-radius: 12px;">
                            <span style="font-size: 24px;">üìã</span>
                        </div>
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: #ef4444;">3 urgent</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px; font-weight: 500;">Active Orders</div>
                        <div style="font-size: 32px; font-weight: 800; color: var(--text-primary); line-height: 1; margin-bottom: 4px;">8</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">3 due today, 5 in progress</div>
                    </div>
                </div>

                <div class="card" style="padding: 24px; background: linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(126, 34, 206, 0.05) 100%); border: 1px solid rgba(147, 51, 234, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="background: rgba(147, 51, 234, 0.15); padding: 12px; border-radius: 12px;">
                            <span style="font-size: 24px;">üñ®Ô∏è</span>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.1); padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: #22c55e;">67% capacity</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px; font-weight: 500;">Printer Fleet</div>
                        <div style="font-size: 32px; font-weight: 800; color: var(--text-primary); line-height: 1; margin-bottom: 4px;">4<span style="font-size: 18px; color: var(--text-muted);">/6</span></div>
                        <div style="font-size: 12px; color: var(--text-secondary);">2 available, 4 printing</div>
                    </div>
                </div>

                <div class="card" style="padding: 24px; background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(234, 88, 12, 0.05) 100%); border: 1px solid rgba(251, 146, 60, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="background: rgba(251, 146, 60, 0.15); padding: 12px; border-radius: 12px;">
                            <span style="font-size: 24px;">üì®</span>
                        </div>
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: #ef4444;">2 urgent</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px; font-weight: 500;">Customer Messages</div>
                        <div style="font-size: 32px; font-weight: 800; color: var(--text-primary); line-height: 1; margin-bottom: 4px;">5</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">2 urgent, 3 inquiries</div>
                    </div>
                </div>
            </div>

            <!-- Business Intelligence -->
            <div style="margin-bottom: 3rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div>
                        <h2 style="font-size: 20px; font-weight: 700; margin: 0; color: var(--text-primary);">Business Intelligence</h2>
                        <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Performance metrics and trends analysis</p>
                    </div>
                </div>

                <!-- Revenue Trend -->
                <div class="card" style="margin-bottom: 2rem; padding: 24px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.03) 0%, rgba(16, 185, 129, 0.01) 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">Revenue Performance</h3>
                            <p style="font-size: 13px; color: var(--text-muted); margin: 4px 0 0 0;">Daily revenue over the past 7 days</p>
                        </div>
                        <div style="font-size: 24px; font-weight: 800; color: #22c55e;">$5,551 Total</div>
                    </div>

                    <div style="display: flex; align-items: end; gap: 12px; height: 140px; padding: 20px 0; background: rgba(255, 255, 255, 0.02); border-radius: 12px;">
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="background: linear-gradient(to top, #22c55e 0%, #16a34a 50%); width: 100%; height: 45%; margin-bottom: 12px; border-radius: 6px 6px 0 0; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);"></div>
                            <span style="font-size: 12px; color: var(--text-primary); font-weight: 600;">Mon</span>
                            <span style="font-size: 11px; color: var(--text-muted);">$450</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="background: linear-gradient(to top, #22c55e 0%, #16a34a 50%); width: 100%; height: 68%; margin-bottom: 12px; border-radius: 6px 6px 0 0; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);"></div>
                            <span style="font-size: 12px; color: var(--text-primary); font-weight: 600;">Tue</span>
                            <span style="font-size: 11px; color: var(--text-muted);">$680</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="background: linear-gradient(to top, #22c55e 0%, #16a34a 50%); width: 100%; height: 72%; margin-bottom: 12px; border-radius: 6px 6px 0 0; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);"></div>
                            <span style="font-size: 12px; color: var(--text-primary); font-weight: 600;">Wed</span>
                            <span style="font-size: 11px; color: var(--text-muted);">$720</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="background: linear-gradient(to top, #22c55e 0%, #16a34a 50%); width: 100%; height: 100%; margin-bottom: 12px; border-radius: 6px 6px 0 0; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);"></div>
                            <span style="font-size: 12px; color: var(--text-primary); font-weight: 600;">Sun</span>
                            <span style="font-size: 11px; color: var(--text-muted);">$1,482</span>
                        </div>
                    </div>
                </div>

                <!-- Business Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem;">
                    <div class="card" style="padding: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 1rem;">üßµ Material Usage</h3>
                        <div id="materialUsageChart">
                            <p style="color: var(--text-muted); font-size: 12px; text-align: center;">Loading inventory data...</p>
                        </div>
                    </div>

                    <div class="card" style="padding: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 1rem;">üé® Popular Colors</h3>
                        <div id="popularColorsChart" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                            <p style="color: var(--text-muted); font-size: 12px; text-align: center; grid-column: 1/-1;">Loading color data...</p>
                        </div>
                    </div>

                    <div class="card" style="padding: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 1rem;">üìä Order Status</h3>
                        <div id="orderStatusChart">
                            <p style="color: var(--text-muted); font-size: 12px; text-align: center;">Loading order data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quote Calculator -->
        <div class="page-content" id="calculator">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üí∞ Quote Calculator</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Professional quote estimation for 3D printing projects</p>
                </div>
                <button class="btn" onclick="clearQuoteForm()" style="background: rgba(239, 68, 68, 0.8);">
                    üóëÔ∏è Clear Form
                </button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <!-- Input Section -->
                <div class="card" style="padding: 2rem;">
                    <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 1.5rem; color: var(--text-primary);">Project Details</h2>

                    <!-- File Upload Section -->
                    <div class="form-group">
                        <label class="form-label">Upload 3D Files</label>
                        <div style="border: 2px dashed var(--border-primary); border-radius: 8px; padding: 1.5rem; text-align: center; background: rgba(34, 197, 94, 0.05); transition: border-color 0.3s;">
                            <input type="file" id="fileInput" accept=".stl,.obj,.3mf,.gcode,.zip" multiple style="display: none;" onchange="handleFileUpload(event)">
                            <button class="btn" onclick="document.getElementById('fileInput').click()" style="margin-bottom: 8px;">
                                üìÅ Choose Files
                            </button>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 0;">
                                STL, OBJ, 3MF, GCODE, ZIP files supported
                            </p>
                        </div>

                        <!-- File Display -->
                        <div id="fileDisplay" style="margin-top: 12px; display: none;">
                            <div style="background: var(--bg-elevated); border-radius: 8px; padding: 12px; border: 1px solid var(--border-primary);">
                                <h4 style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">üìÅ Uploaded Files</h4>
                                <div id="fileList" style="display: flex; flex-direction: column; gap: 6px;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Material Weight (grams)</label>
                        <input type="number" id="materialWeight" class="form-input" placeholder="Enter weight in grams" oninput="calculateQuote()" min="0" step="0.1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Print Time (hours)</label>
                        <input type="number" id="printTime" class="form-input" placeholder="Enter print time in hours" oninput="calculateQuote()" min="0" step="0.1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Number of Beds</label>
                        <input type="number" id="numBeds" class="form-input" placeholder="Number of printer beds" oninput="calculateQuote()" min="1" step="1" value="1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Labor Time (minutes)</label>
                        <input type="number" id="laborTime" class="form-input" placeholder="Enter labor time in minutes" oninput="calculateQuote()" min="0" step="1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Shipping Cost ($)</label>
                        <input type="number" id="shippingCost" class="form-input" placeholder="Enter shipping cost" oninput="calculateQuote()" min="0" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Material Type</label>
                        <select id="materialType" class="form-input" onchange="updateMaterialPrice(); updateColorOptions(); calculateQuote()">
                            <option value="PLA">PLA - Standard Quality</option>
                            <option value="PETG">PETG - Chemical Resistant</option>
                            <option value="ABS">ABS - Impact Resistant</option>
                            <option value="TPU">TPU - Flexible</option>
                            <option value="Nylon">Nylon - Strong & Durable</option>
                            <option value="CF-Nylon">Carbon Fiber Nylon - Premium</option>
                            <option value="Wood">Wood Fill - Natural Look</option>
                            <option value="Metal">Metal Fill - Premium</option>
                            <option value="PEEK">PEEK - Industrial Grade</option>
                            <option value="PVA">PVA - Water Soluble Support</option>
                        </select>
                        <div id="materialPriceDisplay" style="margin-top: 6px; font-size: 12px; color: var(--text-muted);">
                            <!-- Material price will be displayed here -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Material Color</label>
                        <select id="materialColor" class="form-input" onchange="updateSpecificMaterialPrice(); calculateQuote()">
                            <option value="">Select a color...</option>
                        </select>
                        <div id="colorStockDisplay" style="margin-top: 6px; font-size: 12px; color: var(--text-muted);">
                            <!-- Color stock info will be displayed here -->
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-secondary);">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Customer Information</h3>

                        <div class="form-group">
                            <label class="form-label">Customer Name</label>
                            <input type="text" id="customerName" class="form-input" placeholder="Enter customer name">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Customer Email</label>
                            <input type="email" id="customerEmail" class="form-input" placeholder="Enter customer email">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Project Description</label>
                            <textarea id="projectDescription" class="form-input" placeholder="Brief description of the project" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Quote Display Section -->
                <div class="card" style="padding: 2rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 1.5rem; color: var(--text-primary);">Quote Breakdown</h2>

                    <!-- Total Quote Display -->
                    <div style="text-align: center; margin-bottom: 2rem; padding: 1.5rem; background: rgba(34, 197, 94, 0.1); border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3);">
                        <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 500;">TOTAL QUOTE</div>
                        <div id="totalQuote" style="font-size: 48px; font-weight: 800; color: #22c55e; line-height: 1;">$0.00</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 0.5rem;">Includes all fees and taxes</div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Cost Breakdown</h3>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 14px; color: var(--text-secondary);">
                                Material Cost:
                                <span id="materialSourceIndicator" style="font-size: 11px; color: var(--text-muted);"></span>
                            </span>
                            <span id="materialCost" style="font-size: 14px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center;">$0.00</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 14px; color: var(--text-secondary);">Printer Time:</span>
                            <span id="printerCost" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">$0.00</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 14px; color: var(--text-secondary);">Labor Cost:</span>
                            <span id="laborCost" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">$0.00</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 14px; color: var(--text-secondary);">Multi-day Fee:</span>
                            <span id="multidayCost" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">$0.00</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 14px; color: var(--text-secondary);">Additional Beds:</span>
                            <span id="bedCost" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">$0.00</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 14px; color: var(--text-secondary);">Shipping:</span>
                            <span id="displayShippingCost" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">$0.00</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-top: 2px solid rgba(34, 197, 94, 0.3); margin-top: 1rem;">
                            <span style="font-size: 14px; color: var(--text-secondary); font-weight: 600;">Subtotal:</span>
                            <span id="subtotal" style="font-size: 14px; font-weight: 700; color: var(--text-primary);">$0.00</span>
                        </div>
                    </div>

                    <!-- Project Summary -->
                    <div style="margin-bottom: 2rem; padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 8px;">
                        <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">Project Summary</h3>
                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">
                            <div id="summaryWeight">Weight: - grams</div>
                            <div id="summaryTime">Print Time: - hours</div>
                            <div id="summaryMaterial">Material: -</div>
                            <div id="summaryBeds">Beds Required: -</div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn" onclick="quoteCalculator.saveAsInquiry()" style="flex: 1;">
                            üíæ Save to Inquiries
                        </button>
                        <button class="btn btn-secondary" onclick="quoteCalculator.exportQuote()" style="flex: 1;">
                            üìÑ Export Quote
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inquiries -->
        <div class="page-content" id="inquiries">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üìã Customer Inquiries</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Manage customer quotes and project inquiries</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <select id="inquiryFilter" class="form-input" style="width: auto; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border-secondary);" onchange="filterInquiries()">
                        <option value="">Active Inquiries</option>
                        <option value="pending">Pending Only</option>
                        <option value="purchased">Converted to Orders</option>
                        <option value="declined">Declined Only</option>
                    </select>
                    <button class="btn btn-secondary" onclick="refreshInquiries()" style="padding: 8px 16px;">üîÑ Refresh</button>
                </div>
            </div>

            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="overflow-x: auto;">
                    <table id="inquiriesTable" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead style="background: rgba(255, 255, 255, 0.05); position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); width: 80px;">Date</th>
                                <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); width: 120px;">Customer</th>
                                <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); width: 150px;">Email</th>
                                <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); width: 150px;">Description</th>
                                <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); width: 70px;">File</th>
                                <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); width: 60px;">Material</th>
                                <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); width: 50px;">Weight</th>
                                <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); width: 40px;">Time</th>
                                <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); width: 70px;">Quote</th>
                                <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); width: 70px;">Status</th>
                                <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); width: 80px;">Created By</th>
                                <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); width: 200px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inquiriesTableBody" style="background: var(--bg-card);">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="emptyInquiriesState" style="display: none; text-align: center; padding: 4rem 2rem; color: var(--text-muted);">
                    <div style="font-size: 48px; margin-bottom: 1rem; opacity: 0.5;">üìã</div>
                    <h3 style="font-size: 18px; margin-bottom: 0.5rem; color: var(--text-secondary);">No Inquiries Found</h3>
                    <p style="font-size: 14px;">Customer inquiries will appear here when created from the Quote Calculator.</p>
                </div>
            </div>
        </div>

        <!-- Orders -->
        <div class="page-content" id="orders">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üì¶ Order Management</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Track and manage your 3D printing orders</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <select id="orderFilter" class="form-input" style="width: auto; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border-secondary);" onchange="filterOrders()">
                        <option value="">All Active Orders</option>
                        <option value="ready">Ready</option>
                        <option value="pending">Pending</option>
                        <option value="printing">Printing</option>
                    </select>
                    <button class="btn btn-secondary" onclick="syncFromInquiries()" style="padding: 8px 16px;">üîÑ Sync from Inquiries</button>
                    <button class="btn" onclick="showAddOrderModal()" style="padding: 8px 16px;">+ Add Order</button>
                </div>
            </div>

            <!-- Order Queue Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 2rem;">
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚è≥</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="pendingOrdersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Pending Orders</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(234, 88, 12, 0.05) 100%); border: 1px solid rgba(251, 146, 60, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">üñ®Ô∏è</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="printingOrdersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Currently Printing</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚úÖ</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="completedOrdersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Completed Orders</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(126, 34, 206, 0.05) 100%); border: 1px solid rgba(147, 51, 234, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">üì¶</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="shippedOrdersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Shipped Orders</div>
                </div>
            </div>

            <!-- Printer Status Panel -->
            <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">üñ®Ô∏è Printer Fleet Status</h3>
                <div id="printerStatusGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                    <!-- Printer status cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Orders Table -->
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="overflow-x: auto;">
                    <table id="ordersTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead style="background: rgba(255, 255, 255, 0.05); position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 80px;">Order ID</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 140px;">Customer</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 150px;">Product</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 120px;">Material</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 70px;">Files</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 100px;">Due Date</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 80px;">Value</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 100px;">Printer</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 90px;">Status</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 90px;">Processed By</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 180px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="emptyOrdersState" style="display: none; text-align: center; padding: 4rem 2rem; color: var(--text-muted);">
                    <div style="font-size: 48px; margin-bottom: 1rem; opacity: 0.5;">üì¶</div>
                    <h3 style="font-size: 18px; margin-bottom: 0.5rem; color: var(--text-secondary);">No Orders Found</h3>
                    <p style="font-size: 14px;">Orders will appear here when synced from inquiries or added manually.</p>
                </div>
            </div>
        </div>

        <!-- Completed Orders -->
        <div class="page-content" id="completed">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üí∞ Completed Orders</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Financial tracking and completed order history</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <select id="completedTimeFilter" class="form-input" style="width: auto; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border-secondary);" onchange="filterCompletedOrders()">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                    <button class="btn btn-secondary" onclick="exportCompletedOrders()" style="padding: 8px 16px;">üìä Export Report</button>
                    <button class="btn" onclick="generateInvoices()" style="padding: 8px 16px;">üìÑ Generate Invoices</button>
                </div>
            </div>

            <!-- Financial Summary -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 2rem;">
                <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Total Revenue</div>
                            <div style="font-size: 28px; font-weight: 700; color: #22c55e;" id="totalRevenue">$0.00</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">All completed orders</div>
                        </div>
                        <div style="font-size: 32px;">üíµ</div>
                    </div>
                </div>
                <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Average Order Value</div>
                            <div style="font-size: 28px; font-weight: 700; color: #3b82f6;" id="averageOrderValue">$0.00</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Per order average</div>
                        </div>
                        <div style="font-size: 32px;">üìä</div>
                    </div>
                </div>
                <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(126, 34, 206, 0.05) 100%); border: 1px solid rgba(147, 51, 234, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Total Orders</div>
                            <div style="font-size: 28px; font-weight: 700; color: #8b5cf6;" id="totalCompletedOrders">0</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Completed & shipped</div>
                        </div>
                        <div style="font-size: 32px;">üì¶</div>
                    </div>
                </div>
                <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(234, 88, 12, 0.05) 100%); border: 1px solid rgba(251, 146, 60, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Print Hours</div>
                            <div style="font-size: 28px; font-weight: 700; color: #f59e0b;" id="totalPrintHours">0h</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Total machine time</div>
                        </div>
                        <div style="font-size: 32px;">‚è±Ô∏è</div>
                    </div>
                </div>
            </div>

            <!-- Monthly Revenue Chart -->
            <div class="card" style="margin-bottom: 2rem; padding: 24px;">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 1.5rem; color: var(--text-primary);">üìà Revenue Trend</h3>
                <div id="revenueChart" style="height: 200px; display: flex; align-items: flex-end; gap: 8px;">
                    <!-- Dynamic chart will be inserted here -->
                </div>
            </div>

            <!-- Completed Orders Table -->
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="padding: 16px; border-bottom: 1px solid var(--border-secondary); background: rgba(255, 255, 255, 0.02);">
                    <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">üìã Order History</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead style="background: rgba(255, 255, 255, 0.05);">
                            <tr>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Order ID</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Date Completed</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Customer</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Product</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Revenue</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Print Time</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Status</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="completedOrdersTableBody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="emptyCompletedOrdersState" style="display: none; text-align: center; padding: 4rem 2rem; color: var(--text-muted);">
                    <div style="font-size: 48px; margin-bottom: 1rem; opacity: 0.5;">üì≠</div>
                    <h3 style="font-size: 18px; margin-bottom: 0.5rem; color: var(--text-secondary);">No Completed Orders Yet</h3>
                    <p style="font-size: 14px;">Completed and shipped orders will appear here for tracking.</p>
                </div>
            </div>
        </div>

        <!-- eBay Orders -->
        <div class="page-content" id="ebay-orders">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üõí eBay Orders</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Manage and fulfill your eBay orders</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="syncEbayOrders()" style="padding: 8px 16px;" id="syncEbayBtn">üîÑ Sync from eBay</button>
                    <button class="btn" onclick="loadEbayOrders()" style="padding: 8px 16px;">üîÉ Refresh</button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 2rem;">
                <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%); border: 1px solid rgba(239, 68, 68, 0.2);">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">‚è∞ Urgent</div>
                    <div style="font-size: 28px; font-weight: 700; color: #ef4444;" id="ebayUrgentCount">0</div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Ship within 24h</div>
                </div>
                <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(234, 88, 12, 0.05) 100%); border: 1px solid rgba(251, 146, 60, 0.2);">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">üì¶ Pending</div>
                    <div style="font-size: 28px; font-weight: 700; color: #f59e0b;" id="ebayPendingCount">0</div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Awaiting fulfillment</div>
                </div>
                <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">‚úÖ Shipped</div>
                    <div style="font-size: 28px; font-weight: 700; color: #22c55e;" id="ebayShippedCount">0</div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">This week</div>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="padding: 16px; border-bottom: 1px solid var(--border-secondary); background: rgba(255, 255, 255, 0.02);">
                    <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">üìã Order List</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead style="background: rgba(255, 255, 255, 0.05);">
                            <tr>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Order ID</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Buyer</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Item</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Ship To</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Ship By</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Total</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Tracking</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Status</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary);">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ebayOrdersTableBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="emptyEbayOrdersState" style="display: none; text-align: center; padding: 4rem 2rem; color: var(--text-muted);">
                    <div style="font-size: 48px; margin-bottom: 1rem; opacity: 0.5;">üì≠</div>
                    <h3 style="font-size: 18px; margin-bottom: 0.5rem; color: var(--text-secondary);">No eBay Orders</h3>
                    <p style="font-size: 14px;">Click "Sync from eBay" to fetch your latest orders.</p>
                </div>
            </div>
        </div>

        <!-- Inventory -->
        <div class="page-content" id="inventory">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üè¶ Material Inventory</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Track your 3D printing material stock and usage</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="generateInventoryReport()" style="padding: 8px 16px;">üìà Generate Report</button>
                    <button class="btn" onclick="showAddMaterialModal()" style="padding: 8px 16px;">+ Add Material</button>
                </div>
            </div>

            <!-- Inventory Overview -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 2rem;">
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">üì¶</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="totalMaterialsCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Total Materials</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%); border: 1px solid rgba(239, 68, 68, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚ö†Ô∏è</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="lowStockCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Low Stock Items</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">üìä</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="totalInventoryValue">$0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Total Inventory Value</div>
                </div>
            </div>

            <!-- Low Stock Alerts -->
            <div id="lowStockAlerts" style="margin-bottom: 2rem; display: none;">
                <div class="card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%); border: 1px solid rgba(239, 68, 68, 0.2);">
                    <h3 style="color: #ef4444; margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        ‚ö†Ô∏è Low Stock Alerts
                    </h3>
                    <div id="lowStockList"></div>
                </div>
            </div>

            <!-- Material Categories -->
            <div id="inventoryGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                <!-- PLA Materials -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #22c55e; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <span style="background: rgba(34, 197, 94, 0.1); padding: 6px; border-radius: 6px; font-size: 14px;">üåø</span>
                            PLA Materials
                        </h3>
                        <button onclick="addMaterialToCategory('PLA')" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Add PLA</button>
                    </div>
                    <div id="plaMaterials"></div>
                </div>

                <!-- PETG Materials -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #3b82f6; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <span style="background: rgba(59, 130, 246, 0.1); padding: 6px; border-radius: 6px; font-size: 14px;">üß™</span>
                            PETG Materials
                        </h3>
                        <button onclick="addMaterialToCategory('PETG')" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Add PETG</button>
                    </div>
                    <div id="petgMaterials"></div>
                </div>

                <!-- ABS Materials -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #f59e0b; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <span style="background: rgba(245, 158, 11, 0.1); padding: 6px; border-radius: 6px; font-size: 14px;">üî•</span>
                            ABS Materials
                        </h3>
                        <button onclick="addMaterialToCategory('ABS')" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Add ABS</button>
                    </div>
                    <div id="absMaterials"></div>
                </div>

                <!-- TPU Materials -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #8b5cf6; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <span style="background: rgba(139, 92, 246, 0.1); padding: 6px; border-radius: 6px; font-size: 14px;">ü§∏</span>
                            TPU Materials
                        </h3>
                        <button onclick="addMaterialToCategory('TPU')" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.3); padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Add TPU</button>
                    </div>
                    <div id="tpuMaterials"></div>
                </div>

                <!-- Specialty Materials -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #6b7280; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <span style="background: rgba(107, 114, 128, 0.1); padding: 6px; border-radius: 6px; font-size: 14px;">‚ú®</span>
                            Specialty Materials
                        </h3>
                        <button onclick="addMaterialToCategory('Specialty')" style="background: rgba(107, 114, 128, 0.1); color: #6b7280; border: 1px solid rgba(107, 114, 128, 0.3); padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Add Special</button>
                    </div>
                    <div id="specialtyMaterials"></div>
                </div>
            </div>
        </div>

        <!-- Printers -->
        <div class="page-content" id="printers">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üñ®Ô∏è Printer Fleet</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Monitor and manage your 3D printer fleet</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="refreshPrinterStatus()" style="padding: 8px 16px;">üîÑ Refresh All</button>
                    <button class="btn" onclick="showAddPrinterModal()" style="padding: 8px 16px;">+ Add Printer</button>
                </div>
            </div>

            <!-- Fleet Overview -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 2rem;">
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚úÖ</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="onlinePrintersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Online</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(234, 88, 12, 0.05) 100%); border: 1px solid rgba(251, 146, 60, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">üñ®Ô∏è</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="printingCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Printing</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚è∏Ô∏è</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="idlePrintersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Idle</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%); border: 1px solid rgba(239, 68, 68, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚ö†Ô∏è</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="errorPrintersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Errors</div>
                </div>
            </div>

            <!-- Printer Grid -->
            <div id="printerGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 24px;">
                <!-- Printer cards will be dynamically generated here -->
            </div>

            <!-- Empty State -->
            <div id="emptyPrintersState" style="display: none; text-align: center; padding: 4rem 2rem; color: var(--text-muted);">
                <div style="font-size: 48px; margin-bottom: 1rem; opacity: 0.5;">üñ®Ô∏è</div>
                <h3 style="font-size: 18px; margin-bottom: 0.5rem; color: var(--text-secondary);">No Printers Found</h3>
                <p style="font-size: 14px;">Add your first 3D printer to start monitoring your fleet.</p>
                <button class="btn" onclick="showAddPrinterModal()" style="margin-top: 16px;">+ Add Your First Printer</button>
            </div>
        </div>

        <!-- Users Management (Admin Only) -->
        <div class="page-content" id="users">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üë• User Management</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Manage team members and access permissions</p>
                </div>
                <button class="btn" onclick="showAddUserModal()">+ Add User</button>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
                <!-- Users List -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">Team Members</h3>
                    <div id="usersList" style="display: flex; flex-direction: column; gap: 12px;">
                        <p style="color: var(--text-muted);">Loading users...</p>
                    </div>
                </div>

                <!-- Activity Log -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">Recent Activity</h3>
                    <div id="activityLog" style="display: flex; flex-direction: column; gap: 8px; max-height: 500px; overflow-y: auto;">
                        <p style="color: var(--text-muted);">Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add User Modal -->
        <div id="addUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10001; align-items: center; justify-content: center;">
            <div style="background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 2rem; width: 100%; max-width: 450px;">
                <h2 style="margin-bottom: 1.5rem;">Add New User</h2>
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="newUserUsername" class="form-input" placeholder="username">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="newUserEmail" class="form-input" placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Display Name</label>
                    <input type="text" id="newUserDisplayName" class="form-input" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="newUserPassword" class="form-input" placeholder="Secure password">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select id="newUserRole" class="form-input">
                        <option value="staff">Staff</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div id="addUserError" style="display: none; color: #ef4444; font-size: 13px; margin-bottom: 1rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px;"></div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeAddUserModal()">Cancel</button>
                    <button class="btn" onclick="createNewUser()">Create User</button>
                </div>
            </div>
        </div>

        <!-- Edit User Modal -->
        <div id="editUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10001; align-items: center; justify-content: center;">
            <div style="background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 2rem; width: 100%; max-width: 450px;">
                <h2 style="margin-bottom: 1.5rem;">Edit User</h2>
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label class="form-label">Display Name</label>
                    <input type="text" id="editUserDisplayName" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select id="editUserRole" class="form-input">
                        <option value="staff">Staff</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">New Password (leave blank to keep current)</label>
                    <input type="password" id="editUserPassword" class="form-input" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="editUserActive" class="form-input">
                        <option value="1">Active</option>
                        <option value="0">Inactive</option>
                    </select>
                </div>
                <div id="editUserError" style="display: none; color: #ef4444; font-size: 13px; margin-bottom: 1rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px;"></div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeEditUserModal()">Cancel</button>
                    <button class="btn" onclick="saveUserEdit()">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div class="page-content" id="settings">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">‚öôÔ∏è Application Settings</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Configure your 3D printing business management system</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="exportSettings()" style="padding: 8px 16px;">üíæ Export Settings</button>
                    <button class="btn btn-secondary" onclick="importSettings()" style="padding: 8px 16px;">üìÅ Import Settings</button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <!-- Business Information -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        üè¢ Business Information
                    </h3>
                    <div class="form-group">
                        <label class="form-label">Company Name</label>
                        <input type="text" id="companyName" class="form-input" placeholder="Your 3D Printing Business" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Email</label>
                        <input type="email" id="contactEmail" class="form-input" placeholder="contact@yourbusiness.com" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="text" id="phoneNumber" class="form-input" placeholder="+1 (555) 123-4567" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Business Address</label>
                        <textarea id="businessAddress" class="form-input" rows="3" placeholder="Your business address..." onchange="saveSettings()"></textarea>
                    </div>
                </div>

                <!-- Application Preferences -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        üéØ Application Preferences
                    </h3>
                    <div class="form-group">
                        <label class="form-label">Default Material Cost ($/kg)</label>
                        <input type="number" id="defaultMaterialCost" class="form-input" value="15" step="0.01" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Labor Rate ($/hour)</label>
                        <input type="number" id="laborRate" class="form-input" value="60" step="0.01" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Printer Time Rate ($/hour)</label>
                        <input type="number" id="printerRate" class="form-input" value="0.56" step="0.01" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select id="currency" class="form-input" onchange="saveSettings()">
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (‚Ç¨)</option>
                            <option value="GBP">GBP (¬£)</option>
                            <option value="CAD">CAD (C$)</option>
                        </select>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        üîî Notification Settings
                    </h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="orderNotifications" onchange="saveSettings()" style="accent-color: var(--accent-primary);">
                            <span>New order notifications</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="printerNotifications" onchange="saveSettings()" style="accent-color: var(--accent-primary);">
                            <span>Printer status notifications</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="lowStockNotifications" onchange="saveSettings()" style="accent-color: var(--accent-primary);">
                            <span>Low stock alerts</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="dueDateNotifications" onchange="saveSettings()" style="accent-color: var(--accent-primary);">
                            <span>Due date reminders</span>
                        </label>
                    </div>
                </div>

                <!-- Folder Settings -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        üìÅ Folder Settings
                    </h3>
                    <div class="form-group">
                        <label class="form-label">STL Files Folder</label>
                        <input type="text" id="stlFolder" class="form-input" placeholder="/path/to/stl/files" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Exports Folder</label>
                        <input type="text" id="exportsFolder" class="form-input" placeholder="/path/to/exports" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Backup Folder</label>
                        <input type="text" id="backupFolder" class="form-input" placeholder="/path/to/backups" onchange="saveSettings()">
                    </div>
                </div>
            </div>

            <!-- Cloudflare Sync Section -->
            <div class="card" style="margin-top: 24px;">
                <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                    ‚òÅÔ∏è Cloudflare Sync
                </h3>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">Cloud storage with 10GB FREE for multi-computer sync.</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Database Status</label>
                        <input type="text" class="form-input" id="cfDatabaseStatus" value="D1 Connected ‚úÖ" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Storage Status</label>
                        <input type="text" class="form-input" id="cfStorageStatus" value="R2 Active (10GB Free)" readonly>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn" onclick="checkCloudflareStatus()">
                        üîç Check Status
                    </button>

                    <div id="cloudflareConnected" style="margin-top: 1rem; padding: 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h4 style="margin: 0; color: #22c55e;">‚úÖ Cloudflare Connected</h4>
                            <span class="badge" style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">Active</span>
                        </div>
                        <p style="font-size: 12px; color: var(--text-muted); margin: 4px 0;">
                            All data syncing to Cloudflare D1 & R2 Storage
                        </p>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button class="btn btn-secondary" onclick="forceSyncNow()" style="padding: 4px 8px; font-size: 12px;">üîÑ Sync Now</button>
                            <button class="btn btn-secondary" onclick="viewCloudflareStats()" style="padding: 4px 8px; font-size: 12px;">üìä View Stats</button>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="testCloudConnection()">
                        üîç Test Connection
                    </button>
                </div>
            </div>

            <!-- Data Management -->
            <div class="card" style="margin-top: 24px;">
                <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                    üìÑ Data Management
                </h3>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">Manage your application data and backups.</p>

                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="createBackup()">
                        üíæ Create Backup
                    </button>
                    <button class="btn btn-secondary" onclick="restoreBackup()">
                        üìÅ Restore Backup
                    </button>
                    <button class="btn" onclick="resetAllData()" style="background: #ef4444;">
                        üóëÔ∏è Reset All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Inquiry Modal -->
    <div id="editInquiryModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; backdrop-filter: blur(4px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 2rem; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 20px; font-weight: 700; margin: 0; color: var(--text-primary);">Edit Inquiry</h2>
                <button onclick="closeEditModal()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">√ó</button>
            </div>

            <form id="editInquiryForm">
                <input type="hidden" id="editInquiryId">

                <div class="form-group">
                    <label class="form-label">Customer Name</label>
                    <input type="text" id="editCustomerName" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Customer Email</label>
                    <input type="email" id="editCustomerEmail" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Project Description</label>
                    <textarea id="editProjectDescription" class="form-input" rows="3"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Material Weight (g)</label>
                        <input type="number" id="editMaterialWeight" class="form-input" step="0.1" min="0" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Print Time (h)</label>
                        <input type="number" id="editPrintTime" class="form-input" step="0.1" min="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Material Type</label>
                    <select id="editMaterialType" class="form-input">
                        <option value="PLA">PLA - Standard Quality</option>
                        <option value="PETG">PETG - Chemical Resistant</option>
                        <option value="ABS">ABS - Impact Resistant</option>
                        <option value="TPU">TPU - Flexible</option>
                        <option value="Wood">Wood Fill - Natural Look</option>
                        <option value="Metal">Metal Fill - Premium</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="editInquiryStatus" class="form-input">
                        <option value="pending">Pending</option>
                        <option value="purchased">Purchased</option>
                        <option value="declined">Declined</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Total Quote ($)</label>
                    <input type="number" id="editTotalQuote" class="form-input" step="0.01" min="0" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Files</label>
                    <div id="editCurrentFiles" style="margin-bottom: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-primary);">
                        <div style="color: var(--text-muted); font-size: 12px;">Current files will be shown here</div>
                    </div>
                    <div style="border: 2px dashed var(--border-primary); border-radius: 8px; padding: 1.5rem; text-align: center; background: rgba(34, 197, 94, 0.05); transition: border-color 0.3s;">
                        <input type="file" id="editFileInput" accept=".stl,.obj,.3mf,.gcode,.zip" multiple style="display: none;" onchange="handleEditFileUpload(event)">
                        <button type="button" class="btn" onclick="document.getElementById('editFileInput').click()" style="margin-bottom: 8px;">
                            üìÅ Choose Files
                        </button>
                        <p style="font-size: 12px; color: var(--text-muted); margin: 0;">
                            STL, OBJ, 3MF, GCODE, ZIP files supported
                        </p>
                    </div>
                    <div id="editFileDisplay" style="margin-top: 12px; display: none;"></div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="saveInquiryEdit()" style="flex: 1;">üíæ Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()" style="flex: 1;">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10001; backdrop-filter: blur(4px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 2rem; width: 90%; max-width: 400px;">
            <div style="text-align: center;">
                <div style="font-size: 48px; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);" id="confirmTitle">Confirm Action</h3>
                <p style="color: var(--text-secondary); margin-bottom: 2rem; line-height: 1.5;" id="confirmMessage">Are you sure you want to proceed?</p>

                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="closeConfirmModal()" style="flex: 1;">Cancel</button>
                    <button class="btn" onclick="confirmAction()" style="flex: 1; background: #ef4444;" id="confirmButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Order Modal -->
    <div id="addOrderModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; backdrop-filter: blur(4px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 2rem; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 20px; font-weight: 700; margin: 0; color: var(--text-primary);">Add New Order</h2>
                <button onclick="closeAddOrderModal()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">√ó</button>
            </div>

            <form id="addOrderForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Customer Name</label>
                        <input type="text" id="newOrderCustomer" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer Email</label>
                        <input type="email" id="newOrderEmail" class="form-input" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Product/Description</label>
                    <input type="text" id="newOrderProduct" class="form-input" placeholder="Product name or description" required>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Order Value ($)</label>
                        <input type="number" id="newOrderValue" class="form-input" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" id="newOrderDueDate" class="form-input" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Assign to Printer (Optional)</label>
                    <select id="newOrderPrinter" class="form-input">
                        <option value="">No printer assigned</option>
                    </select>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="saveNewOrder()" style="flex: 1;">üíæ Save Order</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddOrderModal()" style="flex: 1;">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Material Modal -->
    <div id="addMaterialModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; backdrop-filter: blur(4px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 2rem; width: 90%; max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 20px; font-weight: 700; margin: 0; color: var(--text-primary);">Add Material</h2>
                <button onclick="closeAddMaterialModal()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">√ó</button>
            </div>

            <form id="addMaterialForm">
                <div class="form-group">
                    <label class="form-label">Material Type</label>
                    <select id="newMaterialType" class="form-input" required>
                        <option value="PLA">PLA - Standard</option>
                        <option value="PETG">PETG - Chemical Resistant</option>
                        <option value="ABS">ABS - Impact Resistant</option>
                        <option value="TPU">TPU - Flexible</option>
                        <option value="Nylon">Nylon - Strong & Durable</option>
                        <option value="CF-Nylon">Carbon Fiber Nylon</option>
                        <option value="PEEK">PEEK - Industrial Grade</option>
                        <option value="PVA">PVA - Water Soluble</option>
                        <option value="HIPS">HIPS - Support Material</option>
                        <option value="Wood">Wood Fill</option>
                        <option value="Metal">Metal Fill</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Color</label>
                    <input type="text" id="newMaterialColor" class="form-input" placeholder="e.g., Black, White, Red" required>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" id="newMaterialWeight" class="form-input" step="0.1" min="0" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cost per kg ($)</label>
                        <input type="number" id="newMaterialCost" class="form-input" step="0.01" min="0" value="15" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Supplier (Optional)</label>
                    <input type="text" id="newMaterialSupplier" class="form-input" placeholder="e.g., Prusament, Amazon, Local Store">
                </div>

                <div style="display: flex; gap: 12px; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="saveNewMaterial()" style="flex: 1;">üíæ Add Material</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddMaterialModal()" style="flex: 1;">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Printer Modal -->
    <div id="addPrinterModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; backdrop-filter: blur(4px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 2rem; width: 90%; max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 20px; font-weight: 700; margin: 0; color: var(--text-primary);">Add Printer</h2>
                <button onclick="closeAddPrinterModal()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">√ó</button>
            </div>

            <form id="addPrinterForm">
                <div class="form-group">
                    <label class="form-label">Printer Name</label>
                    <input type="text" id="newPrinterName" class="form-input" placeholder="e.g., Bambu X1C #1" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Printer Model</label>
                    <select id="newPrinterModel" class="form-input" required>
                        <option value="Bambu X1C">Bambu X1C</option>
                        <option value="Bambu P1S">Bambu P1S</option>
                        <option value="Bambu A1">Bambu A1</option>
                        <option value="Prusa MK4">Prusa MK4</option>
                        <option value="Ender 3">Ender 3</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">IP Address (Optional)</label>
                        <input type="text" id="newPrinterIP" class="form-input" placeholder="192.168.1.100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="newPrinterStatus" class="form-input">
                            <option value="idle">Idle</option>
                            <option value="printing">Printing</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="saveNewPrinter()" style="flex: 1;">üíæ Add Printer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddPrinterModal()" style="flex: 1;">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==================== AUTHENTICATION SYSTEM ====================

        // Auth state
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');

        // Helper to make authenticated fetch requests
        async function authFetch(url, options = {}) {
            const headers = options.headers || {};
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            return fetch(url, { ...options, headers });
        }

        // Check authentication status on page load
        async function checkAuth() {
            const cloudflareUrl = getCloudflareUrl();

            // First check if setup is needed (no users exist)
            try {
                const response = await fetch(`${cloudflareUrl}/api/auth/me`, {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showApp();
                    return;
                }
            } catch (e) {
                console.log('Auth check failed, showing login');
            }

            // Show login screen
            showLogin();
        }

        // Check if initial setup is needed
        async function checkSetupNeeded() {
            const cloudflareUrl = getCloudflareUrl();
            try {
                // Try to get users (will fail if no users or not admin)
                const response = await fetch(`${cloudflareUrl}/api/auth/me`);
                if (response.status === 401) {
                    // No valid session - could be setup needed or just need to login
                    // We can't tell from /me, so show login by default
                    return false;
                }
            } catch (e) {
                // Network error - might need setup, show setup form
                return true;
            }
            return false;
        }

        function showLogin() {
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainNav').style.display = 'none';
            document.getElementById('cloudflareUsageBar').style.display = 'none';
            document.querySelector('.main-content').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('setupForm').style.display = 'none';
        }

        function showSetup() {
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainNav').style.display = 'none';
            document.getElementById('cloudflareUsageBar').style.display = 'none';
            document.querySelector('.main-content').style.display = 'none';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('setupForm').style.display = 'block';
        }

        function showApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainNav').style.display = 'flex';
            document.getElementById('cloudflareUsageBar').style.display = 'flex';
            document.querySelector('.main-content').style.display = 'block';

            // Update user display
            if (currentUser) {
                document.getElementById('currentUserDisplay').innerHTML = `
                    <span style="color: var(--text-primary); font-weight: 500;">${currentUser.displayName || currentUser.username}</span>
                    <span style="background: ${currentUser.role === 'admin' ? 'rgba(147, 51, 234, 0.2)' : 'rgba(59, 130, 246, 0.2)'};
                           color: ${currentUser.role === 'admin' ? '#a855f7' : '#3b82f6'};
                           padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">
                        ${currentUser.role}
                    </span>
                `;

                // Show users tab for admins
                if (currentUser.role === 'admin') {
                    document.getElementById('usersTab').style.display = 'block';
                }
            }
        }

        async function doLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            if (!username || !password) {
                errorEl.textContent = 'Please enter username and password';
                errorEl.style.display = 'block';
                return;
            }

            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await fetch(`${cloudflareUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    // Check if we need setup (no users exist) by trying the setup endpoint
                    const setupCheck = await fetch(`${cloudflareUrl}/api/auth/setup`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: '_check_', email: '_check_@test.com', password: '_check_' })
                    });
                    const setupData = await setupCheck.json();

                    // If setup says "already completed", users exist - show login error
                    // If setup would work (or different error), show setup screen
                    if (setupData.error && setupData.error.includes('Setup already completed')) {
                        errorEl.textContent = data.error || 'Invalid credentials';
                        errorEl.style.display = 'block';
                    } else {
                        // No users exist yet, show setup
                        showSetup();
                    }
                    return;
                }

                // Success
                authToken = data.token;
                currentUser = data.user;
                localStorage.setItem('authToken', authToken);
                errorEl.style.display = 'none';
                showApp();
                showNotification(`Welcome back, ${currentUser.displayName || currentUser.username}!`, 'success');
            } catch (e) {
                console.error('Login error:', e);
                // Might need setup if no users exist
                showSetup();
            }
        }

        async function doSetup() {
            const username = document.getElementById('setupUsername').value;
            const email = document.getElementById('setupEmail').value;
            const displayName = document.getElementById('setupDisplayName').value;
            const password = document.getElementById('setupPassword').value;
            const passwordConfirm = document.getElementById('setupPasswordConfirm').value;
            const errorEl = document.getElementById('setupError');

            if (!username || !email || !password) {
                errorEl.textContent = 'Username, email, and password are required';
                errorEl.style.display = 'block';
                return;
            }

            if (password !== passwordConfirm) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.style.display = 'block';
                return;
            }

            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters';
                errorEl.style.display = 'block';
                return;
            }

            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await fetch(`${cloudflareUrl}/api/auth/setup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password, displayName })
                });

                const data = await response.json();

                if (!response.ok) {
                    errorEl.textContent = data.error || 'Setup failed';
                    errorEl.style.display = 'block';
                    return;
                }

                // Success
                authToken = data.token;
                currentUser = data.user;
                localStorage.setItem('authToken', authToken);
                errorEl.style.display = 'none';
                showApp();
                showNotification('Admin account created successfully! Welcome to 3D Print Manager.', 'success');
            } catch (e) {
                errorEl.textContent = 'Setup failed: ' + e.message;
                errorEl.style.display = 'block';
            }
        }

        async function doLogout() {
            try {
                const cloudflareUrl = getCloudflareUrl();
                await authFetch(`${cloudflareUrl}/api/auth/logout`, { method: 'POST' });
            } catch (e) {
                console.error('Logout error:', e);
            }

            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            showLogin();
            showNotification('You have been logged out', 'info');
        }

        // ==================== USER MANAGEMENT ====================

        async function loadUsers() {
            if (!currentUser || currentUser.role !== 'admin') return;

            const cloudflareUrl = getCloudflareUrl();
            try {
                const response = await authFetch(`${cloudflareUrl}/api/users`);
                if (!response.ok) {
                    console.error('Failed to load users');
                    return;
                }

                const data = await response.json();
                renderUsersList(data.users || []);
            } catch (e) {
                console.error('Error loading users:', e);
            }
        }

        function renderUsersList(users) {
            const container = document.getElementById('usersList');

            if (users.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">No users found.</p>';
                return;
            }

            container.innerHTML = users.map(user => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; border: 1px solid var(--border-primary);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: ${user.role === 'admin' ? 'rgba(147, 51, 234, 0.2)' : 'rgba(59, 130, 246, 0.2)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: ${user.role === 'admin' ? '#a855f7' : '#3b82f6'};">
                            ${(user.display_name || user.username).charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${user.display_name || user.username}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">@${user.username} ¬∑ ${user.email}</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: ${user.role === 'admin' ? 'rgba(147, 51, 234, 0.2)' : 'rgba(59, 130, 246, 0.2)'};
                               color: ${user.role === 'admin' ? '#a855f7' : '#3b82f6'};
                               padding: 4px 10px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">
                            ${user.role}
                        </span>
                        <span style="background: ${user.is_active ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
                               color: ${user.is_active ? '#22c55e' : '#ef4444'};
                               padding: 4px 10px; border-radius: 4px; font-size: 11px;">
                            ${user.is_active ? 'Active' : 'Inactive'}
                        </span>
                        ${user.id !== currentUser.id ? `
                            <button onclick="showEditUserModal('${user.id}', '${user.display_name || user.username}', '${user.role}', ${user.is_active})"
                                    class="btn-edit" style="padding: 6px 10px; font-size: 11px;">Edit</button>
                            <button onclick="deleteUser('${user.id}', '${user.username}')"
                                    class="btn-delete" style="padding: 6px 10px; font-size: 11px;">Delete</button>
                        ` : '<span style="font-size: 11px; color: var(--text-muted);">You</span>'}
                    </div>
                </div>
            `).join('');
        }

        async function loadActivity() {
            if (!currentUser || currentUser.role !== 'admin') return;

            const cloudflareUrl = getCloudflareUrl();
            try {
                const response = await authFetch(`${cloudflareUrl}/api/activity?limit=30`);
                if (!response.ok) return;

                const data = await response.json();
                renderActivityLog(data.activity || []);
            } catch (e) {
                console.error('Error loading activity:', e);
            }
        }

        function renderActivityLog(activities) {
            const container = document.getElementById('activityLog');

            if (activities.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No recent activity.</p>';
                return;
            }

            const actionIcons = {
                'login': 'üîê',
                'create_inquiry': 'üìù',
                'create_user': 'üë§',
                'update_user': '‚úèÔ∏è',
                'delete_user': 'üóëÔ∏è'
            };

            container.innerHTML = activities.map(a => `
                <div style="padding: 8px 12px; background: var(--bg-elevated); border-radius: 6px; font-size: 12px;">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                        <span>${actionIcons[a.action] || 'üìå'}</span>
                        <span style="color: var(--text-primary); font-weight: 500;">${a.display_name || a.username || 'Unknown'}</span>
                    </div>
                    <div style="color: var(--text-secondary);">${formatAction(a.action, a.entity_type, a.details)}</div>
                    <div style="color: var(--text-muted); font-size: 10px; margin-top: 4px;">${formatDate(a.created_at)}</div>
                </div>
            `).join('');
        }

        function formatAction(action, entityType, details) {
            const actions = {
                'login': 'Logged in',
                'create_inquiry': `Created quote${details ? ' for ' + details : ''}`,
                'create_user': `Created user ${details || ''}`,
                'update_user': 'Updated user settings',
                'delete_user': 'Deleted a user'
            };
            return actions[action] || action;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff/60000)} min ago`;
            if (diff < 86400000) return `${Math.floor(diff/3600000)} hours ago`;
            return date.toLocaleDateString();
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'flex';
            document.getElementById('addUserError').style.display = 'none';
            document.getElementById('newUserUsername').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserDisplayName').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserRole').value = 'staff';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }

        async function createNewUser() {
            const username = document.getElementById('newUserUsername').value;
            const email = document.getElementById('newUserEmail').value;
            const displayName = document.getElementById('newUserDisplayName').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const errorEl = document.getElementById('addUserError');

            if (!username || !email || !password) {
                errorEl.textContent = 'Username, email, and password are required';
                errorEl.style.display = 'block';
                return;
            }

            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await authFetch(`${cloudflareUrl}/api/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password, role, displayName })
                });

                const data = await response.json();

                if (!response.ok) {
                    errorEl.textContent = data.error || 'Failed to create user';
                    errorEl.style.display = 'block';
                    return;
                }

                closeAddUserModal();
                loadUsers();
                loadActivity();
                showNotification(`User ${username} created successfully!`, 'success');
            } catch (e) {
                errorEl.textContent = 'Error creating user: ' + e.message;
                errorEl.style.display = 'block';
            }
        }

        function showEditUserModal(userId, displayName, role, isActive) {
            document.getElementById('editUserModal').style.display = 'flex';
            document.getElementById('editUserError').style.display = 'none';
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserDisplayName').value = displayName;
            document.getElementById('editUserRole').value = role;
            document.getElementById('editUserPassword').value = '';
            document.getElementById('editUserActive').value = isActive ? '1' : '0';
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        async function saveUserEdit() {
            const userId = document.getElementById('editUserId').value;
            const displayName = document.getElementById('editUserDisplayName').value;
            const role = document.getElementById('editUserRole').value;
            const password = document.getElementById('editUserPassword').value;
            const isActive = document.getElementById('editUserActive').value === '1';
            const errorEl = document.getElementById('editUserError');

            const updateData = { displayName, role, isActive };
            if (password) {
                updateData.password = password;
            }

            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await authFetch(`${cloudflareUrl}/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();

                if (!response.ok) {
                    errorEl.textContent = data.error || 'Failed to update user';
                    errorEl.style.display = 'block';
                    return;
                }

                closeEditUserModal();
                loadUsers();
                loadActivity();
                showNotification('User updated successfully!', 'success');
            } catch (e) {
                errorEl.textContent = 'Error updating user: ' + e.message;
                errorEl.style.display = 'block';
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await authFetch(`${cloudflareUrl}/api/users/${userId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const data = await response.json();
                    showNotification(data.error || 'Failed to delete user', 'error');
                    return;
                }

                loadUsers();
                loadActivity();
                showNotification(`User ${username} deleted successfully`, 'success');
            } catch (e) {
                showNotification('Error deleting user: ' + e.message, 'error');
            }
        }

        // ==================== END AUTHENTICATION ====================

        // Basic tab switching - Make it global immediately
        window.switchTab = function(tabName) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });

            // Remove active from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected page
            document.getElementById(tabName).classList.add('active');

            // Mark the correct tab as active
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (tab.onclick && tab.onclick.toString().includes(tabName)) {
                    tab.classList.add('active');
                }
            });

            // Load data when switching tabs
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'inquiries') {
                loadInquiries();
            } else if (tabName === 'orders') {
                loadOrders();
            } else if (tabName === 'completed') {
                loadCompletedOrders();
            } else if (tabName === 'ebay-orders') {
                loadEbayOrders();
            } else if (tabName === 'inventory') {
                loadInventory();
            } else if (tabName === 'printers') {
                loadPrinters();
            } else if (tabName === 'users') {
                loadUsers();
                loadActivity();
            }
        };

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Update color options based on material type
        window.updateColorOptions = function() {
            const materialType = document.getElementById('materialType').value;
            const colorSelect = document.getElementById('materialColor');
            const colorStockDisplay = document.getElementById('colorStockDisplay');

            // Clear current options
            colorSelect.innerHTML = '<option value="">Select a color...</option>';
            colorStockDisplay.innerHTML = '';

            if (!window.currentInventory) {
                colorStockDisplay.innerHTML = '<span style="color: var(--text-warning);">Loading inventory...</span>';
                return;
            }

            // Find materials of this type in inventory
            const materials = window.currentInventory.filter(m => m.material_type === materialType);

            if (materials.length === 0) {
                colorSelect.innerHTML = '<option value="">No colors available</option>';
                colorStockDisplay.innerHTML = `<span style="color: var(--text-warning);">No ${materialType} in inventory</span>`;
                return;
            }

            // Add color options
            materials.forEach(material => {
                const option = document.createElement('option');
                option.value = material.color;
                option.textContent = `${material.color} (${material.quantity_kg.toFixed(2)}kg available)`;
                option.dataset.materialId = material.id;
                option.dataset.price = material.price_per_kg;
                option.dataset.quantity = material.quantity_kg;
                colorSelect.appendChild(option);
            });

            // Auto-select first color if only one available
            if (materials.length === 1) {
                colorSelect.selectedIndex = 1;
                updateSpecificMaterialPrice();
            }
        };

        // Update price based on specific color selection
        window.updateSpecificMaterialPrice = function() {
            const colorSelect = document.getElementById('materialColor');
            const priceDisplay = document.getElementById('materialPriceDisplay');
            const colorStockDisplay = document.getElementById('colorStockDisplay');

            const selectedOption = colorSelect.options[colorSelect.selectedIndex];

            if (!selectedOption || !selectedOption.value) {
                priceDisplay.innerHTML = '<span style="color: var(--text-muted);">Select a color to see price</span>';
                colorStockDisplay.innerHTML = '';
                return;
            }

            const price = parseFloat(selectedOption.dataset.price);
            const quantity = parseFloat(selectedOption.dataset.quantity);
            const color = selectedOption.value;

            priceDisplay.innerHTML = `
                <span style="color: var(--text-success);">
                    üí∞ $${price.toFixed(2)}/kg for ${color}
                </span>
            `;

            if (quantity < 0.2) {
                colorStockDisplay.innerHTML = `
                    <span style="color: var(--text-error);">
                        ‚ö†Ô∏è Low stock: ${quantity.toFixed(2)}kg remaining
                    </span>
                `;
            } else {
                colorStockDisplay.innerHTML = `
                    <span style="color: var(--text-muted);">
                        ‚úÖ ${quantity.toFixed(2)}kg available
                    </span>
                `;
            }
        };

        // Update material price display based on inventory (keep for backward compatibility)
        window.updateMaterialPrice = function() {
            // This now just triggers color options update
            updateColorOptions();
        };

        // Get material price from inventory
        function getMaterialPricePerGram() {
            const materialType = document.getElementById('materialType').value;
            const colorSelect = document.getElementById('materialColor');
            const selectedOption = colorSelect.options[colorSelect.selectedIndex];
            const sourceIndicator = document.getElementById('materialSourceIndicator');

            if (!window.currentInventory || window.currentInventory.length === 0) {
                // Default prices per gram if no inventory
                const defaultPrices = {
                    'PLA': 0.03,
                    'PETG': 0.035,
                    'ABS': 0.032,
                    'TPU': 0.045,
                    'Nylon': 0.055,
                    'CF-Nylon': 0.085,
                    'Wood': 0.04,
                    'Metal': 0.12,
                    'PEEK': 0.35,
                    'PVA': 0.08
                };
                if (sourceIndicator) {
                    sourceIndicator.innerHTML = '(default pricing)';
                    sourceIndicator.style.color = '#fbbf24';
                }
                return defaultPrices[materialType] || 0.03;
            }

            // If a specific color is selected, use its price
            if (selectedOption && selectedOption.value && selectedOption.dataset.price) {
                const pricePerKg = parseFloat(selectedOption.dataset.price);
                const quantity = parseFloat(selectedOption.dataset.quantity);

                if (sourceIndicator) {
                    sourceIndicator.innerHTML = `(${selectedOption.value}: ${quantity.toFixed(2)}kg available)`;
                    sourceIndicator.style.color = '#22c55e';
                }

                return pricePerKg / 1000; // Convert to per gram
            }

            // Get price from inventory
            const materials = window.currentInventory.filter(m => m.material_type === materialType);
            if (materials.length > 0) {
                // Use average price from inventory and convert from per kg to per gram
                const avgPricePerKg = materials.reduce((sum, m) => sum + m.price_per_kg, 0) / materials.length;
                const totalStock = materials.reduce((sum, m) => sum + m.quantity_kg, 0);

                if (sourceIndicator) {
                    sourceIndicator.innerHTML = `(from inventory: ${totalStock.toFixed(2)}kg available)`;
                    sourceIndicator.style.color = '#22c55e';
                }

                return avgPricePerKg / 1000; // Convert to per gram
            }

            // Fallback to default if material not in inventory
            if (sourceIndicator) {
                sourceIndicator.innerHTML = '(default - not in inventory)';
                sourceIndicator.style.color = '#ef4444';
            }
            return 0.03;
        }

        // Update available colors based on selected material type
        window.updateColorOptions = async function() {
            const materialType = document.getElementById('materialType').value;
            const colorSelect = document.getElementById('materialColor');

            // Clear existing options
            colorSelect.innerHTML = '<option value="">Select a color...</option>';

            try {
                // Get inventory from Cloudflare
                const cloudflareUrl = getCloudflareUrl();
                const response = await fetch(`${cloudflareUrl}/api/inventory`);

                if (response.ok) {
                    const data = await response.json();
                    const inventory = data.inventory || [];

                    // Filter by selected material type and get unique colors
                    const colors = [...new Set(inventory
                        .filter(item => item.material_type === materialType && item.color)
                        .map(item => item.color))];

                    // Add color options
                    colors.forEach(color => {
                        const option = document.createElement('option');
                        option.value = color;
                        option.textContent = color;
                        colorSelect.appendChild(option);
                    });

                    if (colors.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No colors available for ' + materialType;
                        option.disabled = true;
                        colorSelect.appendChild(option);
                    }
                }
            } catch (error) {
                console.error('Error loading colors:', error);
            }
        };

        // Update material price (placeholder for now)
        window.updateMaterialPrice = function() {
            // This function can be expanded to update price based on material type
            console.log('Material price updated');
        };

        // Update specific material price based on color
        window.updateSpecificMaterialPrice = function() {
            const materialType = document.getElementById('materialType').value;
            const materialColor = document.getElementById('materialColor').value;
            const stockDisplay = document.getElementById('colorStockDisplay');

            if (materialColor) {
                // This could show stock info for the specific color
                stockDisplay.innerHTML = `Selected: ${materialType} - ${materialColor}`;
                stockDisplay.style.color = '#22c55e';
            } else {
                stockDisplay.innerHTML = '';
            }
        };

        // Quote Calculator Functions
        function calculateQuote() {
            // Debug to catch when values are unexpectedly high
            const materialWeightRaw = document.getElementById('materialWeight').value;
            const printTimeRaw = document.getElementById('printTime').value;
            console.log('calculateQuote called with raw values:', { materialWeightRaw, printTimeRaw });

            // Get input values (using original variable names from formula)
            const K3 = parseFloat(materialWeightRaw) || 0; // weight in grams
            const L3 = parseFloat(printTimeRaw) || 0; // time in hours
            const M3 = parseInt(document.getElementById('numBeds').value) || 1; // number of beds
            const N3 = parseFloat(document.getElementById('laborTime').value) || 0; // labor in minutes
            const O3 = parseFloat(document.getElementById('shippingCost').value) || 0; // shipping cost

            // Validate reasonable ranges
            if (K3 > 10000) { // > 10kg seems unreasonable
                console.warn('Material weight seems too high:', K3);
                document.getElementById('materialWeight').value = '';
                return;
            }
            if (L3 > 200) { // > 200 hours seems unreasonable
                console.warn('Print time seems too high:', L3);
                document.getElementById('printTime').value = '';
                return;
            }

            // Constants from original CSV formula
            const C4 = 1.1; // efficiency multiplier
            const C5 = 0.56; // printer cost per hour
            const C6 = 60; // labor rate per hour ($60/hr)
            const C7 = 2.5; // bed cost
            const C8 = 5; // multi-day multiplier

            // Get material price from inventory or use default
            const materialPricePerGram = getMaterialPricePerGram();

            // Calculate multi-day fee: IF(L3>24, L3/24*C8, 0)
            const multidayFee = L3 > 24 ? (L3 / 24) * C8 : 0;

            // Material cost: Use inventory price or default
            const materialCostCalc = K3 * materialPricePerGram * C4;

            // Labor cost: N3/60*C6 (convert minutes to hours)
            const laborCostCalc = (N3 / 60) * C6;

            // Printer cost: L3*C5
            const printerCostCalc = L3 * C5;

            // Bed cost: (M3-1)*C7
            const bedCostCalc = (M3 - 1) * C7;
            const shippingCostCalc = O3;

            // Subtotal before multiplier
            const subtotalBeforeMultiplier = multidayFee + materialCostCalc + laborCostCalc + printerCostCalc + bedCostCalc + O3;

            // Apply the original complex multiplier: (1.095/0.5) = 2.19
            const totalQuote = Math.round(subtotalBeforeMultiplier * (1.095 / 0.5) * 100) / 100;

            // Update display elements if they exist
            if (document.getElementById('totalQuote')) {
                document.getElementById('totalQuote').textContent = `$${totalQuote.toFixed(2)}`;
            }
            if (document.getElementById('materialCost')) {
                const pricePerKg = (materialPricePerGram * 1000).toFixed(2);
                document.getElementById('materialCost').innerHTML = `
                    <span>$${materialCostCalc.toFixed(2)}</span>
                    <span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">
                        @ $${pricePerKg}/kg
                    </span>
                `;
            }
            if (document.getElementById('printerCost')) {
                document.getElementById('printerCost').textContent = `$${printerCostCalc.toFixed(2)}`;
            }
            if (document.getElementById('laborCost')) {
                document.getElementById('laborCost').textContent = `$${laborCostCalc.toFixed(2)}`;
            }
            if (document.getElementById('multidayCost')) {
                document.getElementById('multidayCost').textContent = `$${multidayFee.toFixed(2)}`;
            }
            if (document.getElementById('bedCost')) {
                document.getElementById('bedCost').textContent = `$${bedCostCalc.toFixed(2)}`;
            }
            if (document.getElementById('displayShippingCost')) {
                document.getElementById('displayShippingCost').textContent = `$${shippingCostCalc.toFixed(2)}`;
            }
            if (document.getElementById('subtotal')) {
                document.getElementById('subtotal').textContent = `$${subtotalBeforeMultiplier.toFixed(2)}`;
            }

            // Update project summary if exists
            if (document.getElementById('summaryWeight')) {
                document.getElementById('summaryWeight').textContent = `Weight: ${materialWeight} grams`;
            }
            if (document.getElementById('summaryTime')) {
                document.getElementById('summaryTime').textContent = `Print Time: ${printTime} hours`;
            }
            if (document.getElementById('summaryMaterial')) {
                document.getElementById('summaryMaterial').textContent = `Material: ${document.getElementById('materialType').value}`;
            }
            if (document.getElementById('summaryBeds')) {
                document.getElementById('summaryBeds').textContent = `Beds Required: ${numBeds}`;
            }

            return totalQuote;
        }

        function clearQuoteForm() {
            // Clear all input fields
            document.getElementById('materialWeight').value = '';
            document.getElementById('printTime').value = '';
            document.getElementById('numBeds').value = '1';
            document.getElementById('laborTime').value = '0';
            document.getElementById('shippingCost').value = '0';
            document.getElementById('materialType').selectedIndex = 0;
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('projectDescription').value = '';

            // Reset all display values
            document.getElementById('totalQuote').textContent = '$0.00';
            document.getElementById('materialCost').textContent = '$0.00';
            document.getElementById('printerCost').textContent = '$0.00';
            document.getElementById('laborCost').textContent = '$0.00';
            document.getElementById('multidayCost').textContent = '$0.00';
            document.getElementById('bedCost').textContent = '$0.00';
            document.getElementById('displayShippingCost').textContent = '$0.00';
            document.getElementById('subtotal').textContent = '$0.00';

            // Reset project summary
            document.getElementById('summaryWeight').textContent = 'Weight: - grams';
            document.getElementById('summaryTime').textContent = 'Print Time: - hours';
            document.getElementById('summaryMaterial').textContent = 'Material: -';
            document.getElementById('summaryBeds').textContent = 'Beds Required: -';

            // Clear uploaded files
            window.uploadedFiles = [];
            window.pendingFiles = [];
            displayUploadedFiles();

            showNotification('Quote form cleared successfully', 'success');
        }

        window.saveQuoteToInquiries = async function() {
            // Get form data
            const customerName = document.getElementById('customerName').value;
            const customerEmail = document.getElementById('customerEmail').value || '';
            const projectDescription = document.getElementById('projectDescription')?.value ||
                                     document.querySelector('textarea[placeholder*="project details"]')?.value ||
                                     'Custom 3D Print Project';

            if (!customerName) {
                showNotification('Please enter customer name', 'error');
                return;
            }

            // Upload files to Cloudflare first if there are pending files
            let uploadedFilesData = [];
            if (window.pendingFiles && window.pendingFiles.length > 0) {
                console.log('Found pending files to upload:', window.pendingFiles);
                showNotification('üì§ Uploading files to Cloudflare...', 'info');
                try {
                    const uploadResult = await uploadFilesToCloudflare();
                    console.log('Upload result:', uploadResult);
                    if (uploadResult && uploadResult.success && uploadResult.files) {
                        uploadedFilesData = uploadResult.files;
                        showNotification(`‚úÖ Uploaded ${uploadResult.files.length} file(s) successfully`, 'success');
                    } else {
                        console.error('Upload failed or returned no files:', uploadResult);
                        // Still use the local files if upload failed
                        uploadedFilesData = window.uploadedFiles || [];
                        showNotification('‚ö†Ô∏è Using local files (upload failed)', 'warning');
                    }
                } catch (error) {
                    console.error('Upload error in saveQuoteToInquiries:', error);
                    // Still use the local files if upload failed
                    uploadedFilesData = window.uploadedFiles || [];
                    showNotification('‚ö†Ô∏è Using local files (upload error)', 'warning');
                }
            }

            // Get quote details - get values from input fields, not innerText
            const materialWeight = parseFloat(document.getElementById('materialWeight')?.value || 0);
            const printTime = parseFloat(document.getElementById('printTime')?.value || 0);
            const materialType = document.getElementById('materialType')?.value || 'PLA';
            const materialColor = document.getElementById('materialColor')?.value || '';
            const totalCost = parseFloat(document.getElementById('totalQuote')?.textContent.replace('$', '') || 0);

            // Use uploaded files from Cloudflare or local uploadedFiles
            const files = uploadedFilesData.length > 0 ? uploadedFilesData : (window.uploadedFiles || []);
            console.log('Files to save with inquiry:', files);

            // Create inquiry object
            const inquiry = {
                id: Date.now(),
                customerName,
                customerEmail,
                projectDescription,
                message: projectDescription, // Keep for compatibility
                materialWeight,
                printTime,
                materialType,
                materialColor, // Add color field
                totalCost,
                status: 'pending',
                createdAt: new Date().toISOString(),
                files: files.map(f => ({
                    name: f.name || f.originalname,
                    originalname: f.name || f.originalname,
                    filename: f.filename || f.path || f.key, // This is the R2 storage key
                    size: f.size,
                    type: f.type || f.mimetype,
                    key: f.filename || f.path || f.key, // Include the key field
                    url: f.url || '',
                    uploadDate: f.uploadDate || new Date().toISOString()
                }))
            };

            // Save to Cloudflare API
            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'https://etsy-3d-print-api.royal-bush-a056.workers.dev';
                const response = await fetch(`${workerUrl}/api/inquiries`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customerName: inquiry.customerName,
                        customerEmail: inquiry.customerEmail,
                        projectDescription: inquiry.projectDescription,
                        materialWeight: inquiry.materialWeight,
                        printTime: inquiry.printTime,
                        materialType: inquiry.materialType,
                        materialColor: inquiry.materialColor, // Include color in API call
                        totalQuote: inquiry.totalCost,
                        status: inquiry.status,
                        files: inquiry.files
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save to Cloudflare');
                }

                const result = await response.json();
                console.log('Inquiry saved to Cloudflare:', result);

                // Successfully saved to Cloudflare
                console.log('Inquiry saved to Cloudflare only (no localStorage)');

            } catch (error) {
                console.error('Error saving to Cloudflare:', error);
                // Fall back to localStorage
                const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
                inquiries.unshift(inquiry);
                localStorage.setItem('inquiries', JSON.stringify(inquiries));
                console.log('Saved to localStorage as fallback');
                showNotification('‚ö†Ô∏è Saved locally (cloud sync failed)', 'warning');
            }

            // Clear form
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            if (document.getElementById('projectDescription')) {
                document.getElementById('projectDescription').value = '';
            }

            // Clear uploaded files for next inquiry
            window.uploadedFiles = [];
            window.pendingFiles = [];
            displayUploadedFiles();

            showNotification('‚úÖ Quote saved to inquiries successfully', 'success');

            // Switch to inquiries tab and reload
            if (typeof switchTab === 'function') {
                switchTab('inquiries');
                // Reload inquiries to show the new one
                if (typeof loadInquiries === 'function') {
                    loadInquiries();
                }
            }
        };

        function exportQuote() {
            const customerName = document.getElementById('customerName').value || 'Customer';
            const totalQuote = document.getElementById('totalQuote').textContent;
            const materialWeight = document.getElementById('materialWeight').value;
            const printTime = document.getElementById('printTime').value;
            const materialType = document.getElementById('materialType').value;
            const projectDescription = document.getElementById('projectDescription').value;

            if (!materialWeight || !printTime) {
                showNotification('Please enter at least weight and print time to export', 'error');
                return;
            }

            // Create quote text
            const quoteText = `
3D PRINTING QUOTE
=================

Customer: ${customerName}
Date: ${new Date().toLocaleDateString()}

PROJECT DETAILS:
- Material Weight: ${materialWeight} grams
- Print Time: ${printTime} hours
- Material Type: ${materialType}
- Description: ${projectDescription || 'No description provided'}

COST BREAKDOWN:
- Material Cost: ${document.getElementById('materialCost').textContent}
- Printer Time: ${document.getElementById('printerCost').textContent}
- Labor Cost: ${document.getElementById('laborCost').textContent}
- Multi-day Fee: ${document.getElementById('multidayCost').textContent}
- Additional Beds: ${document.getElementById('bedCost').textContent}
- Shipping: ${document.getElementById('displayShippingCost').textContent}

TOTAL QUOTE: ${totalQuote}

Generated by 3D Print Business Manager
            `.trim();

            // Create and download file
            const blob = new Blob([quoteText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Quote_${customerName.replace(/\s+/g, '_')}_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showNotification('Quote exported successfully', 'success');
        }

        // Initialize calculator
        async function initializeCalculator() {
            // Set default values
            document.getElementById('numBeds').value = '1';
            document.getElementById('laborTime').value = '0';
            document.getElementById('shippingCost').value = '0';

            // Load colors for default material type
            await updateColorOptions();

            // Calculate initial quote (should be $0.00)
            calculateQuote();
        }

        // Create quoteCalculator object for button calls
        window.quoteCalculator = {
            saveAsInquiry: async function() {
                console.log('üöÄ Save button clicked!');
                showNotification('üîÑ Save button clicked...', 'info');
                try {
                    await saveQuoteToInquiries();
                } catch (error) {
                    console.error('‚ùå Error in saveAsInquiry:', error);
                    showNotification('‚ùå Error saving inquiry: ' + error.message, 'error');
                }
            },
            exportQuote: function() {
                exportQuote();
            }
        };

        // Auto-initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            initializeCalculator();
            // Check authentication first - app will load data once logged in
            await checkAuth();
            if (currentUser) {
                loadInquiries(); // Initialize inquiries on page load
            }
        });

        // ===== INQUIRIES MANAGEMENT SYSTEM =====

        // Global variables for modal state
        let currentConfirmAction = null;
        let currentInquiryId = null;

        // Load and display inquiries - ONLY FROM CLOUDFLARE
        window.loadInquiries = async function() {
            // Clear any old localStorage data
            localStorage.removeItem('inquiries');

            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'https://etsy-3d-print-api.royal-bush-a056.workers.dev';
                const response = await authFetch(`${workerUrl}/api/inquiries`);

                if (!response.ok) {
                    throw new Error('Failed to load inquiries from Cloudflare');
                }

                const cloudflareData = await response.json();
                const cloudflareInquiries = cloudflareData.inquiries || [];

                // Convert Cloudflare format to display format
                const inquiries = cloudflareInquiries.map(cfInquiry => ({
                    id: cfInquiry.id,
                    timestamp: cfInquiry.created_at || new Date().toISOString(),
                    customerName: cfInquiry.customer_name,
                    customerEmail: cfInquiry.customer_email,
                    projectDescription: cfInquiry.project_description,
                    materialWeight: cfInquiry.material_weight,
                    printTime: cfInquiry.print_time,
                    materialType: cfInquiry.material_type,
                    materialColor: cfInquiry.material_color,
                    totalQuote: cfInquiry.total_quote,
                    status: cfInquiry.status,
                    files: cfInquiry.files || [],
                    hasFiles: (cfInquiry.files || []).length > 0,
                    createdBy: cfInquiry.created_by_name || cfInquiry.created_by_username || null
                }));

                // Debug: log all inquiries and their statuses
                console.log('All inquiries from Cloudflare:', inquiries.map(i => ({
                    id: i.id,
                    name: i.customerName,
                    status: i.status
                })));

                // Filter out purchased inquiries - they're now orders
                const activeInquiries = inquiries.filter(inquiry => inquiry.status !== 'purchased');

                console.log('Active inquiries after filtering:', activeInquiries.map(i => ({
                    id: i.id,
                    name: i.customerName,
                    status: i.status
                })));

                // Sort by timestamp descending
                activeInquiries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Display inquiries (no localStorage needed - everything from Cloudflare)
                displayInquiries(activeInquiries);
            } catch (error) {
                console.error('Error loading from Cloudflare:', error);
                // Show empty state
                displayInquiries([]);
                showNotification('Unable to load inquiries from cloud', 'error');
            }
        };

        // Helper functions for badges
        function getStatusBadge(status) {
            const badges = {
                'pending': '<span style="display: inline-block; padding: 2px 6px; background: rgba(251, 146, 60, 0.2); color: #fb923c; border-radius: 3px; font-size: 11px; font-weight: 500; white-space: nowrap;">‚è≥ Pending</span>',
                'purchased': '<span style="display: inline-block; padding: 2px 6px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 3px; font-size: 11px; font-weight: 500; white-space: nowrap;">‚úÖ Purchased</span>',
                'declined': '<span style="display: inline-block; padding: 2px 6px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border-radius: 3px; font-size: 11px; font-weight: 500; white-space: nowrap;">‚ùå Declined</span>'
            };
            return badges[status] || badges['pending'];
        }

        function getMaterialBadge(material) {
            return `<span style="display: inline-block; padding: 4px 10px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 4px; font-size: 12px; font-weight: 500;">${material}</span>`;
        }

        // Display inquiries in the table
        function displayInquiries(inquiries) {
            const tableBody = document.getElementById('inquiriesTableBody');
            const emptyState = document.getElementById('emptyInquiriesState');

            if (inquiries.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tableBody.innerHTML = inquiries.map(inquiry => {
                const date = new Date(inquiry.timestamp).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                const statusBadge = getStatusBadge(inquiry.status);
                const materialBadge = getMaterialBadge(inquiry.materialType || 'PLA');

                return `
                    <tr style="border-bottom: 1px solid #1f2937;">
                        <td style="padding: 10px 6px; color: #e5e7eb; font-size: 12px; white-space: nowrap;">${date}</td>
                        <td style="padding: 10px 6px; color: #e5e7eb; font-size: 12px;">
                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${inquiry.customerName}
                            </div>
                        </td>
                        <td style="padding: 10px 6px; color: #9ca3af; font-size: 12px;">
                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${inquiry.customerEmail || 'No email'}
                            </div>
                        </td>
                        <td style="padding: 10px 6px; color: #9ca3af; font-size: 12px;">
                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${inquiry.projectDescription || inquiry.message || 'No description'}">
                                ${inquiry.projectDescription || inquiry.message || 'No description'}
                            </div>
                        </td>
                        <td style="padding: 10px 6px; color: #9ca3af; font-size: 12px;">
                            ${(inquiry.hasFiles || (inquiry.files && inquiry.files.length > 0)) ?
                            `<button onclick="downloadInquiryFiles('${inquiry.id}')"
                                style="background: none; border: none; color: #22c55e; cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: all 0.2s;"
                                onmouseover="this.style.background='rgba(34, 197, 94, 0.2)'"
                                onmouseout="this.style.background='none'"
                                title="Download ${inquiry.files.length} file(s)">
                                üìÑ ${inquiry.files.length} ‚¨áÔ∏è
                            </button>` :
                            '<span style="color: #6b7280;">-</span>'}</td>
                        <td style="padding: 10px 6px; font-size: 11px;">
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <span style="padding: 2px 6px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 3px; font-weight: 500;">${inquiry.materialType || 'PLA'}</span>
                                ${inquiry.materialColor ? `<span style="padding: 2px 6px; background: rgba(59, 130, 246, 0.2); color: #3b82f6; border-radius: 3px; font-size: 10px;">${inquiry.materialColor}</span>` : ''}
                            </div>
                        </td>
                        <td style="padding: 10px 6px; color: #e5e7eb; font-size: 12px;">${inquiry.materialWeight}g</td>
                        <td style="padding: 10px 6px; color: #e5e7eb; font-size: 12px;">${inquiry.printTime}h</td>
                        <td style="padding: 10px 6px; color: #22c55e; font-weight: 600; font-size: 12px;">${typeof inquiry.totalQuote === 'number' ? '$' + inquiry.totalQuote.toFixed(2) : inquiry.totalQuote}</td>
                        <td style="padding: 10px 6px; font-size: 11px;">${statusBadge}</td>
                        <td style="padding: 10px 6px; font-size: 11px;">
                            ${inquiry.createdBy ?
                                `<span style="display: inline-block; padding: 2px 6px; background: rgba(147, 51, 234, 0.2); color: #a855f7; border-radius: 3px; font-size: 10px; white-space: nowrap;" title="Created by ${inquiry.createdBy}">üë§ ${inquiry.createdBy}</span>` :
                                '<span style="color: #6b7280; font-size: 10px;">-</span>'}
                        </td>
                        <td style="padding: 10px 6px; font-size: 11px;">
                            <div style="display: flex; gap: 4px; flex-wrap: nowrap;">
                                <button onclick="editInquiry('${inquiry.id}')" title="Edit"
                                    style="padding: 4px 8px; background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    ‚úèÔ∏è Edit
                                </button>
                                ${inquiry.status !== 'purchased' ?
                                    `<button onclick="markAsPurchased('${inquiry.id}')" title="Mark as Purchased"
                                        style="padding: 4px 8px; background: rgba(34, 197, 94, 0.15); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 4px; font-size: 11px; cursor: pointer;">
                                        üí∞ Purchase
                                    </button>` : ''
                                }
                                <button onclick="deleteInquiry('${inquiry.id}')" title="Delete"
                                    style="padding: 4px 8px; background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }


        // Refresh inquiries
        window.refreshInquiries = function() {
            loadInquiries();
            showNotification('Inquiries refreshed successfully', 'success');
        };

        // Make button functions globally accessible
        function editInquiry(id) { window.editInquiry(id); }
        function markAsPurchased(id) { window.markAsPurchased(id); }
        function deleteInquiry(id) { window.deleteInquiry(id); }

        // Clear all data function for development
        window.clearAllData = function() {
            if (confirm('This will clear ALL data including inquiries, orders, and settings. Are you sure?')) {
                localStorage.removeItem('inquiries');
                localStorage.removeItem('orders');
                localStorage.removeItem('inventory');
                localStorage.removeItem('printers');
                localStorage.removeItem('appSettings');
                localStorage.removeItem('test_inquiries');
                localStorage.removeItem('uploadedFiles');
                loadInquiries();
                showNotification('All data cleared successfully', 'success');
            }
        };

        // Filter inquiries
        window.filterInquiries = async function() {
            const filter = document.getElementById('inquiryFilter').value;

            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'https://etsy-3d-print-api.royal-bush-a056.workers.dev';
                const response = await fetch(`${workerUrl}/api/inquiries`);

                if (!response.ok) {
                    throw new Error('Failed to load inquiries from Cloudflare');
                }

                const cloudflareData = await response.json();
                const cloudflareInquiries = cloudflareData.inquiries || [];

                // Convert to display format
                const inquiries = cloudflareInquiries.map(cfInquiry => ({
                    id: cfInquiry.id,
                    timestamp: cfInquiry.created_at || new Date().toISOString(),
                    customerName: cfInquiry.customer_name,
                    customerEmail: cfInquiry.customer_email,
                    projectDescription: cfInquiry.project_description,
                    materialWeight: cfInquiry.material_weight,
                    printTime: cfInquiry.print_time,
                    materialType: cfInquiry.material_type,
                    totalQuote: cfInquiry.total_quote,
                    status: cfInquiry.status,
                    files: cfInquiry.files || [],
                    hasFiles: (cfInquiry.files || []).length > 0
                }));

                // Apply filter
                let filtered = inquiries;
                if (filter) {
                    filtered = inquiries.filter(inquiry => inquiry.status === filter);
                } else {
                    // Default: hide purchased inquiries
                    filtered = inquiries.filter(inquiry => inquiry.status !== 'purchased');
                }

                // Sort by timestamp descending
                filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                displayInquiries(filtered);
            } catch (error) {
                console.error('Error filtering inquiries:', error);
                displayInquiries([]);
            }
        };

        // Edit inquiry
        window.editInquiry = async function(inquiryId) {
            try {
                // First try to get from Cloudflare
                const cloudflareUrl = getCloudflareUrl();
                let inquiry = null;

                try {
                    const response = await fetch(`${cloudflareUrl}/api/inquiries/${inquiryId}`);
                    if (response.ok) {
                        inquiry = await response.json();
                    }
                } catch (error) {
                    console.error('Error fetching from Cloudflare:', error);
                }

                // No localStorage fallback - everything from Cloudflare

                if (!inquiry) {
                    showNotification('Inquiry not found', 'error');
                    return;
                }

                // Populate edit form with all fields
                document.getElementById('editInquiryId').value = inquiry.id;
                document.getElementById('editCustomerName').value = inquiry.customerName || '';
                document.getElementById('editCustomerEmail').value = inquiry.customerEmail || '';
                document.getElementById('editProjectDescription').value = inquiry.projectDescription || inquiry.message || '';
                document.getElementById('editMaterialWeight').value = inquiry.materialWeight || 0;
                document.getElementById('editPrintTime').value = inquiry.printTime || 0;
                document.getElementById('editMaterialType').value = inquiry.materialType || 'PLA';
                document.getElementById('editInquiryStatus').value = inquiry.status || 'pending';
                document.getElementById('editTotalQuote').value = inquiry.totalCost || 0;

                // Display current files
                const filesDiv = document.getElementById('editCurrentFiles');
                if (inquiry.files && inquiry.files.length > 0) {
                    filesDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--text-muted);">Current files:</span>
                            <button type="button" onclick="downloadInquiryFiles('${inquiry.id}')"
                                style="padding: 4px 8px; background: rgba(34, 197, 94, 0.15); color: #22c55e;
                                       border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 4px;
                                       font-size: 11px; cursor: pointer;">
                                ‚¨áÔ∏è Download All
                            </button>
                        </div>
                        ${inquiry.files.map(file => `
                            <div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
                                <span style="color: var(--accent-green); font-size: 14px;">üìÑ</span>
                                <span style="font-size: 13px; color: var(--text-primary);">${file.original_name || file.originalName || file.name || 'File'}</span>
                                <span style="font-size: 11px; color: var(--text-muted);">(${((file.file_size || file.size || 0) / 1024).toFixed(1)} KB)</span>
                            </div>
                        `).join('')}
                    `;
                } else {
                    filesDiv.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">No files uploaded</div>';
                }

                // Clear file input and display
                document.getElementById('editFileInput').value = '';
                document.getElementById('editFileDisplay').style.display = 'none';
                document.getElementById('editFileDisplay').innerHTML = '';
                window.editSelectedFiles = null;

                // Store current inquiry data for reference
                window.currentEditInquiry = inquiry;

                // Show modal
                document.getElementById('editInquiryModal').style.display = 'block';
            } catch (error) {
                console.error('Error opening edit modal:', error);
                showNotification('‚ùå Error loading inquiry', 'error');
            }
        };

        // Close edit modal
        window.closeEditModal = function() {
            document.getElementById('editInquiryModal').style.display = 'none';
        };

        // Save inquiry edit
        window.saveInquiryEdit = async function() {
            const inquiryId = document.getElementById('editInquiryId').value;

            // Validate required fields
            const customerName = document.getElementById('editCustomerName').value.trim();
            const customerEmail = document.getElementById('editCustomerEmail').value.trim();
            const projectDescription = document.getElementById('editProjectDescription').value.trim();
            const materialWeight = parseFloat(document.getElementById('editMaterialWeight').value);
            const printTime = parseFloat(document.getElementById('editPrintTime').value);
            const materialType = document.getElementById('editMaterialType').value;
            const status = document.getElementById('editInquiryStatus').value;
            const totalQuote = parseFloat(document.getElementById('editTotalQuote').value);

            if (!customerName || !customerEmail || !projectDescription) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            // Check for new files
            const hasNewFiles = window.editSelectedFiles && window.editSelectedFiles.length > 0;

            try {
                showNotification('üíæ Saving changes...', 'info');

                // Get current inquiry data
                const currentInquiry = window.currentEditInquiry;
                let newFiles = currentInquiry.files || [];

                // If new files are uploaded, handle file replacement
                if (hasNewFiles) {
                    const cloudflareUrl = getCloudflareUrl();

                    // Delete old files from Cloudflare if they exist
                    if (currentInquiry.files && currentInquiry.files.length > 0) {
                        showNotification('üóëÔ∏è Removing old files...', 'info');

                        for (const file of currentInquiry.files) {
                            const fileKey = file.file_key || file.cloudflareKey || file.key;
                            if (fileKey) {
                                try {
                                    await fetch(`${cloudflareUrl}/api/files/${encodeURIComponent(fileKey)}`, {
                                        method: 'DELETE'
                                    });
                                } catch (error) {
                                    console.error('Error deleting old file:', error);
                                }
                            }
                        }
                    }

                    // Upload new files
                    showNotification('üì§ Uploading new files...', 'info');
                    newFiles = [];

                    // Upload all files at once
                    const formData = new FormData();
                    for (const file of window.editSelectedFiles) {
                        formData.append('files', file);
                    }
                    formData.append('inquiryId', inquiryId);

                    try {
                        const response = await fetch(`${cloudflareUrl}/api/upload`, {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const uploadedFiles = result.files || [];

                            for (const uploadedFile of uploadedFiles) {
                                newFiles.push({
                                    name: uploadedFile.originalname || uploadedFile.originalName || uploadedFile.name,
                                    originalName: uploadedFile.originalname || uploadedFile.originalName || uploadedFile.name,
                                    size: uploadedFile.size || 0,
                                    cloudflareKey: uploadedFile.filename || uploadedFile.path || uploadedFile.key,
                                    key: uploadedFile.filename || uploadedFile.path || uploadedFile.key,
                                    uploadedAt: new Date().toISOString()
                                });
                            }
                        } else {
                            const errorText = await response.text();
                            console.error('Upload failed:', errorText);
                            throw new Error(`Upload failed: ${response.status}`);
                        }
                    } catch (error) {
                        console.error('Error uploading files:', error);
                        showNotification(`‚ùå Failed to upload files: ${error.message}`, 'error');
                        return;
                    }
                }

                // Update inquiry in Cloudflare
                const updatedInquiry = {
                    id: inquiryId,
                    customerName,
                    customerEmail,
                    projectDescription,
                    message: projectDescription,
                    materialWeight,
                    printTime,
                    materialType,
                    status,
                    totalCost: totalQuote,
                    files: newFiles,
                    updatedAt: new Date().toISOString(),
                    createdAt: currentInquiry.createdAt || new Date().toISOString()
                };

                const cloudflareUrl = getCloudflareUrl();
                const response = await fetch(`${cloudflareUrl}/api/inquiries/${inquiryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedInquiry)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Update failed:', errorText);
                    throw new Error(`Failed to update inquiry: ${response.status} ${errorText}`);
                }

                // Successfully updated in Cloudflare (no localStorage needed)
                console.log('Updated inquiry in Cloudflare with new files:', newFiles);

                closeEditModal();
                await loadInquiries();
                showNotification('‚úÖ Inquiry updated successfully', 'success');

            } catch (error) {
                console.error('Error saving inquiry:', error);
                showNotification(`‚ùå Failed to save: ${error.message}`, 'error');
            }
        };

        // Calculate quote for inquiry (simplified version)
        function calculateQuoteForInquiry(weight, time, beds = 1, laborMin = 0, shipping = 0) {
            const C4 = 1.1; // efficiency
            const C5 = 0.56; // printer cost/hr
            const C6 = 60; // labor rate/hr
            const C7 = 2.5; // bed cost
            const C8 = 5; // multi-day multiplier
            const C9 = 15; // material cost/kg

            const multidayFee = time > 24 ? (time / 24) * C8 : 0;
            const materialCost = (weight / 1000) * C9 * C4;
            const laborCost = (laborMin / 60) * C6;
            const printerCost = time * C5;
            const bedCost = (beds - 1) * C7;

            const subtotal = multidayFee + materialCost + laborCost + printerCost + bedCost + shipping;
            return Math.round(subtotal * (1.095 / 0.5) * 100) / 100;
        }

        // Mark as purchased
        
        // Mark as purchased and move to orders
        window.markAsPurchased = async function(inquiryId) {
            showConfirmModal(
                'Convert to Order',
                'This will convert the inquiry to an active order. Continue?',
                async () => {
                    try {
                        const cloudflareUrl = getCloudflareUrl();

                        // Fetch inquiry from Cloudflare (use authFetch)
                        const inquiryResponse = await authFetch(`${cloudflareUrl}/api/inquiries/${inquiryId}`);
                        if (!inquiryResponse.ok) {
                            const errorText = await inquiryResponse.text();
                            console.error('Failed to fetch inquiry:', errorText);
                            throw new Error('Failed to fetch inquiry');
                        }

                        const inquiryData = await inquiryResponse.json();
                        console.log('Fetched inquiry:', inquiryData);

                        // Convert to proper format
                        const inquiry = {
                            id: inquiryData.id,
                            customerName: inquiryData.customer_name,
                            customerEmail: inquiryData.customer_email,
                            projectDescription: inquiryData.project_description,
                            materialWeight: inquiryData.material_weight,
                            printTime: inquiryData.print_time,
                            materialType: inquiryData.material_type,
                            materialColor: inquiryData.material_color,
                            totalQuote: inquiryData.total_quote,
                            files: inquiryData.files || []
                        };

                        // Create new order
                        const newOrder = {
                            id: 'ORD-' + Date.now(),
                            orderNumber: '#ORD-' + Date.now().toString().slice(-6),
                            customer_name: inquiry.customerName,
                            customer_email: inquiry.customerEmail,
                            material_type: inquiry.materialType || 'PLA',
                            material_color: inquiry.materialColor || '',
                            material_weight: inquiry.materialWeight || 0,
                            product: inquiry.projectDescription || 'Custom 3D Print',
                            items: [{
                                name: inquiry.projectDescription || 'Custom 3D Print',
                                quantity: 1,
                                material: inquiry.materialType || 'PLA',
                                weight: inquiry.materialWeight,
                                printTime: inquiry.printTime
                            }],
                            quantity: 1,
                            total: inquiry.totalQuote || 0,
                            status: 'pending',
                            created_at: new Date().toISOString(),
                            due_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                            source: 'inquiry',
                            inquiry_id: inquiry.id,
                            assigned_printer: null,
                            files: inquiry.files || []
                        };

                        console.log('Creating order:', newOrder);

                        // Save order to Cloudflare (use authFetch)
                        const orderResponse = await authFetch(`${cloudflareUrl}/api/orders`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(newOrder)
                        });

                        if (!orderResponse.ok) {
                            const errorText = await orderResponse.text();
                            console.error('Failed to create order:', errorText);
                            throw new Error('Failed to create order');
                        }

                        console.log('Order created successfully');

                        // Update inquiry status in Cloudflare (use authFetch)
                        const updateResponse = await authFetch(`${cloudflareUrl}/api/inquiries/${inquiryId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                customerName: inquiry.customerName,
                                customerEmail: inquiry.customerEmail,
                                projectDescription: inquiry.projectDescription,
                                materialWeight: inquiry.materialWeight,
                                printTime: inquiry.printTime,
                                materialType: inquiry.materialType,
                                totalCost: inquiry.totalQuote,
                                status: 'purchased',
                                order_id: newOrder.id,
                                purchase_date: new Date().toISOString()
                            })
                        });

                        if (!updateResponse.ok) {
                            const errorText = await updateResponse.text();
                            console.error('Failed to update inquiry status:', errorText);
                            // Order was created but inquiry status update failed - still proceed
                            console.warn('Order created but inquiry status update failed');
                        } else {
                            console.log('‚úÖ Inquiry status updated to purchased');
                        }

                        // Note: Inventory will be deducted when order status changes to "printing"
                        // Not when purchasing, as the order might be queued or cancelled before printing

                        // Reload both inquiries and orders
                        await loadInquiries();
                        if (typeof loadOrders === 'function') {
                            await loadOrders();
                        }

                        showNotification('‚úÖ Inquiry converted to order successfully', 'success');
                        showNotification('‚ÑπÔ∏è Material will be deducted from inventory when printing starts', 'info');

                        // Switch to orders tab to show the new order
                        if (typeof switchTab === 'function') {
                            switchTab('orders');
                        }
                    } catch (error) {
                        console.error('Error converting to order:', error);
                        showNotification('‚ùå Failed to convert to order: ' + error.message, 'error');
                    }
                }
            );
        };

        // Helper function to get Cloudflare URL
        function getCloudflareUrl() {
            // Always use the hardcoded production URL
            return 'https://etsy-3d-print-api.royal-bush-a056.workers.dev';
        }

        // Delete inquiry - ONLY FROM CLOUDFLARE
        window.deleteInquiry = function(inquiryId) {
            // Convert to string for consistent comparison
            const idStr = String(inquiryId);

            showConfirmModal(
                'Delete Inquiry',
                `Are you sure you want to delete this inquiry? This will also delete all associated files from cloud storage.`,
                async () => {
                    try {
                        const cloudflareUrl = getCloudflareUrl();

                        // Delete from Cloudflare (backend will handle file deletion)
                        console.log('Deleting inquiry and files from Cloudflare:', idStr);

                        const response = await fetch(`${cloudflareUrl}/api/inquiries/${idStr}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log('Successfully deleted from Cloudflare:', result);

                            // Reload the inquiries display
                            await loadInquiries();

                            // Update Cloudflare usage bar to reflect changes
                            await updateCloudflareUsageBar();

                            // Show success notification with file count
                            const filesMsg = result.deletedFiles > 0 ? ` and ${result.deletedFiles} file(s)` : '';
                            showNotification(`‚úÖ Inquiry${filesMsg} deleted successfully`, 'success');
                        } else if (response.status === 404) {
                            throw new Error('Inquiry not found in database');
                        } else {
                            const errorText = await response.text();
                            throw new Error(`Failed to delete: ${errorText}`);
                        }
                    } catch (error) {
                        console.error('Unexpected error during delete:', error);
                        showNotification('‚ùå Error occurred while deleting - ' + error.message, 'error');
                    }
                }
            );
        };

        // Download file from Cloudflare R2
        window.downloadFile = async function(fileKey, originalName) {
            try {
                showNotification('üì• Downloading file...', 'info');

                // Get the Cloudflare worker URL
                const cloudflareUrl = getCloudflareUrl();
                if (!cloudflareUrl) {
                    showNotification('‚ùå Cloudflare not configured', 'error');
                    return;
                }

                if (!fileKey) {
                    showNotification('‚ùå File key not found', 'error');
                    return;
                }

                // Download from Cloudflare R2
                // Don't encode the forward slashes in the path
                const response = await fetch(`${cloudflareUrl}/api/download/${fileKey}`);

                if (!response.ok) {
                    throw new Error(`Download failed: ${response.statusText}`);
                }

                // Get the blob and create download
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = originalName || fileKey || 'download';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('‚úÖ File downloaded successfully', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showNotification(`‚ùå Failed to download: ${error.message}`, 'error');
            }
        };

        // Show confirmation modal
        function showConfirmModal(title, message, action) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            currentConfirmAction = action;
            document.getElementById('confirmModal').style.display = 'block';
        }

        // Close confirmation modal
        window.closeConfirmModal = function() {
            document.getElementById('confirmModal').style.display = 'none';
            currentConfirmAction = null;
        };

        // Confirm action
        window.confirmAction = function() {
            if (currentConfirmAction) {
                currentConfirmAction();
            }
            closeConfirmModal();
        };

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const editModal = document.getElementById('editInquiryModal');
            const confirmModal = document.getElementById('confirmModal');

            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
        });

        // Handle escape key to close modals
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeEditModal();
                closeConfirmModal();
            }
        });

        // ===== ORDERS MANAGEMENT SYSTEM =====

        // Initialize orders system - fetch from Cloudflare
        window.loadOrders = async function() {
            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await fetch(`${cloudflareUrl}/api/orders`);

                let orders = [];
                if (response.ok) {
                    const data = await response.json();
                    orders = data.orders || [];
                }

                // Filter out completed and shipped orders - they belong in Completed Orders tab
                const activeOrders = orders.filter(order =>
                    order.status !== 'completed' && order.status !== 'shipped'
                );

                // Convert Cloudflare format to display format
                const displayOrders = activeOrders.map(order => ({
                    id: order.id,
                    customerName: order.customer_name,
                    customerEmail: order.customer_email,
                    product: order.product || 'Custom 3D Print',
                    value: order.total_amount || 0,
                    status: order.status || 'pending',
                    dueDate: order.due_date || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
                    assignedPrinter: order.printer_assigned || null,
                    printerName: order.printer_name || null,
                    materialType: order.material_type || 'PLA',
                    materialColor: order.material_color || '',
                    materialWeight: order.material_weight || 0,
                    items: order.items || [],
                    convertedBy: order.converted_by_name || order.converted_by_username || null,
                    createdBy: order.created_by_name || order.created_by_username || null,
                    statusChangedBy: order.status_changed_by_name || order.status_changed_by_username || null,
                    files: order.files || [],
                    inquiryId: order.inquiry_id || null
                }));

                displayOrdersTable(displayOrders);
                updateOrderStats(displayOrders);
                await updatePrinterStatus(activeOrders); // Use activeOrders for printer status
                populatePrinterOptions();
            } catch (error) {
                console.error('Error loading orders:', error);
                displayOrdersTable([]);
                updatePrinterStatus([]);
            }
        };

        // Update printer status display in orders page
        async function updatePrinterStatus(orders) {
            const printerStatusGrid = document.getElementById('printerStatusGrid');
            if (!printerStatusGrid) return;

            try {
                // Fetch actual printers from Cloudflare
                const cloudflareUrl = getCloudflareUrl();
                const response = await fetch(`${cloudflareUrl}/api/printers`);

                let printers = [];
                if (response.ok) {
                    const data = await response.json();
                    printers = data.printers || [];
                }

                // If no printers, show empty state
                if (printers.length === 0) {
                    printerStatusGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--text-muted);">
                            <div style="font-size: 24px; margin-bottom: 0.5rem;">üñ®Ô∏è</div>
                            <div>No printers configured. Add printers in the Printers tab.</div>
                        </div>
                    `;
                    return;
                }

                // Get printer assignments from orders
                const printerAssignments = {};
                orders.forEach(order => {
                    if (order.printer_assigned && order.status === 'printing') {
                        printerAssignments[order.printer_assigned] = order;
                    }
                });

                // Generate printer status cards using actual printers from database
                printerStatusGrid.innerHTML = printers.map(printer => {
                const assignedOrder = printerAssignments[printer.id];
                const isIdle = !assignedOrder;
                const statusColor = isIdle ? '#22c55e' : '#f59e0b';
                const statusText = isIdle ? 'Idle' : 'Printing';
                const statusIcon = isIdle ? '‚úÖ' : 'üñ®Ô∏è';

                return `
                    <div class="card" style="padding: 12px; background: ${isIdle ?
                        'linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%)' :
                        'linear-gradient(135deg, rgba(251, 146, 60, 0.05) 0%, rgba(234, 88, 12, 0.02) 100%)'};
                        border: 1px solid ${isIdle ? 'rgba(34, 197, 94, 0.2)' : 'rgba(251, 146, 60, 0.2)'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${printer.name}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${printer.model}</div>
                            </div>
                            <div style="font-size: 18px;">${statusIcon}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 8px; height: 8px; background: ${statusColor}; border-radius: 50%; animation: ${isIdle ? 'none' : 'pulse 2s infinite'};"></span>
                            <span style="font-size: 12px; color: ${statusColor}; font-weight: 500;">${statusText}</span>
                        </div>
                        ${assignedOrder ? `
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-secondary);">
                                <div style="font-size: 11px; color: var(--text-muted);">Order: #${assignedOrder.id.slice(-4)}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${assignedOrder.customerName}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // Add pulse animation style if not exists
            if (!document.getElementById('printerPulseAnimation')) {
                const style = document.createElement('style');
                style.id = 'printerPulseAnimation';
                style.innerHTML = `
                    @keyframes pulse {
                        0% { opacity: 1; }
                        50% { opacity: 0.5; }
                        100% { opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            } catch (error) {
                console.error('Error updating printer status:', error);
                printerStatusGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--text-muted);">
                        <div style="font-size: 24px; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                        <div>Unable to load printer status</div>
                    </div>
                `;
            }
        }

        // Rename original displayOrders to displayOrdersTable
        function displayOrdersTable(orders) {
            const tableBody = document.getElementById('ordersTableBody');
            const emptyState = document.getElementById('emptyOrdersState');

            if (orders.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tableBody.innerHTML = orders.map(order => {
                const dueDate = new Date(order.dueDate);
                const isOverdue = dueDate < new Date();
                const statusBadge = getOrderStatusBadge(order.status);
                const dueDateFormatted = dueDate.toLocaleDateString();

                return `
                    <tr style="border-bottom: 1px solid var(--border-secondary); ${isOverdue ? 'background: rgba(239, 68, 68, 0.05);' : ''}">
                        <td style="padding: 16px 12px; color: var(--text-primary); font-weight: 600;">#${order.id.toString().slice(-4)}</td>
                        <td style="padding: 16px 12px; color: var(--text-primary);">${order.customerName}</td>
                        <td style="padding: 16px 12px; color: var(--text-secondary); font-size: 13px;">${order.product}</td>
                        <td style="padding: 12px; font-size: 11px;">
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <span style="padding: 2px 6px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 3px; font-weight: 500;">${order.materialType || 'PLA'}</span>
                                ${order.materialColor ? `<span style="padding: 2px 6px; background: rgba(59, 130, 246, 0.2); color: #3b82f6; border-radius: 3px; font-size: 10px;">${order.materialColor}</span>` : ''}
                                ${order.materialWeight ? `<span style="padding: 2px 6px; background: rgba(156, 163, 175, 0.2); color: #9ca3af; border-radius: 3px; font-size: 10px;">${order.materialWeight}g</span>` : ''}
                            </div>
                        </td>
                        <td style="padding: 16px 12px; font-size: 12px;">
                            ${order.files && order.files.length > 0 ?
                            `<button onclick="downloadOrderFiles('${order.inquiryId}')"
                                style="background: none; border: none; color: #22c55e; cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: all 0.2s;"
                                onmouseover="this.style.background='rgba(34, 197, 94, 0.2)'"
                                onmouseout="this.style.background='none'"
                                title="Download ${order.files.length} file(s)">
                                &#128196; ${order.files.length} &#11015;&#65039;
                            </button>` :
                            '<span style="color: #6b7280;">-</span>'}
                        </td>
                        <td style="padding: 16px 12px; color: ${isOverdue ? '#ef4444' : 'var(--text-secondary)'}; font-size: 13px;">${dueDateFormatted}</td>
                        <td style="padding: 16px 12px; color: #22c55e; font-weight: 700;">$${order.value}</td>
                        <td style="padding: 16px 12px; color: var(--text-secondary); font-size: 13px;">${order.printerName || (order.assignedPrinter ? 'Printer ' + order.assignedPrinter.slice(-4) : 'Unassigned')}</td>
                        <td style="padding: 16px 12px;">${statusBadge}</td>
                        <td style="padding: 16px 12px; font-size: 11px;">
                            ${order.convertedBy ?
                                `<span style="display: inline-block; padding: 2px 6px; background: rgba(147, 51, 234, 0.2); color: #a855f7; border-radius: 3px; white-space: nowrap;" title="Converted by ${order.convertedBy}">üîÑ ${order.convertedBy}</span>` :
                            order.createdBy ?
                                `<span style="display: inline-block; padding: 2px 6px; background: rgba(59, 130, 246, 0.2); color: #3b82f6; border-radius: 3px; white-space: nowrap;" title="Created by ${order.createdBy}">‚ûï ${order.createdBy}</span>` :
                                '<span style="color: #6b7280;">-</span>'}
                        </td>
                        <td style="padding: 16px 12px;">
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                <button onclick="updateOrderStatus('${order.id}')" class="action-btn" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Status</button>
                                <button onclick="assignPrinterToOrder('${order.id}')" class="action-btn" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Assign</button>
                                <button onclick="deleteOrder('${order.id}')" class="action-btn" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Display orders in table
        function displayOrders(orders) {
            const tableBody = document.getElementById('ordersTableBody');
            const emptyState = document.getElementById('emptyOrdersState');

            if (orders.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tableBody.innerHTML = orders.map(order => {
                const dueDate = new Date(order.dueDate);
                const isOverdue = dueDate < new Date();
                const statusBadge = getOrderStatusBadge(order.status);
                const dueDateFormatted = dueDate.toLocaleDateString();

                return `
                    <tr style="border-bottom: 1px solid var(--border-secondary); ${isOverdue ? 'background: rgba(239, 68, 68, 0.05);' : ''}">
                        <td style="padding: 16px 12px; color: var(--text-primary); font-weight: 600;">#${order.id.toString().slice(-4)}</td>
                        <td style="padding: 16px 12px; color: var(--text-primary);">${order.customerName}</td>
                        <td style="padding: 16px 12px; color: var(--text-secondary); font-size: 13px;">${order.product}</td>
                        <td style="padding: 12px; font-size: 11px;">
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <span style="padding: 2px 6px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 3px; font-weight: 500;">${order.materialType || 'PLA'}</span>
                                ${order.materialColor ? `<span style="padding: 2px 6px; background: rgba(59, 130, 246, 0.2); color: #3b82f6; border-radius: 3px; font-size: 10px;">${order.materialColor}</span>` : ''}
                                ${order.materialWeight ? `<span style="padding: 2px 6px; background: rgba(156, 163, 175, 0.2); color: #9ca3af; border-radius: 3px; font-size: 10px;">${order.materialWeight}g</span>` : ''}
                            </div>
                        </td>
                        <td style="padding: 16px 12px; color: ${isOverdue ? '#ef4444' : 'var(--text-secondary)'}; font-size: 13px;">${dueDateFormatted}</td>
                        <td style="padding: 16px 12px; color: #22c55e; font-weight: 700;">$${order.value}</td>
                        <td style="padding: 16px 12px; color: var(--text-secondary); font-size: 13px;">${order.assignedPrinter || 'Unassigned'}</td>
                        <td style="padding: 16px 12px;">${statusBadge}</td>
                        <td style="padding: 16px 12px;">
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                <button onclick="updateOrderStatus(${order.id})" class="action-btn" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Status</button>
                                <button onclick="assignPrinterToOrder(${order.id})" class="action-btn" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Assign</button>
                                <button onclick="deleteOrder(${order.id})" class="action-btn" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get order status badge
        function getOrderStatusBadge(status) {
            const badges = {
                'pending': '<span style="background: rgba(251, 146, 60, 0.1); color: #f59e0b; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">‚è≥ Pending</span>',
                'printing': '<span style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">üñ®Ô∏è Printing</span>',
                'completed': '<span style="background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">‚úÖ Completed</span>',
                'shipped': '<span style="background: rgba(147, 51, 234, 0.1); color: #9333ea; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">üì¶ Shipped</span>'
            };
            return badges[status] || badges['pending'];
        }

        // Update order statistics
        function updateOrderStats(orders) {
            const pending = orders.filter(o => o.status === 'pending').length;
            const printing = orders.filter(o => o.status === 'printing').length;
            const completed = orders.filter(o => o.status === 'completed').length;
            const shipped = orders.filter(o => o.status === 'shipped').length;

            document.getElementById('pendingOrdersCount').textContent = pending;
            document.getElementById('printingOrdersCount').textContent = printing;
            document.getElementById('completedOrdersCount').textContent = completed;
            document.getElementById('shippedOrdersCount').textContent = shipped;
        }

        // Filter orders
        window.filterOrders = function() {
            const filter = document.getElementById('orderFilter').value;
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');

            if (!filter) {
                displayOrders(orders);
                return;
            }

            const filtered = orders.filter(order => order.status === filter);
            displayOrders(filtered);
        };

        // Sync from inquiries
        window.syncFromInquiries = function() {
            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
            const purchasedInquiries = inquiries.filter(i => i.status === 'purchased');
            const existingOrders = JSON.parse(localStorage.getItem('orders') || '[]');

            let newOrdersCount = 0;
            purchasedInquiries.forEach(inquiry => {
                // Check if order already exists
                const exists = existingOrders.find(o => o.inquiryId === inquiry.id);
                if (!exists) {
                    const newOrder = {
                        id: Date.now() + Math.random(),
                        inquiryId: inquiry.id,
                        customerName: inquiry.customerName,
                        customerEmail: inquiry.customerEmail,
                        product: inquiry.projectDescription || `${inquiry.materialType} Print`,
                        value: inquiry.totalQuote.replace('$', ''),
                        dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 7 days from now
                        status: 'pending',
                        assignedPrinter: null,
                        createdAt: new Date().toISOString()
                    };
                    existingOrders.push(newOrder);
                    newOrdersCount++;
                }
            });

            localStorage.setItem('orders', JSON.stringify(existingOrders));
            loadOrders();
            showNotification(`Synced ${newOrdersCount} new orders from inquiries`, 'success');
        };

        // eBay Orders Functions
        window.loadEbayOrders = async function() {
            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await authFetch(`${cloudflareUrl}/api/ebay-orders`);

                if (!response.ok) {
                    throw new Error('Failed to load eBay orders');
                }

                const data = await response.json();
                const orders = data.orders || [];

                displayEbayOrders(orders);
                updateEbayStats(orders);
            } catch (error) {
                console.error('Error loading eBay orders:', error);
                displayEbayOrders([]);
                showNotification('Failed to load eBay orders', 'error');
            }
        };

        window.syncEbayOrders = async function() {
            const syncBtn = document.getElementById('syncEbayBtn');
            const originalText = syncBtn.innerHTML;
            syncBtn.innerHTML = '‚è≥ Syncing...';
            syncBtn.disabled = true;

            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await authFetch(`${cloudflareUrl}/api/ebay-orders/sync`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Failed to sync eBay orders');
                }

                const data = await response.json();
                showNotification(`Synced ${data.synced} new orders, updated ${data.updated}`, 'success');
                await loadEbayOrders();
            } catch (error) {
                console.error('Error syncing eBay orders:', error);
                showNotification('Failed to sync eBay orders: ' + error.message, 'error');
            } finally {
                syncBtn.innerHTML = originalText;
                syncBtn.disabled = false;
            }
        };

        function displayEbayOrders(orders) {
            const tableBody = document.getElementById('ebayOrdersTableBody');
            const emptyState = document.getElementById('emptyEbayOrdersState');

            if (orders.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tableBody.innerHTML = orders.map(order => {
                const shipByDate = order.ship_by_date ? new Date(order.ship_by_date) : null;
                const isUrgent = shipByDate && (shipByDate - new Date()) < 24 * 60 * 60 * 1000;
                const shipByFormatted = shipByDate ? shipByDate.toLocaleDateString() : '-';
                const statusBadge = getEbayStatusBadge(order.order_status);
                const shippingAddress = `${order.ship_to_city}, ${order.ship_to_state} ${order.ship_to_zip}`;

                return `
                    <tr style="border-bottom: 1px solid var(--border-secondary); ${isUrgent ? 'background: rgba(239, 68, 68, 0.05);' : ''}">
                        <td style="padding: 12px; color: var(--text-primary); font-weight: 600; font-size: 12px;">${order.order_id || '#' + order.id.slice(-6)}</td>
                        <td style="padding: 12px; color: var(--text-secondary); font-size: 12px;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 2px;">${order.buyer_username || 'N/A'}</div>
                            <div style="font-size: 11px;">${order.buyer_email || ''}</div>
                        </td>
                        <td style="padding: 12px; color: var(--text-secondary); font-size: 12px;">
                            <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 2px;">${order.item_title || 'Unknown Item'}</div>
                            ${order.item_sku ? `<div style="font-size: 10px; color: var(--text-muted);">SKU: ${order.item_sku}</div>` : ''}
                            ${order.quantity > 1 ? `<div style="font-size: 10px; color: var(--text-muted);">Qty: ${order.quantity}</div>` : ''}
                        </td>
                        <td style="padding: 12px; color: var(--text-secondary); font-size: 11px;">
                            <div style="font-weight: 500; color: var(--text-primary);">${order.ship_to_name || ''}</div>
                            <div>${shippingAddress}</div>
                            ${order.ship_to_country !== 'US' ? `<div style="color: #f59e0b;">üåç ${order.ship_to_country}</div>` : ''}
                        </td>
                        <td style="padding: 12px; color: ${isUrgent ? '#ef4444' : 'var(--text-secondary)'}; font-size: 12px; font-weight: ${isUrgent ? '700' : '400'};">
                            ${isUrgent ? '‚ö†Ô∏è ' : ''}${shipByFormatted}
                        </td>
                        <td style="padding: 12px; color: #22c55e; font-weight: 700; font-size: 13px;">$${(order.total_price || 0).toFixed(2)}</td>
                        <td style="padding: 12px; font-size: 11px;">
                            ${order.tracking_number ?
                                `<div style="background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 10px;">${order.tracking_number}</div>` :
                                `<button onclick="addEbayTracking('${order.id}')" class="btn-secondary" style="padding: 4px 8px; font-size: 11px;">+ Add Tracking</button>`
                            }
                        </td>
                        <td style="padding: 12px;">${statusBadge}</td>
                        <td style="padding: 12px;">
                            <div style="display: flex; gap: 4px;">
                                <button onclick="viewEbayOrder('${order.id}')" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">View</button>
                                <button onclick="markEbayShipped('${order.id}')" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">Ship</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateEbayStats(orders) {
            const now = new Date();
            const oneDayFromNow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            const urgent = orders.filter(o => {
                const shipBy = o.ship_by_date ? new Date(o.ship_by_date) : null;
                return shipBy && shipBy < oneDayFromNow && o.order_status !== 'shipped';
            }).length;

            const pending = orders.filter(o => o.order_status === 'pending' || o.order_status === 'IN_PROGRESS').length;

            const shipped = orders.filter(o => {
                const shippedDate = o.shipped_time ? new Date(o.shipped_time) : null;
                return o.order_status === 'shipped' || (shippedDate && shippedDate > oneWeekAgo);
            }).length;

            document.getElementById('ebayUrgentCount').textContent = urgent;
            document.getElementById('ebayPendingCount').textContent = pending;
            document.getElementById('ebayShippedCount').textContent = shipped;
        }

        function getEbayStatusBadge(status) {
            const statusMap = {
                'pending': { color: '#f59e0b', bg: 'rgba(251, 146, 60, 0.1)', text: 'Pending' },
                'IN_PROGRESS': { color: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)', text: 'Processing' },
                'FULFILLED': { color: '#22c55e', bg: 'rgba(34, 197, 94, 0.1)', text: 'Fulfilled' },
                'shipped': { color: '#22c55e', bg: 'rgba(34, 197, 94, 0.1)', text: 'Shipped' },
                'CANCELLED': { color: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)', text: 'Cancelled' }
            };

            const statusInfo = statusMap[status] || statusMap['pending'];
            return `<span style="background: ${statusInfo.bg}; color: ${statusInfo.color}; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${statusInfo.text}</span>`;
        }

        window.addEbayTracking = async function(orderId) {
            const tracking = prompt('Enter tracking number:');
            if (!tracking) return;

            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await authFetch(`${cloudflareUrl}/api/ebay-orders/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        trackingNumber: tracking,
                        orderStatus: 'shipped',
                        shippedTime: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to update tracking');
                }

                showNotification('Tracking number added successfully', 'success');
                await loadEbayOrders();
            } catch (error) {
                console.error('Error adding tracking:', error);
                showNotification('Failed to add tracking number', 'error');
            }
        };

        window.markEbayShipped = async function(orderId) {
            if (!confirm('Mark this order as shipped?')) return;

            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await authFetch(`${cloudflareUrl}/api/ebay-orders/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderStatus: 'shipped',
                        shippedTime: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to update status');
                }

                showNotification('Order marked as shipped', 'success');
                await loadEbayOrders();
            } catch (error) {
                console.error('Error updating status:', error);
                showNotification('Failed to update order status', 'error');
            }
        };

        window.viewEbayOrder = function(orderId) {
            showNotification('Order details view coming soon', 'info');
        };

        // Show add order modal
        window.showAddOrderModal = function() {
            populatePrinterOptions();
            document.getElementById('addOrderModal').style.display = 'block';
        };

        // Close add order modal
        window.closeAddOrderModal = function() {
            document.getElementById('addOrderModal').style.display = 'none';
            document.getElementById('addOrderForm').reset();
        };

        // Save new order
        window.saveNewOrder = function() {
            const customerName = document.getElementById('newOrderCustomer').value.trim();
            const customerEmail = document.getElementById('newOrderEmail').value.trim();
            const product = document.getElementById('newOrderProduct').value.trim();
            const value = document.getElementById('newOrderValue').value;
            const dueDate = document.getElementById('newOrderDueDate').value;
            const assignedPrinter = document.getElementById('newOrderPrinter').value;

            if (!customerName || !customerEmail || !product || !value || !dueDate) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const newOrder = {
                id: Date.now(),
                customerName,
                customerEmail,
                product,
                value: parseFloat(value).toFixed(2),
                dueDate,
                status: 'pending',
                assignedPrinter: assignedPrinter || null,
                createdAt: new Date().toISOString()
            };

            orders.unshift(newOrder);
            localStorage.setItem('orders', JSON.stringify(orders));
            closeAddOrderModal();
            loadOrders();
            showNotification('Order added successfully', 'success');
        };

        // Update order status with modal
        window.updateOrderStatus = async function(orderId) {
            try {
                const cloudflareUrl = getCloudflareUrl();

                // Get current order
                const response = await fetch(`${cloudflareUrl}/api/orders/${orderId}`);
                if (!response.ok) {
                    throw new Error('Order not found');
                }
                const order = await response.json();

                const currentStatus = order.status || 'ready';
                const statusOptions = [
                    { value: 'ready', label: '‚è≥ Ready', color: '#f59e0b' },
                    { value: 'printing', label: 'üñ®Ô∏è Printing', color: '#3b82f6' },
                    { value: 'failed', label: '‚ùå Failed', color: '#ef4444' },
                    { value: 'completed', label: '‚úÖ Completed', color: '#22c55e' },
                    { value: 'shipped', label: 'üì¶ Shipped', color: '#8b5cf6' }
                ];

                // Create status options HTML
                const statusButtons = statusOptions.map(status => `
                    <button
                        onclick="confirmStatusUpdate('${orderId}', '${status.value}')"
                        style="width: 100%; padding: 12px; margin-bottom: 8px; background: ${currentStatus === status.value ? status.color + '20' : 'var(--bg-secondary)'};
                               color: ${currentStatus === status.value ? status.color : 'var(--text-primary)'};
                               border: 1px solid ${currentStatus === status.value ? status.color : 'var(--border-secondary)'};
                               border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;
                               transition: all 0.2s; text-align: left;"
                        onmouseover="this.style.background='${status.color}20'; this.style.borderColor='${status.color}'"
                        onmouseout="this.style.background='${currentStatus === status.value ? status.color + '20' : 'var(--bg-secondary)'}'; this.style.borderColor='${currentStatus === status.value ? status.color : 'var(--border-secondary)'}'">
                        ${status.label} ${currentStatus === status.value ? '(Current)' : ''}
                    </button>
                `).join('');

                // Create modal for status selection
                const modalHtml = `
                    <div id="statusSelectModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: var(--bg-card); padding: 2rem; border-radius: 12px; border: 1px solid var(--border-primary); width: 90%; max-width: 400px;">
                            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">üìä Update Order Status</h3>
                            <div style="margin-bottom: 1rem;">
                                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 1rem;">Order #${orderId.slice(-4)}</p>
                            </div>
                            ${statusButtons}
                            <button class="btn btn-secondary" onclick="document.getElementById('statusSelectModal').remove()" style="width: 100%; margin-top: 8px;">Cancel</button>
                        </div>
                    </div>
                `;

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);

            } catch (error) {
                console.error('Error showing status modal:', error);
                showNotification('‚ùå Failed to load order status', 'error');
            }
        };

        // Confirm status update
        window.confirmStatusUpdate = async function(orderId, newStatus) {
            try {
                const cloudflareUrl = getCloudflareUrl();

                // Get current order
                const response = await fetch(`${cloudflareUrl}/api/orders/${orderId}`);
                if (!response.ok) {
                    throw new Error('Order not found');
                }
                const order = await response.json();

                // If changing to failed status, show failure percentage modal
                if (newStatus === 'failed') {
                    showFailurePercentageModal(orderId, order);
                    return;
                }

                // If changing from failed to printing, handle material adjustment
                if (order.status === 'failed' && newStatus === 'printing') {
                    await resumeFailedPrint(orderId, order);
                    return;
                }

                // If changing to printing status (and not from failed), deduct full material from inventory
                if (newStatus === 'printing' && order.status !== 'failed' && order.status !== 'printing') {
                    console.log('Order before material check:', {
                        id: orderId,
                        material_type: order.material_type,
                        material_weight: order.material_weight,
                        inquiry_id: order.inquiry_id,
                        items: order.items
                    });

                    // Try to get material info from items array if not in top level
                    if (!order.material_weight || !order.material_type) {
                        if (order.items && order.items.length > 0 && order.items[0]) {
                            const item = order.items[0];
                            order.material_type = order.material_type || item.material || 'PLA';
                            order.material_weight = order.material_weight || item.weight || 0;
                            console.log('Got material info from items:', {
                                material_type: order.material_type,
                                material_weight: order.material_weight
                            });
                        }
                    }

                    // Check if order has material information from the original inquiry
                    if (!order.material_weight || !order.material_type) {
                        // Try to get from inquiry if available
                        const inquiryId = order.inquiry_id;
                        if (inquiryId) {
                            console.log('Fetching inquiry for material info:', inquiryId);
                            const inquiryResponse = await fetch(`${cloudflareUrl}/api/inquiries/${inquiryId}`);
                            if (inquiryResponse.ok) {
                                const inquiry = await inquiryResponse.json();
                                order.material_weight = inquiry.material_weight;
                                order.material_type = inquiry.material_type;
                                console.log('Got material info from inquiry:', {
                                    material_type: order.material_type,
                                    material_weight: order.material_weight
                                });
                            }
                        }
                    }

                    // Deduct material if we have the information
                    if (order.material_weight && order.material_type) {
                        console.log(`üì¶ Starting print - deducting ${(order.material_weight/1000).toFixed(3)}kg of ${order.material_type} (${order.material_color || 'any color'})`);
                        await deductMaterialFromInventory(order.material_type, order.material_weight / 1000, order.material_color); // Convert grams to kg
                        showNotification(`üì¶ Deducted ${(order.material_weight/1000).toFixed(3)}kg of ${order.material_type} from inventory`, 'info');

                        // Reload inventory to update green bars
                        await loadInventory();
                    } else {
                        console.error('No material information available for order', {
                            orderId,
                            order,
                            material_type: order.material_type,
                            material_weight: order.material_weight
                        });
                        showNotification('‚ö†Ô∏è No material information for this order - cannot deduct from inventory', 'warning');
                    }
                }

                // Update order in Cloudflare - ensure material info is saved
                const orderUpdateData = {
                    ...order,
                    status: newStatus,
                    material_weight: order.material_weight,
                    material_type: order.material_type
                };

                console.log('Updating order with data:', {
                    id: orderId,
                    status: newStatus,
                    material_type: orderUpdateData.material_type,
                    material_weight: orderUpdateData.material_weight
                });

                const updateResponse = await fetch(`${cloudflareUrl}/api/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderUpdateData)
                });

                if (!updateResponse.ok) {
                    throw new Error('Failed to update order');
                }

                // Remove modal
                document.getElementById('statusSelectModal').remove();

                // Refresh the appropriate tabs
                await loadOrders();

                // If order was moved to completed/shipped, also refresh completed orders tab
                if (newStatus === 'completed' || newStatus === 'shipped') {
                    await loadCompletedOrders();
                    showNotification(`‚úÖ Order moved to Completed Orders tab`, 'success');
                } else {
                    showNotification(`‚úÖ Order status updated to ${newStatus}`, 'success');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                showNotification('‚ùå Failed to update order status', 'error');
            }
        };

        // Show failure percentage modal
        window.showFailurePercentageModal = function(orderId, order) {
            const modalHtml = `
                <div id="failureModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: var(--bg-card); padding: 2rem; border-radius: 12px; border: 1px solid var(--border-primary); width: 90%; max-width: 450px;">
                        <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">‚ùå Print Failed</h3>
                        <div style="margin-bottom: 1rem;">
                            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 1rem;">
                                Order #${orderId.slice(-4)} - ${order.customer_name}
                            </p>
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 1.5rem;">
                                Enter the percentage completed before the print failed. This will be used to calculate material consumed.
                            </p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Completion Percentage (%)</label>
                            <input type="number" id="failurePercentage" class="form-input" min="0" max="100" step="1" placeholder="e.g., 45" value="${order.failure_percentage || 0}">
                            <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                                <span id="materialUsedEstimate"></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Failure Notes (Optional)</label>
                            <textarea id="failureNotes" class="form-input" rows="3" placeholder="What caused the failure? (e.g., nozzle clog, power outage, filament jam)">${order.failure_notes || ''}</textarea>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 1.5rem;">
                            <button class="btn" onclick="saveFailureDetails('${orderId}')" style="flex: 1; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);">
                                üíæ Save Failure Details
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('failureModal').remove()" style="flex: 1;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Calculate material estimate on percentage change
            const percentInput = document.getElementById('failurePercentage');
            const estimateSpan = document.getElementById('materialUsedEstimate');

            function updateMaterialEstimate() {
                const percentage = parseFloat(percentInput.value) || 0;
                if (order.material_weight) {
                    const usedGrams = (order.material_weight * percentage / 100).toFixed(2);
                    estimateSpan.textContent = `Material used: ~${usedGrams}g of ${order.material_weight}g total`;
                }
            }

            percentInput.addEventListener('input', updateMaterialEstimate);
            updateMaterialEstimate();
        };

        // Save failure details
        window.saveFailureDetails = async function(orderId) {
            try {
                const cloudflareUrl = getCloudflareUrl();
                const percentage = parseFloat(document.getElementById('failurePercentage').value) || 0;
                const notes = document.getElementById('failureNotes').value;

                // Get current order
                const response = await fetch(`${cloudflareUrl}/api/orders/${orderId}`);
                if (!response.ok) {
                    throw new Error('Order not found');
                }
                const order = await response.json();

                // Calculate material consumed
                const materialConsumed = order.material_weight ? (order.material_weight * percentage / 100) : 0;

                // Update order with failure details
                const updateResponse = await fetch(`${cloudflareUrl}/api/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...order,
                        status: 'failed',
                        failure_percentage: percentage,
                        failure_notes: notes,
                        material_consumed: materialConsumed
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error('Failed to update order');
                }

                // Update inventory if material was consumed
                if (materialConsumed > 0 && order.material_type) {
                    console.log(`üî• Print failed at ${percentage}% - deducting ${(materialConsumed/1000).toFixed(3)}kg of ${order.material_type}`);
                    await deductMaterialFromInventory(order.material_type, materialConsumed / 1000); // Convert grams to kg

                    // Reload inventory to update green bars
                    await loadInventory();
                    showNotification(`üì¶ Deducted ${(materialConsumed/1000).toFixed(3)}kg of ${order.material_type} for failed print`, 'info');
                } else {
                    console.log(`‚ö†Ô∏è No material consumed for failed print (${percentage}% complete)`);
                }

                // Remove modals
                document.getElementById('failureModal')?.remove();
                document.getElementById('statusSelectModal')?.remove();

                await loadOrders();
                showNotification(`‚ö†Ô∏è Order marked as failed (${percentage}% complete)`, 'warning');

            } catch (error) {
                console.error('Error saving failure details:', error);
                showNotification('‚ùå Failed to save failure details', 'error');
            }
        };

        // Resume failed print
        window.resumeFailedPrint = async function(orderId, order) {
            const modalHtml = `
                <div id="resumeModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: var(--bg-card); padding: 2rem; border-radius: 12px; border: 1px solid var(--border-primary); width: 90%; max-width: 450px;">
                        <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">üîÑ Resume Failed Print</h3>
                        <div style="margin-bottom: 1rem;">
                            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 1rem;">
                                Order #${orderId.slice(-4)} - ${order.customer_name}
                            </p>
                            <div style="padding: 12px; background: rgba(251, 146, 60, 0.1); border: 1px solid rgba(251, 146, 60, 0.3); border-radius: 8px; margin-bottom: 1rem;">
                                <p style="font-size: 12px; color: #fb923c; margin: 0;">
                                    <strong>Previous failure:</strong> ${order.failure_percentage || 0}% complete<br>
                                    ${order.failure_notes ? `<strong>Notes:</strong> ${order.failure_notes}<br>` : ''}
                                    <strong>Material consumed:</strong> ${order.material_consumed || 0}g
                                </p>
                            </div>
                            <p style="font-size: 12px; color: var(--text-muted);">
                                Resuming will deduct the remaining material needed from inventory.
                            </p>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 1.5rem;">
                            <button class="btn" onclick="confirmResumePrint('${orderId}')" style="flex: 1;">
                                ‚ñ∂Ô∏è Resume Printing
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('resumeModal').remove()" style="flex: 1;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };

        // Confirm resume print
        window.confirmResumePrint = async function(orderId) {
            try {
                const cloudflareUrl = getCloudflareUrl();

                // Get current order
                const response = await fetch(`${cloudflareUrl}/api/orders/${orderId}`);
                if (!response.ok) {
                    throw new Error('Order not found');
                }
                const order = await response.json();

                // Calculate remaining material needed
                const remainingMaterial = order.material_weight - (order.material_consumed || 0);

                // Deduct remaining material from inventory
                if (remainingMaterial > 0 && order.material_type) {
                    console.log(`üîÑ Resuming print - deducting remaining ${(remainingMaterial/1000).toFixed(3)}kg of ${order.material_type}`);
                    await deductMaterialFromInventory(order.material_type, remainingMaterial / 1000); // Convert grams to kg

                    // Reload inventory to update green bars
                    await loadInventory();
                    showNotification(`üì¶ Deducted ${(remainingMaterial/1000).toFixed(3)}kg of ${order.material_type} for resumed print`, 'info');
                }

                // Update order status to printing
                const updateResponse = await fetch(`${cloudflareUrl}/api/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...order,
                        status: 'printing',
                        resumed_from_failure: true,
                        resume_date: new Date().toISOString()
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error('Failed to update order');
                }

                // Remove modals
                document.getElementById('resumeModal')?.remove();
                document.getElementById('statusSelectModal')?.remove();

                await loadOrders();
                showNotification(`‚úÖ Print resumed (deducted ${(remainingMaterial/1000).toFixed(2)}kg from inventory)`, 'success');

            } catch (error) {
                console.error('Error resuming print:', error);
                showNotification('‚ùå Failed to resume print', 'error');
            }
        };

        // Deduct material from inventory
        async function deductMaterialFromInventory(materialType, amountKg, materialColor = null) {
            try {
                console.log(`Attempting to deduct ${amountKg}kg of ${materialType} from inventory`);
                const cloudflareUrl = getCloudflareUrl();

                // Get inventory items for this material type
                const response = await fetch(`${cloudflareUrl}/api/inventory`);
                if (!response.ok) {
                    console.error('Failed to fetch inventory');
                    return;
                }

                const data = await response.json();
                let materials = (data.inventory || []).filter(m => m.material_type === materialType);

                // If color is specified, prioritize that color
                if (materialColor) {
                    const colorMatched = materials.filter(m => m.color === materialColor);
                    if (colorMatched.length > 0) {
                        materials = colorMatched;
                        console.log(`Using ${materialColor} ${materialType} from inventory`);
                    } else {
                        console.log(`No ${materialColor} ${materialType} found, using any available color`);
                    }
                }

                if (materials.length === 0) {
                    console.warn(`No ${materialType} found in inventory`);
                    showNotification(`‚ö†Ô∏è No ${materialType} in inventory to deduct`, 'warning');
                    return;
                }

                // Sort by quantity to use the spool with most material first
                materials.sort((a, b) => b.quantity_kg - a.quantity_kg);

                let remainingToDeduct = amountKg;
                const updates = [];

                // Deduct from materials starting with the fullest
                for (const material of materials) {
                    if (remainingToDeduct <= 0) break;

                    const deductFromThis = Math.min(material.quantity_kg, remainingToDeduct);
                    const newQuantity = material.quantity_kg - deductFromThis;

                    console.log(`Deducting ${deductFromThis}kg from ${material.color} ${materialType} (ID: ${material.id})`);

                    // Update this material
                    const updateResponse = await fetch(`${cloudflareUrl}/api/inventory/${material.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ...material,
                            quantity_kg: newQuantity
                        })
                    });

                    if (updateResponse.ok) {
                        remainingToDeduct -= deductFromThis;
                        updates.push(`${material.color}: -${deductFromThis.toFixed(3)}kg`);
                    } else {
                        console.error(`Failed to update material ${material.id}`);
                    }
                }

                if (updates.length > 0) {
                    await loadInventory(); // Refresh inventory display
                    console.log('Inventory updated:', updates.join(', '));
                }

                if (remainingToDeduct > 0) {
                    showNotification(`‚ö†Ô∏è Insufficient ${materialType} in inventory (short by ${remainingToDeduct.toFixed(3)}kg)`, 'warning');
                }
            } catch (error) {
                console.error('Error deducting material from inventory:', error);
                showNotification('‚ùå Failed to update inventory', 'error');
            }
        }

        // Assign printer to order
        window.assignPrinterToOrder = async function(orderId) {
            try {
                const cloudflareUrl = getCloudflareUrl();

                // Get actual printers from Cloudflare
                const printersResponse = await fetch(`${cloudflareUrl}/api/printers`);
                if (!printersResponse.ok) {
                    throw new Error('Failed to fetch printers');
                }
                const printersData = await printersResponse.json();
                const availablePrinters = printersData.printers || [];

                if (availablePrinters.length === 0) {
                    showNotification('No printers available. Please add printers in the Printers tab first.', 'error');
                    return;
                }

                // Get current orders to check which printers are busy
                const ordersResponse = await fetch(`${cloudflareUrl}/api/orders`);
                const ordersData = await ordersResponse.json();
                const orders = ordersData.orders || [];

                // Find printers that are not assigned to printing orders
                const busyPrinters = orders
                    .filter(o => o.status === 'printing' && o.printer_assigned)
                    .map(o => o.printer_assigned);

                const freePrinters = availablePrinters.filter(p => !busyPrinters.includes(p.id));

                if (freePrinters.length === 0) {
                    showNotification('No available printers for assignment', 'error');
                    return;
                }

                // Show printer selection modal
                const printerOptions = freePrinters.map(p =>
                    `<option value="${p.id}">${p.name}</option>`
                ).join('');

                // Create a simple modal for printer selection
                const modalHtml = `
                    <div id="printerSelectModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: var(--bg-card); padding: 2rem; border-radius: 12px; border: 1px solid var(--border-primary); width: 90%; max-width: 400px;">
                            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">üñ®Ô∏è Assign Printer</h3>
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 1rem;">Select an available printer for Order #${orderId.slice(-4)}</p>
                            <select id="printerSelect" class="form-input" style="width: 100%; margin-bottom: 1rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-secondary); padding: 10px; border-radius: 8px;">
                                <option value="" style="background: var(--bg-secondary); color: var(--text-primary);">Choose a printer...</option>
                                ${printerOptions.replace(/<option/g, '<option style="background: var(--bg-secondary); color: var(--text-primary);"')}
                            </select>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn" onclick="confirmPrinterAssignment('${orderId}')" style="flex: 1;">‚úÖ Assign Printer</button>
                                <button class="btn btn-secondary" onclick="document.getElementById('printerSelectModal').remove()" style="flex: 1;">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <style>
                        #printerSelect:focus {
                            outline: 2px solid var(--accent-primary);
                            outline-offset: 2px;
                        }
                        #printerSelect option:hover {
                            background: var(--accent-primary) !important;
                        }
                        #printerSelect option:checked {
                            background: rgba(34, 197, 94, 0.2) !important;
                        }
                    </style>
                `;

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);

            } catch (error) {
                console.error('Error assigning printer:', error);
                showNotification('‚ùå Failed to assign printer', 'error');
            }
        };

        // Confirm printer assignment
        window.confirmPrinterAssignment = async function(orderId) {
            try {
                const printerId = document.getElementById('printerSelect').value;

                // Validate that a printer was selected
                if (!printerId) {
                    showNotification('‚ö†Ô∏è Please select a printer', 'warning');
                    return;
                }

                const cloudflareUrl = getCloudflareUrl();

                // Get current order
                const response = await fetch(`${cloudflareUrl}/api/orders/${orderId}`);
                if (!response.ok) {
                    throw new Error('Order not found');
                }
                const order = await response.json();

                // Update order with printer assignment and status
                const updateResponse = await fetch(`${cloudflareUrl}/api/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...order,
                        printer_assigned: printerId,
                        status: 'printing'
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error('Failed to assign printer');
                }

                // Remove modal
                document.getElementById('printerSelectModal').remove();

                await loadOrders();
                showNotification(`Order assigned to printer`, 'success');
            } catch (error) {
                console.error('Error confirming printer assignment:', error);
                showNotification('‚ùå Failed to assign printer', 'error');
            }
        };

        // Delete order
        window.deleteOrder = async function(orderId) {
            showConfirmModal(
                'Delete Order',
                `Are you sure you want to delete order #${orderId.toString().slice(-4)}? This will also delete all associated files from cloud storage.`,
                async () => {
                    try {
                        const cloudflareUrl = getCloudflareUrl();

                        // Delete the order (backend will handle file deletion)
                        console.log('Deleting order and files from Cloudflare:', orderId);

                        const response = await fetch(`${cloudflareUrl}/api/orders/${orderId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log('Successfully deleted from Cloudflare:', result);

                            // Reload orders, inquiries, and update all stats
                            await loadOrders();
                            await loadInquiries();

                            // Update Cloudflare usage bar to reflect changes
                            await updateCloudflareUsageBar();

                            // Show success notification with file and inquiry count
                            let deleteMsg = '‚úÖ Order';
                            if (result.deletedFiles > 0) deleteMsg += `, ${result.deletedFiles} file(s)`;
                            if (result.deletedInquiry) deleteMsg += ', and associated inquiry';
                            deleteMsg += ' deleted successfully';
                            showNotification(deleteMsg, 'success');
                        } else {
                            throw new Error('Failed to delete order');
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showNotification('‚ùå Failed to delete order', 'error');
                    }
                }
            );
        };

        // Delete completed order
        window.deleteCompletedOrder = async function(orderId) {
            showConfirmModal(
                'Delete Completed Order',
                `Are you sure you want to permanently delete order #${orderId.toString().slice(-4)}? This will also delete all associated files from cloud storage.`,
                async () => {
                    try {
                        const cloudflareUrl = getCloudflareUrl();

                        // Delete the order (backend will handle file deletion)
                        console.log('Deleting completed order and files from Cloudflare:', orderId);

                        const response = await fetch(`${cloudflareUrl}/api/orders/${orderId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log('Successfully deleted from Cloudflare:', result);

                            // Reload completed orders, inquiries, and update financial stats
                            await loadCompletedOrders();
                            await loadInquiries();

                            // Update Cloudflare usage bar to reflect changes
                            await updateCloudflareUsageBar();

                            // Show success notification with file and inquiry count
                            let deleteMsg = '‚úÖ Completed order';
                            if (result.deletedFiles > 0) deleteMsg += `, ${result.deletedFiles} file(s)`;
                            if (result.deletedInquiry) deleteMsg += ', and associated inquiry';
                            deleteMsg += ' deleted successfully';
                            showNotification(deleteMsg, 'success');
                        } else {
                            throw new Error('Failed to delete completed order');
                        }
                    } catch (error) {
                        console.error('Error deleting completed order:', error);
                        showNotification('‚ùå Failed to delete completed order', 'error');
                    }
                }
            );
        };

        // Delete all data from Cloudflare
        window.deleteAllCloudflareData = async function() {
            showConfirmModal(
                'Delete All Data',
                '‚ö†Ô∏è WARNING: This will permanently delete ALL data from Cloudflare including:\n\n‚Ä¢ All inquiries\n‚Ä¢ All orders (active and completed)\n‚Ä¢ All files from R2 storage\n‚Ä¢ All inventory records\n‚Ä¢ All printer records\n\nThis action CANNOT be undone. Are you absolutely sure?',
                async () => {
                    try {
                        const cloudflareUrl = getCloudflareUrl();

                        // Show loading notification
                        showNotification('üóëÔ∏è Deleting all data from Cloudflare...', 'info');

                        // Call force cleanup endpoint
                        console.log('Calling force cleanup endpoint...');
                        const response = await fetch(`${cloudflareUrl}/api/force-cleanup`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log('Force cleanup result:', result);

                            // Reload all data views
                            await loadInquiries();
                            await loadOrders();
                            await loadCompletedOrders();

                            // Update stats
                            await updateCloudflareUsageBar();

                            // Show detailed success notification
                            const summary = `Deleted ${result.deleted.inquiries} inquiries, ${result.deleted.orders} orders, ${result.deleted.files} file records, and ${result.deleted.r2Objects} R2 files`;
                            showNotification(`‚úÖ All data deleted successfully\n${summary}`, 'success');
                        } else {
                            const errorText = await response.text();
                            throw new Error(`Failed to delete all data: ${errorText}`);
                        }
                    } catch (error) {
                        console.error('Error deleting all data:', error);
                        showNotification('‚ùå Failed to delete all data - ' + error.message, 'error');
                    }
                }
            );
        };

        // ===== COMPLETED ORDERS SYSTEM =====

        // Load completed orders
        window.loadCompletedOrders = async function() {
            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await fetch(`${cloudflareUrl}/api/orders`);

                let orders = [];
                if (response.ok) {
                    const data = await response.json();
                    orders = data.orders || [];
                }

                // Filter only completed and shipped orders
                const completedOrders = orders.filter(order =>
                    order.status === 'completed' || order.status === 'shipped'
                );

                // Convert to display format
                const displayOrders = completedOrders.map(order => ({
                    id: order.id,
                    customerName: order.customer_name,
                    customerEmail: order.customer_email,
                    product: order.product || 'Custom 3D Print',
                    value: order.total_amount || 0,
                    status: order.status,
                    completedDate: order.updated_at || order.order_date,
                    printTime: order.print_time || 0,
                    items: order.items || []
                }));

                displayCompletedOrders(displayOrders);
                updateFinancialSummary(displayOrders);
                generateRevenueChart(displayOrders);

            } catch (error) {
                console.error('Error loading completed orders:', error);
                displayCompletedOrders([]);
            }
        };

        // Display completed orders in table
        function displayCompletedOrders(orders) {
            const tableBody = document.getElementById('completedOrdersTableBody');
            const emptyState = document.getElementById('emptyCompletedOrdersState');

            if (!tableBody) return;

            if (orders.length === 0) {
                tableBody.innerHTML = '';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';

            tableBody.innerHTML = orders.map(order => {
                const completedDate = new Date(order.completedDate).toLocaleDateString();
                const statusBadge = order.status === 'completed' ?
                    '<span style="background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">‚úÖ Completed</span>' :
                    '<span style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">üì¶ Shipped</span>';

                return `
                    <tr style="border-bottom: 1px solid var(--border-secondary);">
                        <td style="padding: 12px; color: var(--text-primary); font-weight: 600;">#${order.id.toString().slice(-4)}</td>
                        <td style="padding: 12px; color: var(--text-secondary);">${completedDate}</td>
                        <td style="padding: 12px; color: var(--text-primary);">${order.customerName}</td>
                        <td style="padding: 12px; color: var(--text-secondary); font-size: 13px;">${order.product}</td>
                        <td style="padding: 12px; color: #22c55e; font-weight: 700;">$${order.value.toFixed(2)}</td>
                        <td style="padding: 12px; color: var(--text-secondary);">${order.printTime || 0}h</td>
                        <td style="padding: 12px;">${statusBadge}</td>
                        <td style="padding: 12px;">
                            <div style="display: flex; gap: 6px;">
                                <button onclick="viewOrderDetails('${order.id}')" class="action-btn" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">üëÅÔ∏è View</button>
                                <button onclick="deleteCompletedOrder('${order.id}')" class="action-btn" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">üóëÔ∏è Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update financial summary
        function updateFinancialSummary(orders) {
            const totalRevenue = orders.reduce((sum, order) => sum + (order.value || 0), 0);
            const averageValue = orders.length > 0 ? totalRevenue / orders.length : 0;
            const totalPrintTime = orders.reduce((sum, order) => sum + (order.printTime || 0), 0);

            const revenueEl = document.getElementById('totalRevenue');
            const avgEl = document.getElementById('averageOrderValue');
            const countEl = document.getElementById('totalCompletedOrders');
            const hoursEl = document.getElementById('totalPrintHours');

            if (revenueEl) revenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
            if (avgEl) avgEl.textContent = `$${averageValue.toFixed(2)}`;
            if (countEl) countEl.textContent = orders.length.toString();
            if (hoursEl) hoursEl.textContent = `${totalPrintTime}h`;
        }

        // Generate revenue chart
        function generateRevenueChart(orders) {
            const chartEl = document.getElementById('revenueChart');
            if (!chartEl) return;

            // Group orders by month
            const monthlyRevenue = {};
            const now = new Date();

            // Initialize last 6 months
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = date.toLocaleDateString('en-US', { month: 'short' });
                monthlyRevenue[key] = 0;
            }

            // Calculate revenue per month
            orders.forEach(order => {
                const date = new Date(order.completedDate);
                const key = date.toLocaleDateString('en-US', { month: 'short' });
                if (monthlyRevenue.hasOwnProperty(key)) {
                    monthlyRevenue[key] += order.value || 0;
                }
            });

            // Find max value for scaling
            const maxRevenue = Math.max(...Object.values(monthlyRevenue), 1);

            // Generate chart bars
            chartEl.innerHTML = Object.entries(monthlyRevenue).map(([month, revenue]) => {
                const height = (revenue / maxRevenue) * 100;
                return `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                        <div style="background: linear-gradient(to top, #22c55e 0%, #16a34a 50%);
                                    width: 100%; height: ${height}%; margin-bottom: 8px;
                                    border-radius: 4px 4px 0 0; position: relative; min-height: 4px;">
                            <span style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
                                       font-size: 10px; color: var(--text-muted); white-space: nowrap;">
                                $${revenue.toFixed(0)}
                            </span>
                        </div>
                        <span style="font-size: 11px; color: var(--text-primary); font-weight: 600;">${month}</span>
                    </div>
                `;
            }).join('');
        }

        // Filter completed orders by time period
        window.filterCompletedOrders = async function() {
            const filter = document.getElementById('completedTimeFilter').value;
            await loadCompletedOrders(); // For now, just reload all
            // TODO: Implement actual filtering by date range
        };

        // Export completed orders report
        window.exportCompletedOrders = function() {
            showNotification('üìä Generating report...', 'info');
            // TODO: Implement CSV export
            setTimeout(() => {
                showNotification('‚úÖ Report exported successfully', 'success');
            }, 1000);
        };

        // Generate invoices for completed orders
        window.generateInvoices = function() {
            showNotification('üìÑ Generating invoices...', 'info');
            // TODO: Implement invoice generation
            setTimeout(() => {
                showNotification('‚úÖ Invoices generated', 'success');
            }, 1000);
        };

        // View order details
        window.viewOrderDetails = function(orderId) {
            showNotification(`Opening order #${orderId.slice(-4)} details...`, 'info');
            // TODO: Implement order details modal
        };

        // ===== INVENTORY MANAGEMENT SYSTEM =====

        // Initialize inventory system
        window.loadInventory = async function() {
            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await authFetch(`${cloudflareUrl}/api/inventory`);

                let inventory = [];
                if (response.ok) {
                    const data = await response.json();
                    inventory = data.inventory || [];
                }

                displayInventoryByCategory(inventory);
                updateInventoryStats(inventory);
                checkLowStock(inventory);

                // Update global inventory for quote calculator
                window.currentInventory = inventory;
            } catch (error) {
                console.error('Error loading inventory:', error);
                displayInventoryByCategory([]);
            }
        };

        // Display inventory by material category
        function displayInventoryByCategory(inventory) {
            // Standard categories with predefined containers
            const standardCategories = ['PLA', 'PETG', 'ABS', 'TPU'];

            // Map material types to their display category
            const getCategoryForMaterial = (materialType) => {
                if (standardCategories.includes(materialType)) return materialType;
                return 'Specialty'; // All other materials go to Specialty
            };

            // Clear all category containers first
            standardCategories.forEach(cat => {
                const container = document.getElementById(cat.toLowerCase() + 'Materials');
                if (container) container.innerHTML = '';
            });
            const specialtyContainer = document.getElementById('specialtyMaterials');
            if (specialtyContainer) specialtyContainer.innerHTML = '';

            // Remove any dynamically created category sections from previous loads
            document.querySelectorAll('[data-dynamic-category]').forEach(el => el.remove());

            // Group inventory by display category
            const groupedInventory = {};
            inventory.forEach(item => {
                const category = getCategoryForMaterial(item.material_type);
                if (!groupedInventory[category]) {
                    groupedInventory[category] = [];
                }
                groupedInventory[category].push(item);
            });

            // Display standard categories
            standardCategories.forEach(category => {
                const container = document.getElementById(category.toLowerCase() + 'Materials');
                if (!container) return;

                const categoryItems = groupedInventory[category] || [];
                if (categoryItems.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 20px;">No materials in this category</div>';
                } else {
                    container.innerHTML = categoryItems.map(item => createMaterialCard(item)).join('');
                }
            });

            // Display specialty materials (includes CF-Nylon, Nylon, Wood, Metal, PEEK, PVA, HIPS, etc.)
            const specialtyItems = groupedInventory['Specialty'] || [];
            if (specialtyContainer) {
                if (specialtyItems.length === 0) {
                    specialtyContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 20px;">No materials in this category</div>';
                } else {
                    // Group specialty items by their actual type for better display
                    const specialtyByType = {};
                    specialtyItems.forEach(item => {
                        if (!specialtyByType[item.material_type]) {
                            specialtyByType[item.material_type] = [];
                        }
                        specialtyByType[item.material_type].push(item);
                    });

                    // Create sub-sections for each specialty type
                    let specialtyHTML = '';
                    Object.keys(specialtyByType).sort().forEach(type => {
                        const typeItems = specialtyByType[type];
                        const typeLabel = type === 'CF-Nylon' ? 'Carbon Fiber Nylon' : type;
                        specialtyHTML += `
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">${typeLabel}</div>
                                ${typeItems.map(item => createMaterialCard(item)).join('')}
                            </div>
                        `;
                    });
                    specialtyContainer.innerHTML = specialtyHTML;
                }
            }
        }

        // Create material card HTML
        function createMaterialCard(material) {
            const currentWeight = material.quantity_kg || 0;
            // Assume standard spool is 1kg, show percentage remaining
            const maxWeight = 1.0; // Standard 1kg spool
            const percentageRemaining = maxWeight > 0 ? (currentWeight / maxWeight * 100) : 0;
            const isLowStock = currentWeight <= 0.2; // Low stock threshold at 0.2kg

            return `
                <div class="card" style="padding: 12px; margin-bottom: 8px; ${isLowStock ? 'border: 1px solid #ef4444; background: rgba(239, 68, 68, 0.05);' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${material.color} ${material.material_type}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">$${material.price_per_kg}/kg</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: var(--text-secondary);">${currentWeight.toFixed(2)}kg</div>
                            ${isLowStock ? '<div style="font-size: 10px; color: #ef4444; font-weight: 600;">LOW STOCK</div>' : ''}
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; margin-bottom: 8px;">
                        <div style="height: 100%; background: ${isLowStock ? '#ef4444' : '#22c55e'}; width: ${Math.max(0, Math.min(100, percentageRemaining))}%; border-radius: 3px; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 10px; color: var(--text-muted);">${material.supplier || 'Bambu labs'}</div>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="restockMaterial(${material.id})" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 2px 6px; border-radius: 3px; font-size: 9px; cursor: pointer;">Restock</button>
                            <button onclick="deleteMaterial(${material.id})" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 2px 6px; border-radius: 3px; font-size: 9px; cursor: pointer;">Delete</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update inventory statistics
        function updateInventoryStats(inventory) {
            const totalMaterials = inventory.length;
            const lowStockItems = inventory.filter(item => item.quantity_kg <= 0.2).length; // Low stock at 0.2kg
            const totalValue = inventory.reduce((sum, item) => sum + (item.quantity_kg * item.price_per_kg), 0);

            // Calculate by material type
            const materialTypes = {};
            inventory.forEach(item => {
                if (!materialTypes[item.material_type]) {
                    materialTypes[item.material_type] = {
                        count: 0,
                        totalKg: 0,
                        colors: new Set()
                    };
                }
                materialTypes[item.material_type].count++;
                materialTypes[item.material_type].totalKg += item.quantity_kg;
                materialTypes[item.material_type].colors.add(item.color);
            });

            // Update display
            const totalMaterialsEl = document.getElementById('totalMaterialsCount');
            const lowStockEl = document.getElementById('lowStockCount');
            const totalValueEl = document.getElementById('totalInventoryValue');

            if (totalMaterialsEl) totalMaterialsEl.textContent = totalMaterials;
            if (lowStockEl) lowStockEl.textContent = lowStockItems;
            if (totalValueEl) totalValueEl.textContent = `$${totalValue.toFixed(2)}`;

            // Display material type summary
            const summaryEl = document.getElementById('inventorySummary');
            if (summaryEl) {
                const summaryHTML = Object.entries(materialTypes).map(([type, data]) => `
                    <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 6px;">
                        <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">${type}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ${data.totalKg.toFixed(2)}kg total ‚Ä¢ ${data.colors.size} color${data.colors.size !== 1 ? 's' : ''}
                        </div>
                    </div>
                `).join('');
                summaryEl.innerHTML = summaryHTML || '<div style="color: var(--text-muted); text-align: center;">No inventory data</div>';
            }
        }

        // Check and display low stock alerts
        function checkLowStock(inventory) {
            const lowStockItems = inventory.filter(item => item.quantity_kg <= 0.2);
            const alertContainer = document.getElementById('lowStockAlerts');
            const alertList = document.getElementById('lowStockList');

            if (lowStockItems.length === 0) {
                alertContainer.style.display = 'none';
                return;
            }

            alertContainer.style.display = 'block';
            alertList.innerHTML = lowStockItems.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; margin-bottom: 4px;">
                    <span style="font-size: 13px;">${item.color} ${item.type} - ${item.currentWeight}kg remaining</span>
                    <button onclick="restockMaterial(${item.id})" style="background: #22c55e; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">Restock</button>
                </div>
            `).join('');
        }

        // Show add material modal
        window.showAddMaterialModal = function() {
            document.getElementById('addMaterialModal').style.display = 'block';
        };

        // Close add material modal
        window.closeAddMaterialModal = function() {
            document.getElementById('addMaterialModal').style.display = 'none';
            document.getElementById('addMaterialForm').reset();
        };

        // Add material to specific category
        window.addMaterialToCategory = function(category) {
            const typeSelect = document.getElementById('newMaterialType');
            // For 'Specialty', default to first specialty option (CF-Nylon)
            if (category === 'Specialty') {
                typeSelect.value = 'CF-Nylon';
            } else {
                typeSelect.value = category;
            }
            showAddMaterialModal();
        };

        // Save new material
        window.saveNewMaterial = async function() {
            const type = document.getElementById('newMaterialType').value;
            const color = document.getElementById('newMaterialColor').value.trim();
            const weight = parseFloat(document.getElementById('newMaterialWeight').value);
            const cost = parseFloat(document.getElementById('newMaterialCost').value);
            const supplier = document.getElementById('newMaterialSupplier')?.value || '';

            if (!type || !color || !weight || !cost) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await authFetch(`${cloudflareUrl}/api/inventory`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        material_type: type,
                        color: color,
                        quantity_kg: weight,
                        price_per_kg: cost,
                        supplier: supplier
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to add material');
                }

                closeAddMaterialModal();
                await loadInventory();
                showNotification(`‚úÖ ${color} ${type} added to inventory`, 'success');
            } catch (error) {
                console.error('Error adding material:', error);
                showNotification('‚ùå Failed to add material', 'error');
            }
        };

        // Use material
        window.useMaterial = async function(materialId) {
            const amount = parseFloat(prompt('Enter amount to use (kg):'));
            if (!amount || amount <= 0) return;

            try {
                const cloudflareUrl = getCloudflareUrl();

                // Get current material data
                const response = await authFetch(`${cloudflareUrl}/api/inventory/${materialId}`);
                if (!response.ok) {
                    throw new Error('Material not found');
                }
                const material = await response.json();

                // Check if we have enough
                if (amount > material.quantity_kg) {
                    showNotification(`‚ùå Not enough material. Only ${material.quantity_kg}kg available.`, 'error');
                    return;
                }

                // Update material quantity
                const updateResponse = await authFetch(`${cloudflareUrl}/api/inventory/${materialId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...material,
                        quantity_kg: material.quantity_kg - amount
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error('Failed to update material');
                }

                await loadInventory();
                showNotification(`‚úÖ Used ${amount}kg of ${material.color} ${material.material_type}`, 'success');
            } catch (error) {
                console.error('Error using material:', error);
                showNotification('‚ùå Failed to use material', 'error');
            }
        };

        window.restockMaterial = async function(materialId) {
            const amount = parseFloat(prompt('Enter amount to restock (kg):'));
            if (!amount || amount <= 0) return;

            try {
                const cloudflareUrl = getCloudflareUrl();

                // Get current material data
                const response = await fetch(`${cloudflareUrl}/api/inventory/${materialId}`);
                if (!response.ok) {
                    throw new Error('Material not found');
                }
                const material = await response.json();

                // Update material quantity
                const updateResponse = await fetch(`${cloudflareUrl}/api/inventory/${materialId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...material,
                        quantity_kg: material.quantity_kg + amount
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error('Failed to update material');
                }

                await loadInventory();
                showNotification(`‚úÖ Restocked ${amount}kg of ${material.color} ${material.material_type}`, 'success');
            } catch (error) {
                console.error('Error restocking material:', error);
                showNotification('‚ùå Failed to restock material', 'error');
            }
        };

        // Delete material from Cloudflare
        window.deleteMaterial = async function(materialId) {
            if (!confirm('Are you sure you want to delete this material?')) return;

            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await authFetch(`${cloudflareUrl}/api/inventory/${materialId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete material');
                }

                await loadInventory();
                showNotification('‚úÖ Material deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting material:', error);
                showNotification('‚ùå Failed to delete material', 'error');
            }
        };

        // Restock material via Cloudflare
        window.restockMaterial = async function(materialId) {
            const amount = parseFloat(prompt('Enter amount to restock (kg):'));
            if (!amount || amount <= 0) return;

            try {
                const cloudflareUrl = getCloudflareUrl();

                // Get current material data
                const response = await authFetch(`${cloudflareUrl}/api/inventory/${materialId}`);
                if (!response.ok) {
                    throw new Error('Material not found');
                }
                const material = await response.json();

                // Update material quantity
                const updateResponse = await authFetch(`${cloudflareUrl}/api/inventory/${materialId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...material,
                        quantity_kg: material.quantity_kg + amount
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error('Failed to update material');
                }

                await loadInventory();
                showNotification(`‚úÖ Restocked ${amount}kg of ${material.color} ${material.material_type}`, 'success');
            } catch (error) {
                console.error('Error restocking material:', error);
                showNotification('‚ùå Failed to restock material', 'error');
            }
        };

        // Generate inventory report
        window.generateInventoryReport = function() {
            const inventory = window.currentInventory || [];
            if (inventory.length === 0) {
                showNotification('No inventory data to export', 'error');
                return;
            }

            const reportData = inventory.map(item => ({
                Type: item.material_type,
                Color: item.color,
                'Current Weight (kg)': item.quantity_kg,
                'Cost per kg': `$${item.price_per_kg}`,
                'Total Value': `$${(item.quantity_kg * item.price_per_kg).toFixed(2)}`,
                'Supplier': item.supplier || 'N/A',
                'Status': item.quantity_kg <= 0.2 ? 'LOW STOCK' : 'IN STOCK'
            }));

            const csv = convertToCSV(reportData);
            downloadCSV(csv, `inventory_report_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification('Inventory report generated', 'success');
        };

        // ===== DASHBOARD SYSTEM =====

        // Load dashboard with real data
        window.loadDashboard = async function() {
            try {
                const cloudflareUrl = getCloudflareUrl();

                // Fetch all data in parallel
                const [ordersResponse, inquiriesResponse, printersResponse] = await Promise.all([
                    authFetch(`${cloudflareUrl}/api/orders`),
                    authFetch(`${cloudflareUrl}/api/inquiries`),
                    authFetch(`${cloudflareUrl}/api/printers`)
                ]);

                const ordersData = ordersResponse.ok ? await ordersResponse.json() : { orders: [] };
                const inquiriesData = inquiriesResponse.ok ? await inquiriesResponse.json() : { inquiries: [] };
                const printersData = printersResponse.ok ? await printersResponse.json() : { printers: [] };

                const orders = ordersData.orders || [];
                const inquiries = inquiriesData.inquiries || [];
                const printers = printersData.printers || [];

                // Calculate metrics
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Daily revenue (from completed orders today)
                const todayRevenue = orders
                    .filter(o => {
                        const orderDate = new Date(o.order_date || o.created_at);
                        orderDate.setHours(0, 0, 0, 0);
                        return orderDate.getTime() === today.getTime() && (o.status === 'completed' || o.status === 'shipped');
                    })
                    .reduce((sum, o) => sum + (parseFloat(o.total_amount) || 0), 0);

                // Yesterday's revenue for comparison
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayRevenue = orders
                    .filter(o => {
                        const orderDate = new Date(o.order_date || o.created_at);
                        orderDate.setHours(0, 0, 0, 0);
                        return orderDate.getTime() === yesterday.getTime() && (o.status === 'completed' || o.status === 'shipped');
                    })
                    .reduce((sum, o) => sum + (parseFloat(o.total_amount) || 0), 0);

                // Active orders (pending, ready, printing)
                const activeOrders = orders.filter(o => o.status === 'pending' || o.status === 'ready' || o.status === 'printing');
                const urgentOrders = activeOrders.filter(o => {
                    const dueDate = new Date(o.estimated_completion || o.due_date);
                    return dueDate <= new Date(Date.now() + 24 * 60 * 60 * 1000); // Due within 24 hours
                });

                // Printer fleet status
                const printingPrinters = printers.filter(p => p.status === 'printing').length;
                const availablePrinters = printers.filter(p => p.status === 'idle' || p.status === 'online').length;

                // Customer messages (pending inquiries)
                const pendingInquiries = inquiries.filter(i => i.status === 'pending').length;

                // Update dashboard UI
                updateDashboardMetrics({
                    dailyRevenue: todayRevenue,
                    revenueChange: todayRevenue - yesterdayRevenue,
                    revenuePercentChange: yesterdayRevenue > 0 ? ((todayRevenue - yesterdayRevenue) / yesterdayRevenue * 100) : 0,
                    activeOrdersCount: activeOrders.length,
                    urgentOrdersCount: urgentOrders.length,
                    totalPrinters: printers.length,
                    printingPrinters: printingPrinters,
                    availablePrinters: availablePrinters,
                    pendingMessages: pendingInquiries,
                    orders: orders
                });

                // Update printer status grid
                updatePrinterStatusGrid(printers, orders);

                // Update revenue chart with real data
                updateRevenueChart(orders);

                // Update business metrics charts with real data
                updateMaterialUsageChart();
                updatePopularColorsChart();
                updateOrderStatusChart(orders);

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        };

        // Update Material Usage Chart with real inventory data
        function updateMaterialUsageChart() {
            const container = document.getElementById('materialUsageChart');
            if (!container) return;

            const inventory = window.currentInventory || [];

            if (inventory.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 12px; text-align: center;">No inventory data yet. Add materials in the Inventory tab.</p>';
                return;
            }

            // Group by material type and sum quantities
            const materialTotals = {};
            let grandTotal = 0;
            inventory.forEach(item => {
                const type = item.material_type || 'Other';
                materialTotals[type] = (materialTotals[type] || 0) + (item.quantity_kg || 0);
                grandTotal += (item.quantity_kg || 0);
            });

            const colors = {
                'PLA': '#22c55e',
                'PETG': '#3b82f6',
                'ABS': '#f59e0b',
                'TPU': '#8b5cf6',
                'Nylon': '#ec4899',
                'CF-Nylon': '#6b7280',
                'Other': '#94a3b8'
            };

            const html = Object.entries(materialTotals)
                .sort((a, b) => b[1] - a[1])
                .map(([type, amount]) => {
                    const percentage = grandTotal > 0 ? (amount / grandTotal * 100) : 0;
                    const color = colors[type] || '#94a3b8';
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 13px;">${type}</span>
                            <div style="flex: 1; margin: 0 12px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                                <div style="height: 100%; width: ${percentage}%; background: ${color}; border-radius: 3px;"></div>
                            </div>
                            <span style="font-size: 11px; color: var(--text-muted);">${amount.toFixed(1)}kg</span>
                        </div>
                    `;
                }).join('');

            container.innerHTML = html || '<p style="color: var(--text-muted); font-size: 12px; text-align: center;">No materials in inventory</p>';
        }

        // Update Popular Colors Chart with real inventory data
        function updatePopularColorsChart() {
            const container = document.getElementById('popularColorsChart');
            if (!container) return;

            const inventory = window.currentInventory || [];

            if (inventory.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 12px; text-align: center; grid-column: 1/-1;">No color data yet</p>';
                return;
            }

            // Group by color and sum quantities
            const colorTotals = {};
            inventory.forEach(item => {
                const color = item.color || 'Unknown';
                colorTotals[color] = (colorTotals[color] || 0) + (item.quantity_kg || 0);
            });

            const colorHex = {
                'Black': '#000000',
                'White': '#ffffff',
                'Red': '#dc2626',
                'Blue': '#2563eb',
                'Green': '#16a34a',
                'Yellow': '#eab308',
                'Orange': '#f97316',
                'Purple': '#9333ea',
                'Pink': '#ec4899',
                'Gray': '#6b7280',
                'Clear': '#e5e7eb'
            };

            const topColors = Object.entries(colorTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const html = topColors.map(([color, amount]) => {
                const hex = colorHex[color] || '#94a3b8';
                const displayAmount = amount >= 1 ? `${amount.toFixed(1)}kg` : `${(amount * 1000).toFixed(0)}g`;
                return `
                    <div style="text-align: center;">
                        <div style="width: 32px; height: 32px; background: ${hex}; border-radius: 50%; margin: 0 auto 4px; border: 2px solid rgba(255,255,255,0.2);"></div>
                        <div style="font-size: 10px; color: var(--text-muted);">${color}</div>
                        <div style="font-size: 9px; color: var(--text-secondary);">${displayAmount}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html || '<p style="color: var(--text-muted); font-size: 12px; text-align: center; grid-column: 1/-1;">No colors in inventory</p>';
        }

        // Update Order Status Chart with real order data
        function updateOrderStatusChart(orders) {
            const container = document.getElementById('orderStatusChart');
            if (!container) return;

            if (!orders || orders.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 12px; text-align: center;">No orders yet</p>';
                return;
            }

            const completed = orders.filter(o => o.status === 'completed' || o.status === 'delivered').length;
            const inProgress = orders.filter(o => o.status === 'printing' || o.status === 'in_progress').length;
            const pending = orders.filter(o => o.status === 'pending' || o.status === 'queued').length;
            const total = orders.length;

            const completedPct = total > 0 ? (completed / total * 100) : 0;
            const inProgressPct = total > 0 ? (inProgress / total * 100) : 0;
            const pendingPct = total > 0 ? (pending / total * 100) : 0;

            container.innerHTML = `
                <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(#22c55e 0% ${completedPct}%, #f59e0b ${completedPct}% ${completedPct + inProgressPct}%, #ef4444 ${completedPct + inProgressPct}% ${completedPct + inProgressPct + pendingPct}%, #6b7280 ${completedPct + inProgressPct + pendingPct}% 100%); position: relative;">
                        <div style="width: 40px; height: 40px; background: var(--bg-card); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></div>
                        <span style="font-size: 12px;">Completed</span>
                    </div>
                    <span style="font-size: 12px; font-weight: 600;">${completed} (${completedPct.toFixed(0)}%)</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;"></div>
                        <span style="font-size: 12px;">In Progress</span>
                    </div>
                    <span style="font-size: 12px; font-weight: 600;">${inProgress} (${inProgressPct.toFixed(0)}%)</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></div>
                        <span style="font-size: 12px;">Pending</span>
                    </div>
                    <span style="font-size: 12px; font-weight: 600;">${pending} (${pendingPct.toFixed(0)}%)</span>
                </div>
            `;
        }

        // Update dashboard metrics UI
        function updateDashboardMetrics(data) {
            // Update Daily Revenue card
            const revenueCard = document.querySelector('#dashboard .card:nth-child(1)');
            if (revenueCard) {
                const revenueValue = revenueCard.querySelector('div[style*="font-size: 32px"]');
                const revenueChange = revenueCard.querySelector('div[style*="font-size: 12px"]');
                const percentBadge = revenueCard.querySelector('div[style*="border-radius: 12px"][style*="font-size: 11px"]');

                if (revenueValue) revenueValue.textContent = `$${data.dailyRevenue.toFixed(2)}`;
                if (revenueChange) {
                    const changeText = data.revenueChange >= 0 ?
                        `$${Math.abs(data.revenueChange).toFixed(2)} above yesterday` :
                        `$${Math.abs(data.revenueChange).toFixed(2)} below yesterday`;
                    revenueChange.textContent = changeText;
                }
                if (percentBadge) {
                    const percentText = data.revenuePercentChange >= 0 ?
                        `+${Math.abs(data.revenuePercentChange).toFixed(0)}% ‚Üó` :
                        `${data.revenuePercentChange.toFixed(0)}% ‚Üò`;
                    percentBadge.textContent = percentText;
                    percentBadge.style.background = data.revenuePercentChange >= 0 ?
                        'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                    percentBadge.style.color = data.revenuePercentChange >= 0 ? '#22c55e' : '#ef4444';
                }
            }

            // Update Active Orders card
            const ordersCard = document.querySelector('#dashboard .card:nth-child(2)');
            if (ordersCard) {
                const ordersValue = ordersCard.querySelector('div[style*="font-size: 32px"]');
                const ordersDetails = ordersCard.querySelector('div[style*="font-size: 12px"]');
                const urgentBadge = ordersCard.querySelector('div[style*="border-radius: 12px"][style*="font-size: 11px"]');

                if (ordersValue) ordersValue.textContent = data.activeOrdersCount;
                if (ordersDetails) ordersDetails.textContent = `${data.urgentOrdersCount} urgent, ${data.activeOrdersCount - data.urgentOrdersCount} in progress`;
                if (urgentBadge) urgentBadge.textContent = `${data.urgentOrdersCount} urgent`;
            }

            // Update Printer Fleet card
            const printersCard = document.querySelector('#dashboard .card:nth-child(3)');
            if (printersCard) {
                const printersValue = printersCard.querySelector('div[style*="font-size: 32px"]');
                const printersDetails = printersCard.querySelector('div[style*="font-size: 12px"]');
                const capacityBadge = printersCard.querySelector('div[style*="border-radius: 12px"][style*="font-size: 11px"]');

                if (printersValue) {
                    printersValue.innerHTML = `${data.printingPrinters}<span style="font-size: 18px; color: var(--text-muted);">/${data.totalPrinters}</span>`;
                }
                if (printersDetails) printersDetails.textContent = `${data.availablePrinters} available, ${data.printingPrinters} printing`;
                if (capacityBadge) {
                    const capacity = data.totalPrinters > 0 ? (data.printingPrinters / data.totalPrinters * 100) : 0;
                    capacityBadge.textContent = `${capacity.toFixed(0)}% capacity`;
                }
            }

            // Update Customer Messages card
            const messagesCard = document.querySelector('#dashboard .card:nth-child(4)');
            if (messagesCard) {
                const messagesValue = messagesCard.querySelector('div[style*="font-size: 32px"]');
                const messagesDetails = messagesCard.querySelector('div[style*="font-size: 12px"]');

                if (messagesValue) messagesValue.textContent = data.pendingMessages;
                if (messagesDetails) messagesDetails.textContent = `${data.pendingMessages} pending inquiries`;
            }
        }

        // Update printer status grid
        function updatePrinterStatusGrid(printers, orders) {
            const grid = document.getElementById('printerStatusGrid');
            if (!grid) return;

            if (printers.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--text-muted);">
                        <div style="font-size: 24px; margin-bottom: 0.5rem;">üñ®Ô∏è</div>
                        <div>No printers added yet. Go to the Printers tab to add your fleet.</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = printers.map(printer => {
                const statusColors = {
                    'printing': { bg: 'rgba(251, 146, 60, 0.1)', color: '#f59e0b', icon: 'üñ®Ô∏è', label: 'Printing' },
                    'idle': { bg: 'rgba(59, 130, 246, 0.1)', color: '#3b82f6', icon: '‚è∏Ô∏è', label: 'Idle' },
                    'online': { bg: 'rgba(34, 197, 94, 0.1)', color: '#22c55e', icon: '‚úÖ', label: 'Online' },
                    'offline': { bg: 'rgba(107, 114, 128, 0.1)', color: '#6b7280', icon: 'üîå', label: 'Offline' },
                    'error': { bg: 'rgba(239, 68, 68, 0.1)', color: '#ef4444', icon: '‚ùå', label: 'Error' }
                };

                const status = statusColors[printer.status] || statusColors['idle'];
                const currentJob = orders.find(o => o.printer_assigned === printer.id && o.status === 'printing');

                return `
                    <div class="card" style="padding: 16px; background: ${status.bg}; border: 1px solid ${status.color}33;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">${printer.name}</div>
                            <div style="font-size: 18px;">${status.icon}</div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">${printer.model || 'Unknown Model'}</div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${status.color};"></div>
                            <span style="font-size: 11px; color: ${status.color}; font-weight: 600;">${status.label}</span>
                        </div>
                        ${currentJob ? `
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-secondary);">
                                <div style="font-size: 11px; color: var(--text-muted);">Current Job:</div>
                                <div style="font-size: 12px; color: var(--text-primary); font-weight: 500;">Order #${currentJob.id.toString().slice(-4)}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Update revenue chart with real data
        function updateRevenueChart(orders) {
            // Calculate revenue for the last 7 days
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const today = new Date();
            const revenues = [];
            let totalRevenue = 0;

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);

                const dayRevenue = orders
                    .filter(o => {
                        const orderDate = new Date(o.order_date || o.created_at);
                        orderDate.setHours(0, 0, 0, 0);
                        return orderDate.getTime() === date.getTime() && (o.status === 'completed' || o.status === 'shipped');
                    })
                    .reduce((sum, o) => sum + (parseFloat(o.total_amount) || 0), 0);

                revenues.push({
                    day: days[date.getDay()],
                    amount: dayRevenue,
                    date: date
                });
                totalRevenue += dayRevenue;
            }

            // Update the revenue total display
            const totalDisplay = document.querySelector('#dashboard div[style*="font-size: 24px"][style*="color: #22c55e"]');
            if (totalDisplay) {
                totalDisplay.textContent = `$${totalRevenue.toFixed(2)} Total`;
            }

            // Update chart bars - find the chart container
            const chartContainer = document.querySelector('#dashboard div[style*="display: flex"][style*="height: 140px"]');
            if (chartContainer && revenues.length > 0) {
                const maxRevenue = Math.max(...revenues.map(r => r.amount), 1); // Avoid division by zero

                chartContainer.innerHTML = revenues.slice(-7).map((data, index) => {
                    const height = maxRevenue > 0 ? (data.amount / maxRevenue * 100) : 0;
                    return `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="background: linear-gradient(to top, #22c55e 0%, #16a34a 50%); width: 100%; height: ${height}%; margin-bottom: 12px; border-radius: 6px 6px 0 0; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);"></div>
                            <span style="font-size: 12px; color: var(--text-primary); font-weight: 600;">${data.day}</span>
                            <span style="font-size: 11px; color: var(--text-muted);">$${data.amount.toFixed(0)}</span>
                        </div>
                    `;
                }).join('');
            }
        }

        // ===== PRINTER MANAGEMENT SYSTEM =====

        // Initialize printers system
        window.loadPrinters = async function() {
            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await fetch(`${cloudflareUrl}/api/printers`);

                let printers = [];
                if (response.ok) {
                    const data = await response.json();
                    printers = data.printers || [];
                }

                displayPrinters(printers);
                updatePrinterStats(printers);
            } catch (error) {
                console.error('Error loading printers:', error);
                displayPrinters([]);
            }
        };

        // Display printers
        function displayPrinters(printers) {
            const printerGrid = document.getElementById('printerGrid');
            const emptyState = document.getElementById('emptyPrintersState');

            if (printers.length === 0) {
                printerGrid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            printerGrid.innerHTML = printers.map(printer => createPrinterCard(printer)).join('');
        }

        // Create printer card
        function createPrinterCard(printer) {
            const statusColors = {
                'online': '#22c55e',
                'printing': '#f59e0b',
                'idle': '#3b82f6',
                'offline': '#6b7280',
                'error': '#ef4444'
            };

            const statusColor = statusColors[printer.status] || '#6b7280';
            const progress = printer.progress || 0;

            return `
                <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">${printer.name}</h3>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">${printer.model}</div>
                        </div>
                        <div style="background: ${statusColor}20; color: ${statusColor}; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; border: 1px solid ${statusColor}40;">
                            ${printer.status.charAt(0).toUpperCase() + printer.status.slice(1)}
                        </div>
                    </div>

                    ${printer.status === 'printing' ? `
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 12px; color: var(--text-secondary);">Current Job: ${printer.currentJob || 'Unknown'}</span>
                                <span style="font-size: 12px; color: var(--text-secondary);">${progress}%</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px;">
                                <div style="height: 100%; background: #f59e0b; width: ${progress}%; border-radius: 3px;"></div>
                            </div>
                        </div>
                    ` : ''}

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; font-size: 12px;">
                        <div>
                            <div style="color: var(--text-muted);">IP Address</div>
                            <div style="color: var(--text-secondary);">${printer.ipAddress || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-muted);">Last Seen</div>
                            <div style="color: var(--text-secondary);">${getTimeAgo(printer.lastSeen)}</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        ${printer.status === 'printing' ? `
                            <button onclick="pausePrinter('${printer.id}')" style="background: rgba(251, 146, 60, 0.1); color: #f59e0b; border: 1px solid rgba(251, 146, 60, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; flex: 1;">‚è∏Ô∏è Pause</button>
                        ` : printer.status === 'idle' || printer.status === 'online' ? `
                            <button onclick="assignJobToPrinter('${printer.id}')" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; flex: 1;">üñ®Ô∏è Assign Job</button>
                        ` : ''}
                        <button onclick="refreshPrinter('${printer.id}')" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">üîÑ</button>
                        <button onclick="deletePrinter('${printer.id}')" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }

        // Update printer statistics
        function updatePrinterStats(printers) {
            const online = printers.filter(p => p.status === 'online' || p.status === 'idle').length;
            const printing = printers.filter(p => p.status === 'printing').length;
            const idle = printers.filter(p => p.status === 'idle').length;
            const errors = printers.filter(p => p.status === 'error' || p.status === 'offline').length;

            document.getElementById('onlinePrintersCount').textContent = online;
            document.getElementById('printingCount').textContent = printing;
            document.getElementById('idlePrintersCount').textContent = idle;
            document.getElementById('errorPrintersCount').textContent = errors;
        }

        // Show add printer modal
        window.showAddPrinterModal = function() {
            document.getElementById('addPrinterModal').style.display = 'block';
        };

        // Close add printer modal
        window.closeAddPrinterModal = function() {
            document.getElementById('addPrinterModal').style.display = 'none';
            document.getElementById('addPrinterForm').reset();
        };

        // Save new printer
        window.saveNewPrinter = async function() {
            const name = document.getElementById('newPrinterName').value.trim();
            const model = document.getElementById('newPrinterModel').value;
            const ipAddress = document.getElementById('newPrinterIP').value.trim();
            const status = document.getElementById('newPrinterStatus').value;

            if (!name || !model) {
                showNotification('Please fill in printer name and model', 'error');
                return;
            }

            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await fetch(`${cloudflareUrl}/api/printers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        model,
                        status,
                        ip_address: ipAddress || null,
                        current_job_id: null,
                        total_print_hours: 0
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to add printer');
                }

                closeAddPrinterModal();
                await loadPrinters();
                showNotification(`${name} added to printer fleet`, 'success');
            } catch (error) {
                console.error('Error adding printer:', error);
                showNotification('‚ùå Failed to add printer', 'error');
            }
        };

        // Populate printer options in order form
        async function populatePrinterOptions() {
            try {
                const cloudflareUrl = getCloudflareUrl();
                const response = await fetch(`${cloudflareUrl}/api/printers`);

                let printers = [];
                if (response.ok) {
                    const data = await response.json();
                    printers = data.printers || [];
                }

                const orderPrinterSelect = document.getElementById('newOrderPrinter');
                if (!orderPrinterSelect) return;

                const availablePrinters = printers.filter(p => p.status === 'idle' || p.status === 'online');
                orderPrinterSelect.innerHTML = '<option value="">No printer assigned</option>' +
                    availablePrinters.map(p => `<option value="${p.id}">${p.name} (${p.model})</option>`).join('');
            } catch (error) {
                console.error('Error populating printer options:', error);
            }
        }

        // Printer actions
        window.pausePrinter = async function(printerId) {
            try {
                const cloudflareUrl = getCloudflareUrl();
                await authFetch(`${cloudflareUrl}/api/printers/${printerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'idle', current_job_id: null })
                });
                await loadPrinters();
                showNotification('Printer paused', 'success');
            } catch (error) {
                console.error('Error pausing printer:', error);
                showNotification('Failed to pause printer', 'error');
            }
        };

        window.assignJobToPrinter = async function(printerId) {
            try {
                const cloudflareUrl = getCloudflareUrl();

                // Fetch pending orders from Cloudflare
                const ordersResponse = await authFetch(`${cloudflareUrl}/api/orders`);
                if (!ordersResponse.ok) throw new Error('Failed to fetch orders');
                const ordersData = await ordersResponse.json();
                const orders = ordersData.orders || [];
                const pendingOrders = orders.filter(o => o.status === 'pending' && !o.printer_assigned);

                if (pendingOrders.length === 0) {
                    showNotification('No pending orders available for assignment', 'info');
                    return;
                }

                // Fetch printer details
                const printerResponse = await fetch(`${cloudflareUrl}/api/printers/${printerId}`);
                if (!printerResponse.ok) throw new Error('Failed to fetch printer');
                const printer = await printerResponse.json();

                const orderToAssign = pendingOrders[0];

                // Update printer status in Cloudflare
                await authFetch(`${cloudflareUrl}/api/printers/${printerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'printing',
                        current_job_id: orderToAssign.id
                    })
                });

                // Update order in Cloudflare
                await authFetch(`${cloudflareUrl}/api/orders/${orderToAssign.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'printing',
                        printer_assigned: printerId
                    })
                });

                await loadPrinters();
                await loadOrders();
                showNotification(`Job assigned to ${printer.name}`, 'success');
            } catch (error) {
                console.error('Error assigning job to printer:', error);
                showNotification('Failed to assign job', 'error');
            }
        };

        window.refreshPrinter = async function(printerId) {
            try {
                const cloudflareUrl = getCloudflareUrl();

                // Fetch current printer data
                const printerResponse = await fetch(`${cloudflareUrl}/api/printers/${printerId}`);
                if (!printerResponse.ok) throw new Error('Failed to fetch printer');
                const printer = await printerResponse.json();

                // Update last_seen timestamp
                await authFetch(`${cloudflareUrl}/api/printers/${printerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        last_maintenance: new Date().toISOString()
                    })
                });

                await loadPrinters();
                showNotification('Printer status refreshed', 'success');
            } catch (error) {
                console.error('Error refreshing printer:', error);
                showNotification('Failed to refresh printer status', 'error');
            }
        };

        window.deletePrinter = async function(printerId) {
            try {
                const cloudflareUrl = getCloudflareUrl();

                // Get printer details first
                const response = await fetch(`${cloudflareUrl}/api/printers/${printerId}`);
                if (!response.ok) {
                    throw new Error('Printer not found');
                }
                const printer = await response.json();

                showConfirmModal(
                    'Delete Printer',
                    `Are you sure you want to remove ${printer.name} from your printer fleet?`,
                    async () => {
                        try {
                            const deleteResponse = await fetch(`${cloudflareUrl}/api/printers/${printerId}`, {
                                method: 'DELETE'
                            });

                            if (!deleteResponse.ok) {
                                throw new Error('Failed to delete printer');
                            }

                            await loadPrinters();
                            showNotification('Printer removed from fleet', 'success');
                        } catch (error) {
                            console.error('Error deleting printer:', error);
                            showNotification('‚ùå Failed to delete printer', 'error');
                        }
                    }
                );
            } catch (error) {
                console.error('Error getting printer details:', error);
                showNotification('‚ùå Failed to get printer details', 'error');
            }
        };

        window.refreshPrinterStatus = function() {
            loadPrinters();
            showNotification('All printer statuses refreshed', 'success');
        };

        // ===== SETTINGS MANAGEMENT SYSTEM =====

        // Initialize settings
        window.loadSettings = function() {
            const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');

            // Populate form fields
            if (settings.companyName) document.getElementById('companyName').value = settings.companyName;
            if (settings.contactEmail) document.getElementById('contactEmail').value = settings.contactEmail;
            if (settings.phoneNumber) document.getElementById('phoneNumber').value = settings.phoneNumber;
            if (settings.businessAddress) document.getElementById('businessAddress').value = settings.businessAddress;
            if (settings.defaultMaterialCost) document.getElementById('defaultMaterialCost').value = settings.defaultMaterialCost;
            if (settings.laborRate) document.getElementById('laborRate').value = settings.laborRate;
            if (settings.printerRate) document.getElementById('printerRate').value = settings.printerRate;
            if (settings.currency) document.getElementById('currency').value = settings.currency;
            if (settings.stlFolder) document.getElementById('stlFolder').value = settings.stlFolder;
            if (settings.exportsFolder) document.getElementById('exportsFolder').value = settings.exportsFolder;
            if (settings.backupFolder) document.getElementById('backupFolder').value = settings.backupFolder;

            // Set checkboxes
            document.getElementById('orderNotifications').checked = settings.orderNotifications !== false;
            document.getElementById('printerNotifications').checked = settings.printerNotifications !== false;
            document.getElementById('lowStockNotifications').checked = settings.lowStockNotifications !== false;
            document.getElementById('dueDateNotifications').checked = settings.dueDateNotifications !== false;
        };

        // Save settings
        window.saveSettings = function() {
            const settings = {
                companyName: document.getElementById('companyName').value,
                contactEmail: document.getElementById('contactEmail').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                businessAddress: document.getElementById('businessAddress').value,
                defaultMaterialCost: document.getElementById('defaultMaterialCost').value,
                laborRate: document.getElementById('laborRate').value,
                printerRate: document.getElementById('printerRate').value,
                currency: document.getElementById('currency').value,
                stlFolder: document.getElementById('stlFolder').value,
                exportsFolder: document.getElementById('exportsFolder').value,
                backupFolder: document.getElementById('backupFolder').value,
                orderNotifications: document.getElementById('orderNotifications').checked,
                printerNotifications: document.getElementById('printerNotifications').checked,
                lowStockNotifications: document.getElementById('lowStockNotifications').checked,
                dueDateNotifications: document.getElementById('dueDateNotifications').checked,
                lastSaved: new Date().toISOString()
            };

            localStorage.setItem('appSettings', JSON.stringify(settings));
            showNotification('Settings saved successfully', 'success');
        };

        // Export settings
        window.exportSettings = function() {
            const allData = {
                settings: JSON.parse(localStorage.getItem('appSettings') || '{}'),
                inquiries: JSON.parse(localStorage.getItem('inquiries') || '[]'),
                orders: JSON.parse(localStorage.getItem('orders') || '[]'),
                inventory: JSON.parse(localStorage.getItem('inventory') || '[]'),
                printers: JSON.parse(localStorage.getItem('printers') || '[]'),
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `3d_print_manager_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showNotification('Settings and data exported successfully', 'success');
        };

        // Import settings
        window.importSettings = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);

                        if (data.settings) localStorage.setItem('appSettings', JSON.stringify(data.settings));
                        if (data.inquiries) localStorage.setItem('inquiries', JSON.stringify(data.inquiries));
                        if (data.orders) localStorage.setItem('orders', JSON.stringify(data.orders));
                        if (data.inventory) localStorage.setItem('inventory', JSON.stringify(data.inventory));
                        if (data.printers) localStorage.setItem('printers', JSON.stringify(data.printers));

                        showNotification('Settings and data imported successfully', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } catch (error) {
                        showNotification('Invalid backup file format', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        // Other settings functions
        window.testCloudConnection = function() {
            showNotification('Testing cloud connection... (simulation)', 'info');
            setTimeout(() => {
                showNotification('Cloud connection test completed', 'success');
            }, 2000);
        };

        window.createBackup = function() {
            exportSettings(); // Use the same export functionality
        };

        window.restoreBackup = function() {
            importSettings(); // Use the same import functionality
        };

        window.resetAllData = function() {
            showConfirmModal(
                'Reset All Data',
                'Are you sure you want to reset ALL application data? This action cannot be undone!',
                () => {
                    localStorage.clear();
                    showNotification('All data has been reset', 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            );
        };

        // ===== UTILITY FUNCTIONS =====

        // Get time ago helper
        function getTimeAgo(dateString) {
            if (!dateString) return 'Never';
            const now = new Date();
            const date = new Date(dateString);
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        // Convert to CSV
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';

            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');
            const csvRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                }).join(',');
            });

            return [csvHeaders, ...csvRows].join('\n');
        }

        // Download CSV
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Update page load initialization
        document.addEventListener('DOMContentLoaded', async function() {
            initializeCalculator();

            // Wait for auth check to complete first
            await checkAuth();

            // Only load data if authenticated
            if (currentUser) {
                // Load inventory first so quote calculator has prices
                await loadInventory();

                loadDashboard();
                loadInquiries();
                loadOrders();
                loadPrinters();
                loadSettings();

                // Initialize default data if empty
                initializeDefaultData();

                // Check Cloudflare connection
                await checkCloudflareConnection();

                // Update the Cloudflare usage bar with current stats
                await updateCloudflareUsageBar();

                // Trigger initial material price and color update
                updateMaterialPrice();
                updateColorOptions();
            }
        });

        // Initialize default data - NO SAMPLE DATA
        function initializeDefaultData() {
            // Clear any old localStorage sample data
            localStorage.removeItem('inventory');
            // All data comes from Cloudflare now - no sample data
        }

        // File upload handling for quote calculator
        window.uploadedFiles = [];
        window.pendingFiles = []; // Store files to upload later

        // Global file storage for inquiries
        window.globalFileStorage = window.globalFileStorage || {};

        // New function to upload files to Cloudflare with loading bar
        async function uploadFilesToCloudflare() {
            console.log('uploadFilesToCloudflare called');
            console.log('pendingFiles:', window.pendingFiles);

            if (!window.pendingFiles || window.pendingFiles.length === 0) {
                console.log('No pending files to upload');
                return { success: true, files: [] };
            }

            console.log('Found', window.pendingFiles.length, 'files to upload');

            // Show loading bar
            const loadingBar = document.createElement('div');
            loadingBar.id = 'uploadLoadingBar';
            loadingBar.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000;
                    background: #2a2a2a; border: 1px solid #3b82f6; border-radius: 12px; padding: 24px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
                    <div style="color: #e5e7eb; font-size: 16px; margin-bottom: 12px;">‚òÅÔ∏è Uploading to Cloudflare...</div>
                    <div style="width: 300px; height: 8px; background: #374151; border-radius: 4px; overflow: hidden;">
                        <div style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #22c55e);
                            border-radius: 4px; transition: width 0.3s ease; animation: progress 2s ease-in-out infinite;"
                            id="uploadProgress"></div>
                    </div>
                    <div style="color: #9ca3af; font-size: 12px; margin-top: 8px; text-align: center;"
                        id="uploadStatus">Preparing upload...</div>
                </div>
                <style>
                    @keyframes progress {
                        0% { width: 0%; }
                        50% { width: 70%; }
                        100% { width: 100%; }
                    }
                </style>
            `;
            document.body.appendChild(loadingBar);

            const cloudflareWorkerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'https://etsy-3d-print-api.royal-bush-a056.workers.dev';
            const formData = new FormData();

            console.log('Creating FormData with files:');
            for (let file of window.pendingFiles) {
                console.log('Adding file to FormData:', {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    isFile: file instanceof File
                });
                formData.append('files', file);
            }

            try {
                // Update status
                document.getElementById('uploadStatus').textContent = `Uploading ${window.pendingFiles.length} file(s)...`;

                console.log('Attempting upload to:', `${cloudflareWorkerUrl}/api/upload`);
                console.log('Files to upload:', window.pendingFiles.length);

                const response = await fetch(`${cloudflareWorkerUrl}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                console.log('Upload response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Upload failed with status:', response.status, 'Error:', errorText);
                    throw new Error(`Upload failed: ${response.status} - ${errorText || response.statusText}`);
                }

                const result = await response.json();

                // Update progress to 100%
                document.getElementById('uploadProgress').style.width = '100%';
                document.getElementById('uploadStatus').textContent = 'Upload complete!';

                // Update storage display - use the correct function name
                if (typeof updateCloudflareUsageBar === 'function') {
                    await updateCloudflareUsageBar();
                }

                // Clear pending files
                window.pendingFiles = [];
                window.uploadedFiles = result.files || [];

                // Remove loading bar on success
                setTimeout(() => {
                    if (document.body.contains(loadingBar)) {
                        document.body.removeChild(loadingBar);
                    }
                }, 1000);

                return { success: true, files: result.files || [] };
            } catch (error) {
                console.error('Upload error details:', {
                    message: error.message,
                    stack: error.stack,
                    error: error
                });

                // Show error in loading bar
                document.getElementById('uploadStatus').textContent = `Upload failed: ${error.message}`;

                setTimeout(() => {
                    if (document.body.contains(loadingBar)) {
                        document.body.removeChild(loadingBar);
                    }
                }, 3000);

                showNotification(`Upload failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function handleFileUpload(event) {
            const files = Array.from(event.target.files);

            if (files.length === 0) {
                showNotification('‚ùå No files selected', 'error');
                return;
            }

            console.log('Files selected for later upload:', files.map(f => f.name));

            // Store files for later upload (don't upload immediately)
            window.pendingFiles = files;

            // Display files locally without uploading yet
            window.uploadedFiles = window.pendingFiles.map((file, index) => ({
                id: Date.now() + index,
                name: file.name,
                size: file.size,
                type: file.type,
                pending: true // Mark as not uploaded yet
            }));

            displayUploadedFiles();
            showNotification(`üìÅ ${files.length} file(s) ready to upload when saving`, 'info');

            // Store globally for inquiry access (but mark as pending)
            const currentTimestamp = Date.now();
            window.globalFileStorage[currentTimestamp] = window.uploadedFiles;
            window.currentFileSession = currentTimestamp;

            console.log('üìÅ Files ready for upload:', window.uploadedFiles);

            // Auto-estimate weight for STL files
            const stlFile = files.find(f => f.name.toLowerCase().endsWith('.stl'));
            if (stlFile) {
                const estimatedWeight = Math.round(stlFile.size / 10000);
                if (estimatedWeight > 0) {
                    const weightInput = document.getElementById('materialWeight');
                    if (weightInput && !weightInput.value) {
                        weightInput.value = estimatedWeight;
                        calculateQuote();
                        showNotification(`üìä Auto-estimated weight: ${estimatedWeight}g from STL`, 'info');
                    }
                }
            }
        }

        function displayUploadedFiles() {
            const fileDisplay = document.getElementById('fileDisplay');
            const fileList = document.getElementById('fileList');

            if (!fileDisplay || !fileList) {
                console.warn('File display elements not found');
                return;
            }

            if (window.uploadedFiles.length === 0) {
                fileDisplay.style.display = 'none';
                return;
            }

            fileDisplay.style.display = 'block';
            fileList.innerHTML = window.uploadedFiles.map(file => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(34, 197, 94, 0.1); border-radius: 6px; border: 1px solid rgba(34, 197, 94, 0.2); margin-bottom: 6px;">
                    <div>
                        <span style="color: #22c55e; font-weight: 600;">üìÑ ${file.name}</span>
                        <span style="color: var(--text-muted); margin-left: 8px;">(${(file.size/1024).toFixed(1)}KB)</span>
                    </div>
                    <button onclick="removeUploadedFile(${file.id})" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 16px; padding: 4px;">√ó</button>
                </div>
            `).join('');

            console.log('‚úÖ Displayed', window.uploadedFiles.length, 'uploaded files');
        }

        function removeUploadedFile(fileId) {
            window.uploadedFiles = window.uploadedFiles.filter(f => f.id !== fileId);
            displayUploadedFiles();
            showNotification('üìÅ File removed', 'info');
        }

        // Save quote to inquiries with server sync
        async function saveToInquiries() {
            const customerName = document.getElementById('customerName')?.value || '';
            const customerEmail = document.getElementById('customerEmail')?.value || '';

            if (!customerName) {
                showNotification('‚ùå Please enter customer name', 'error');
                return;
            }

            // Make sure we have uploaded files
            console.log('Current uploaded files:', window.uploadedFiles);

            const materialWeight = document.getElementById('materialWeight')?.value || 0;
            const printTime = document.getElementById('printTime')?.value || 0;
            const totalQuote = document.getElementById('totalQuote')?.textContent || '$0.00';

            const inquiryId = Date.now();

            // Create inquiry with proper file data including server references
            const inquiry = {
                id: inquiryId,
                timestamp: new Date().toISOString(),
                date: new Date().toISOString(),
                customerName: customerName,
                customerEmail: customerEmail,
                materialWeight: materialWeight,
                printTime: printTime,
                materialType: document.getElementById('materialType')?.value || 'PLA',
                material: document.getElementById('materialType')?.value || 'PLA',
                totalQuote: totalQuote,
                status: 'pending',
                files: window.uploadedFiles.map(f => ({
                    name: f.name,
                    size: f.size,
                    type: f.type,
                    id: f.id,
                    serverFilename: f.serverFilename, // Server filename for downloads
                    serverPath: f.serverPath,
                    hasData: true
                })),
                hasFiles: window.uploadedFiles.length > 0,
                fileName: window.uploadedFiles.length > 0 ? uploadedFiles[0].name : null
            };

            console.log('üíæ Saving inquiry with server files:', {
                customer: customerName,
                hasFiles: inquiry.hasFiles,
                fileCount: inquiry.files.length,
                fileNames: inquiry.files.map(f => f.name),
                serverFiles: inquiry.files.map(f => f.serverFilename)
            });

            // Save to server first
            try {
                const response = await fetch('/api/inquiries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(inquiry)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Inquiry saved to server:', result);

                    // Successfully saved to Cloudflare (no localStorage backup)

                    showNotification(`‚úÖ Quote for ${customerName} saved with ${inquiry.files.length} 3D file(s)!`, 'success');

                    // Clear form and refresh
                    clearFormAndRefresh();

                    // Reload inquiries to show the new one
                    loadInquiries();
                } else {
                    throw new Error('Failed to save to server');
                }
            } catch (error) {
                console.error('Save error:', error);

                // Fallback to local storage
                let inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
                inquiries.push(inquiry);
                localStorage.setItem('inquiries', JSON.stringify(inquiries));

                showNotification(`‚úÖ Quote saved locally for ${customerName}`, 'success');
                clearFormAndRefresh();
            }
        }

        function clearFormAndRefresh() {
            // Clear form but don't lose file references
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';

            // Clear uploaded files for next inquiry
            window.uploadedFiles = [];
            displayUploadedFiles();

            // Refresh inquiries to show the new one
            setTimeout(() => {
                loadInquiries();
            }, 500);
        }

        // Download files from inquiry - download actual 3D files from Cloudflare
        async function downloadInquiryFiles(inquiryId) {
            console.log('üîç Downloading 3D files for inquiry:', inquiryId);

            // Fetch inquiry from Cloudflare, not localStorage
            const cloudflareUrl = getCloudflareUrl();
            let inquiry = null;

            try {
                const response = await fetch(`${cloudflareUrl}/api/inquiries/${inquiryId}`);
                if (response.ok) {
                    const inquiryData = await response.json();

                    // Convert Cloudflare format if needed
                    inquiry = {
                        id: inquiryData.id,
                        customerName: inquiryData.customer_name,
                        customerEmail: inquiryData.customer_email,
                        files: inquiryData.files || [],
                        hasFiles: (inquiryData.files || []).length > 0
                    };
                } else {
                    console.error('Failed to fetch inquiry from Cloudflare:', response.status);
                    showNotification('‚ùå Could not fetch inquiry from cloud', 'error');
                    return;
                }
            } catch (error) {
                console.error('Error fetching inquiry:', error);
                showNotification('‚ùå Error loading inquiry', 'error');
                return;
            }

            if (!inquiry) {
                console.error('Inquiry not found:', inquiryId);
                showNotification('‚ùå Inquiry not found', 'error');
                return;
            }

            console.log('Found inquiry:', inquiry);
            console.log('Inquiry files:', inquiry.files);
            console.log('Has files flag:', inquiry.hasFiles);

            // Check if inquiry has files
            if (!inquiry.files || inquiry.files.length === 0) {
                console.error('No files in inquiry:', inquiry);
                showNotification('‚ö†Ô∏è No 3D files attached to this inquiry', 'warning');
                return;
            }

            console.log('Files to download:', inquiry.files);

            // Download files from server
            try {
                let downloadCount = 0;

                for (const file of inquiry.files) {
                    console.log('Processing file:', file);

                    // Check if file has server reference (could be serverFilename, cloudflareKey, key, or file_key)
                    const fileKey = file.serverFilename || file.cloudflareKey || file.key || file.file_key;
                    const fileName = file.name || file.original_name || file.originalName || 'download.stl';

                    if (fileKey) {
                        console.log('Downloading file with key:', fileKey);

                        // Try Cloudflare first if it has cloudflare key
                        if (file.cloudflareKey || file.key || file.file_key) {
                            // Check if this is an old file without proper R2 upload
                            if (fileKey.startsWith('FILE-') && !fileKey.includes('uploads/')) {
                                console.warn(`File ${fileName} was not properly uploaded to R2 storage`);
                                showNotification('‚ö†Ô∏è This file needs to be re-uploaded (old format)', 'warning');
                                continue;
                            }

                            const cloudflareUrl = getCloudflareUrl();
                            const response = await fetch(`${cloudflareUrl}/api/download/${fileKey}`);

                            if (response.ok) {
                                const blob = await response.blob();
                                const url = URL.createObjectURL(blob);
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = fileName; // Use original filename
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                                downloadCount++;
                                console.log('‚úÖ Downloaded 3D file:', fileName);
                            } else {
                                // Fallback to server endpoint
                                const serverResponse = await fetch(`/api/download-inquiry-file/${fileKey}`);
                                if (serverResponse.ok) {
                                    const blob = await serverResponse.blob();
                                    const url = URL.createObjectURL(blob);
                                    const link = document.createElement('a');
                                    link.href = url;
                                    link.download = fileName;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    URL.revokeObjectURL(url);
                                    downloadCount++;
                                    console.log('‚úÖ Downloaded 3D file from server:', fileName);
                                } else {
                                    console.warn(`Failed to download ${fileName}`);
                                }
                            }
                        } else {
                            // Try server endpoint directly for serverFilename
                            const response = await fetch(`/api/download-inquiry-file/${fileKey}`);
                            if (response.ok) {
                                const blob = await response.blob();
                                const url = URL.createObjectURL(blob);
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = fileName;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                                downloadCount++;
                                console.log('‚úÖ Downloaded 3D file:', fileName);
                            } else {
                                console.warn(`Failed to download ${fileName} from server`);
                            }
                        }
                    } else {
                        console.warn(`No file reference for ${fileName}`);
                    }
                }

                if (downloadCount > 0) {
                    showNotification(`‚úÖ Downloaded ${downloadCount} 3D file(s)`, 'success');
                } else {
                    showNotification('‚ö†Ô∏è No files could be downloaded - please re-upload', 'warning');
                }
            } catch (error) {
                console.error('Download error:', error);
                showNotification('‚ùå Error downloading 3D files', 'error');
            }
        }

        // Handle file upload for edit modal
        window.handleEditFileUpload = function(event) {
            const files = Array.from(event.target.files);

            if (files.length === 0) {
                showNotification('‚ùå No files selected', 'error');
                return;
            }

            // Store files for later upload
            window.editSelectedFiles = files;

            // Display selected files
            const editFileDisplay = document.getElementById('editFileDisplay');
            editFileDisplay.innerHTML = `
                <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-primary);">
                    <div style="color: var(--accent-green); font-size: 12px; margin-bottom: 8px;">‚úÖ New files selected for upload:</div>
                    ${files.map(file => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px; background: var(--bg-primary); border-radius: 4px; margin-bottom: 4px;">
                            <span style="color: var(--text-primary); font-size: 12px;">üìÑ ${file.name}</span>
                            <span style="color: var(--text-muted); font-size: 11px;">${(file.size / 1024).toFixed(1)} KB</span>
                        </div>
                    `).join('')}
                </div>
            `;
            editFileDisplay.style.display = 'block';

            showNotification(`‚úÖ ${files.length} file(s) selected`, 'success');
        };

        // Make file upload functions global
        window.handleFileUpload = handleFileUpload;
        window.displayUploadedFiles = displayUploadedFiles;
        window.removeUploadedFile = removeUploadedFile;
        window.saveToInquiries = saveToInquiries;
        window.downloadInquiryFiles = downloadInquiryFiles;

        // Download files for an order (uses the linked inquiry's files)
        window.downloadOrderFiles = function(inquiryId) {
            if (!inquiryId) {
                showNotification('No files attached to this order', 'info');
                return;
            }
            downloadInquiryFiles(inquiryId);
        };

        // Cloudflare connection functions
        async function checkCloudflareStatus() {
            showNotification('üîç Checking Cloudflare status...', 'info');

            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'https://etsy-3d-print-api.royal-bush-a056.workers.dev';
                const response = await fetch(`${workerUrl}/api/sync-status`);
                const result = await response.json();

                if (result.connected) {
                    document.getElementById('cfDatabaseStatus').value = `D1 Connected ‚úÖ (${result.stats.inquiries} inquiries)`;
                    document.getElementById('cfStorageStatus').value = `R2 Active (${result.stats.files} files)`;
                    showNotification('‚úÖ Cloudflare connected!', 'success');
                    return result;
                } else {
                    showNotification('‚ùå Cloudflare connection error', 'error');
                }
            } catch (error) {
                console.error('Cloudflare status error:', error);
                showNotification('‚ùå Error checking Cloudflare status', 'error');
            }
        }

        // Sync data to Cloudflare
        async function syncToCloudflare(type, data) {
            try {
                const response = await fetch('/api/cloudflare/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, data })
                });
                return await response.json();
            } catch (error) {
                console.error('Cloudflare sync error:', error);
                throw error;
            }
        }

        async function syncAllDataToDrive() {
            showNotification('üîÑ Syncing all data to Google Drive...', 'info');

            try {
                const response = await fetch('/api/google/sync-all', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('‚úÖ All data synced to Google Drive', 'success');
                    console.log('‚òÅÔ∏è Sync complete:', result);
                    return true;
                } else {
                    showNotification('‚ö†Ô∏è Some data could not be synced', 'warning');
                    return false;
                }
            } catch (error) {
                console.error('Sync error:', error);
                showNotification('‚ùå Failed to sync to Google Drive', 'error');
                return false;
            }
        }

        function viewCloudflareStats() {
            window.open('https://etsy-3d-print-api.royal-bush-a056.workers.dev/api/sync-status', '_blank');
            showNotification('üìä Opening Cloudflare stats', 'info');
        }

        async function forceSyncNow() {
            await syncAllDataToDrive();
        }

        async function testCloudConnection() {
            showNotification('üß™ Testing Cloudflare connection...', 'info');
            try {
                const response = await fetch('/api/cloudflare/test');
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úÖ Cloudflare test successful!', 'success');
                } else {
                    showNotification('‚ùå Cloudflare test failed', 'error');
                }
            } catch (error) {
                console.error('Test error:', error);
                showNotification('‚ùå Connection test failed', 'error');
            }
        }

        async function forceSyncNow() {
            showNotification('üîÑ Checking Cloudflare connection...', 'info');
            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'https://etsy-3d-print-api.royal-bush-a056.workers.dev';
                const response = await fetch(`${workerUrl}/api/sync-status`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (result.connected) {
                    showNotification('‚úÖ Cloudflare sync successful!', 'success');
                    // Update the UI with the latest stats
                    await updateCloudflareUsageBar();
                    await loadInquiries(); // Refresh inquiries
                } else {
                    showNotification('‚ùå Cloudflare not connected', 'error');
                }
            } catch (error) {
                console.error('Sync error:', error);
                showNotification('‚ùå Sync failed - Check if Cloudflare worker is running', 'error');
            }
        }

        function syncPendingFilesToDrive() {
            const pendingFiles = JSON.parse(localStorage.getItem('pendingDriveFiles') || '[]');

            if (window.pendingFiles.length > 0) {
                showNotification(`‚òÅÔ∏è Syncing ${window.pendingFiles.length} files to Google Drive...`, 'info');

                // In real app, would upload files to Google Drive here
                setTimeout(() => {
                    showNotification(`‚úÖ ${window.pendingFiles.length} files synced to Google Drive`, 'success');
                }, 3000);
            }
        }

        // Make Google Drive functions global
        window.checkCloudflareStatus = checkCloudflareStatus;
        window.syncToCloudflare = syncToCloudflare;
        window.viewCloudflareStats = viewCloudflareStats;
        window.forceSyncNow = forceSyncNow;
        window.testCloudConnection = testCloudConnection;

        // Check Cloudflare connection on page load
        async function checkCloudflareConnection() {
            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'https://etsy-3d-print-api.royal-bush-a056.workers.dev';
                const response = await fetch(`${workerUrl}/api/sync-status`);
                const status = await response.json();

                if (status.connected) {
                    // Always show connected for Cloudflare
                    const connectedDiv = document.getElementById('cloudflareConnected');
                    if (connectedDiv) {
                        connectedDiv.style.display = 'block';
                    }
                    console.log(`‚úÖ Cloudflare connected: ${status.stats.files} files, ${status.stats.inquiries} inquiries`);

                    // Update status fields
                    if (document.getElementById('cfDatabaseStatus')) {
                        document.getElementById('cfDatabaseStatus').value = `D1 Connected ‚úÖ (${status.stats.inquiries} inquiries)`;
                    }
                    if (document.getElementById('cfStorageStatus')) {
                        document.getElementById('cfStorageStatus').value = `R2 Active (${status.stats.files} files)`;
                    }

                    // Update usage bar
                    await updateCloudflareUsageBar();
                }
            } catch (error) {
                console.log('‚ùå Cloudflare connection failed:', error);
                // Show failed status
                const connectedDiv = document.getElementById('cloudflareConnected');
                if (connectedDiv) {
                    connectedDiv.innerHTML = `
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px; padding: 1rem;">
                            <h4 style="margin: 0; color: #ef4444;">‚ùå Cloudflare Sync Failed</h4>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 4px 0;">
                                Connection to Cloudflare worker failed. Using local storage only.
                            </p>
                            <button class="btn btn-secondary" onclick="checkCloudflareStatus()" style="padding: 4px 8px; font-size: 12px;">üîÑ Retry</button>
                        </div>
                    `;
                }
            }
        }

        // Update Cloudflare usage bar
        async function updateCloudflareUsageBar() {
            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'https://etsy-3d-print-api.royal-bush-a056.workers.dev';
                const response = await fetch(`${workerUrl}/api/sync-status`);
                const data = await response.json();

                if (data.connected) {
                    // Update file count - use actual stats from database
                    document.getElementById('cfFilesCount').textContent = data.stats?.files || 0;

                    // Update inquiries count
                    document.getElementById('cfInquiriesCount').textContent = data.stats?.inquiries || 0;

                    // Update orders count
                    document.getElementById('cfOrdersCount').textContent = data.stats?.orders || 0;

                    // Calculate storage (mock calculation - in real app would come from server)
                    const filesCount = data.stats?.files || 0;
                    const storageUsedMB = filesCount * 5; // Assume 5MB per file average
                    const storageUsedGB = (storageUsedMB / 1024).toFixed(2);
                    const storagePercent = (storageUsedMB / (10 * 1024)) * 100; // 10GB limit

                    // Update storage display
                    const storageText = storageUsedMB < 1024
                        ? `${storageUsedMB} MB / 10 GB`
                        : `${storageUsedGB} GB / 10 GB`;

                    document.getElementById('cfStorageText').textContent = storageText;
                    document.getElementById('cfStorageBar').style.width = `${Math.min(storagePercent, 100)}%`;

                    // Update status badge
                    document.getElementById('cfStatusBadge').textContent = 'Connected';
                    document.getElementById('cfStatusBadge').style.background = 'rgba(34, 197, 94, 0.1)';
                    document.getElementById('cfStatusBadge').style.color = '#22c55e';
                } else {
                    // If not connected, show zeros
                    document.getElementById('cfFilesCount').textContent = '0';
                    document.getElementById('cfInquiriesCount').textContent = '0';
                    document.getElementById('cfOrdersCount').textContent = '0';
                    document.getElementById('cfStorageText').textContent = '0 MB / 10 GB';
                    document.getElementById('cfStorageBar').style.width = '0%';

                    // Show disconnected status
                    document.getElementById('cfStatusBadge').textContent = 'Offline';
                    document.getElementById('cfStatusBadge').style.background = 'rgba(239, 68, 68, 0.1)';
                    document.getElementById('cfStatusBadge').style.color = '#ef4444';
                }
            } catch (error) {
                console.error('Failed to update Cloudflare usage bar:', error);

                // Reset all counters to 0 on error
                document.getElementById('cfFilesCount').textContent = '0';
                document.getElementById('cfInquiriesCount').textContent = '0';
                document.getElementById('cfOrdersCount').textContent = '0';
                document.getElementById('cfStorageText').textContent = '0 MB / 10 GB';
                document.getElementById('cfStorageBar').style.width = '0%';

                // Show disconnected status
                document.getElementById('cfStatusBadge').textContent = 'Offline';
                document.getElementById('cfStatusBadge').style.background = 'rgba(239, 68, 68, 0.1)';
                document.getElementById('cfStatusBadge').style.color = '#ef4444';
            }
        }

        // Make it globally available
        window.updateCloudflareUsageBar = updateCloudflareUsageBar;

        // Function to manually refresh Cloudflare stats
        window.refreshCloudflareStats = async function() {
            console.log('üîÑ Refreshing Cloudflare stats...');
            await updateCloudflareUsageBar();

            // Also reload all data to ensure consistency
            await loadInquiries();
            await loadOrders();
            await loadInventory();

            showNotification('‚úÖ Cloudflare stats refreshed', 'success');
        };

        // Function to clear all Cloudflare data and orphaned files
        window.clearAllCloudflareData = async function() {
            if (!confirm('‚ö†Ô∏è This will delete ALL data from Cloudflare (inquiries, orders, files, inventory). Are you sure?')) {
                return;
            }

            try {
                const cloudflareUrl = getCloudflareUrl();
                showNotification('üîÑ Starting complete Cloudflare cleanup...', 'info');

                // Use the new force cleanup endpoint
                const forceCleanupResponse = await fetch(`${cloudflareUrl}/api/force-cleanup`, {
                    method: 'DELETE'
                });

                if (forceCleanupResponse.ok) {
                    const result = await forceCleanupResponse.json();
                    console.log('Force cleanup result:', result);

                    showNotification(`‚úÖ Force cleanup completed! Deleted: ${result.deleted.inquiries} inquiries, ${result.deleted.orders} orders, ${result.deleted.files} files, ${result.deleted.r2Objects} R2 objects`, 'success');

                    // Clear local storage
                    localStorage.clear();

                    // Reload all tabs
                    loadInquiries();
                    loadOrders();
                    loadPrinters();
                    loadInventory();
                    updateDashboardStats();
                    updateCloudflareStatus();

                    return;
                }

                // Fallback to old method if force cleanup fails
                showNotification('‚ö†Ô∏è Force cleanup failed, trying alternative method...', 'warning');

                let totalDeleted = {
                    inquiries: 0,
                    orders: 0,
                    files: 0,
                    inventory: 0
                };

                // First collect all files that need to be deleted
                const filesToDelete = new Set();

                // Get all inquiries and their files
                const inquiriesResponse = await fetch(`${cloudflareUrl}/api/inquiries`);
                if (inquiriesResponse.ok) {
                    const inquiriesData = await inquiriesResponse.json();
                    const inquiries = inquiriesData.inquiries || [];

                    for (const inquiry of inquiries) {
                        // Collect file keys
                        if (inquiry.files && inquiry.files.length > 0) {
                            for (const file of inquiry.files) {
                                if (file.file_key || file.key || file.filename) {
                                    filesToDelete.add(file.file_key || file.key || file.filename);
                                }
                            }
                        }

                        // Delete the inquiry
                        try {
                            await fetch(`${cloudflareUrl}/api/inquiries/${inquiry.id}`, {
                                method: 'DELETE'
                            });
                            console.log(`Deleted inquiry: ${inquiry.id}`);
                            totalDeleted.inquiries++;
                        } catch (err) {
                            console.error(`Failed to delete inquiry ${inquiry.id}:`, err);
                        }
                    }
                }

                // Get all orders and their files
                const ordersResponse = await fetch(`${cloudflareUrl}/api/orders`);
                if (ordersResponse.ok) {
                    const ordersData = await ordersResponse.json();
                    const orders = ordersData.orders || [];

                    for (const order of orders) {
                        // Collect file keys
                        if (order.files && order.files.length > 0) {
                            for (const file of order.files) {
                                if (file.file_key || file.key || file.filename) {
                                    filesToDelete.add(file.file_key || file.key || file.filename);
                                }
                            }
                        }

                        // Delete the order
                        try {
                            await fetch(`${cloudflareUrl}/api/orders/${order.id}`, {
                                method: 'DELETE'
                            });
                            console.log(`Deleted order: ${order.id}`);
                            totalDeleted.orders++;
                        } catch (err) {
                            console.error(`Failed to delete order ${order.id}:`, err);
                        }
                    }
                }

                // Delete all collected files from R2
                for (const fileKey of filesToDelete) {
                    try {
                        await fetch(`${cloudflareUrl}/api/files/${encodeURIComponent(fileKey)}`, {
                            method: 'DELETE'
                        });
                        console.log(`Deleted file: ${fileKey}`);
                        totalDeleted.files++;
                    } catch (err) {
                        console.error(`Failed to delete file ${fileKey}:`, err);
                    }
                }

                // Clear all inventory
                const inventoryResponse = await fetch(`${cloudflareUrl}/api/inventory`);
                if (inventoryResponse.ok) {
                    const inventoryData = await inventoryResponse.json();
                    const inventory = inventoryData.inventory || [];

                    for (const item of inventory) {
                        try {
                            await fetch(`${cloudflareUrl}/api/inventory/${item.id}`, {
                                method: 'DELETE'
                            });
                            console.log(`Deleted inventory item: ${item.id}`);
                            totalDeleted.inventory++;
                        } catch (err) {
                            console.error(`Failed to delete inventory item ${item.id}:`, err);
                        }
                    }
                }

                // Clear all printers
                const printersResponse = await fetch(`${cloudflareUrl}/api/printers`);
                if (printersResponse.ok) {
                    const printersData = await printersResponse.json();
                    const printers = printersData.printers || [];

                    for (const printer of printers) {
                        try {
                            await fetch(`${cloudflareUrl}/api/printers/${printer.id}`, {
                                method: 'DELETE'
                            });
                            console.log(`Deleted printer: ${printer.id}`);
                        } catch (err) {
                            console.error(`Failed to delete printer ${printer.id}:`, err);
                        }
                    }
                }

                // Reload everything
                await loadInquiries();
                await loadOrders();
                await loadInventory();
                await loadPrinters();
                await updateCloudflareUsageBar();

                // Show summary
                showNotification(`‚úÖ Cleanup complete! Deleted: ${totalDeleted.inquiries} inquiries, ${totalDeleted.orders} orders, ${totalDeleted.files} files, ${totalDeleted.inventory} inventory items`, 'success');
                console.log('Cleanup summary:', totalDeleted);

            } catch (error) {
                console.error('Error clearing Cloudflare data:', error);
                showNotification('‚ùå Failed to clear Cloudflare data', 'error');
            }
        };

        // Already handled in main DOMContentLoaded above

        // Debug file saving issue
        function debugInquiryFiles() {
            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
            console.log('üìã Debug: Current inquiries:', inquiries);

            inquiries.forEach(inquiry => {
                console.log(`Inquiry ${inquiry.id}:`, {
                    customer: inquiry.customerName,
                    hasFiles: inquiry.hasFiles,
                    files: inquiry.files,
                    fileName: inquiry.fileName
                });
            });

            const pendingFiles = JSON.parse(localStorage.getItem('pendingDriveFiles') || '[]');
            console.log('üìÅ Pending Drive files:', pendingFiles);
        }

        // Force add download link for testing
        function forceFileDownloadTest(inquiryId) {
            const inquiry = {
                id: inquiryId,
                customerName: 'Test Customer',
                files: [{ name: 'test_file.stl', size: 12345, type: 'model/stl' }],
                hasFiles: true
            };

            // Test download
            downloadInquiryFiles(inquiryId);
        }

        // Function to fix existing inquiries with missing file data
        function fixInquiryFiles() {
            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
            let fixed = 0;

            inquiries.forEach(inquiry => {
                // If inquiry has timestamp property, convert to id
                if (inquiry.timestamp && !inquiry.id) {
                    inquiry.id = new Date(inquiry.timestamp).getTime();
                }

                // Fix files array if it's missing or malformed
                if (inquiry.hasFiles && (!inquiry.files || inquiry.files.length === 0)) {
                    // Try to reconstruct from fileName
                    if (inquiry.fileName) {
                        inquiry.files = [{
                            name: inquiry.fileName,
                            size: 0,
                            type: 'model/stl',
                            serverFilename: null // Will need re-upload
                        }];
                    }
                    fixed++;
                }
            });

            if (fixed > 0) {
                localStorage.setItem('inquiries', JSON.stringify(inquiries));
                console.log(`‚úÖ Fixed ${fixed} inquiries with missing file data`);
                loadInquiries();
            }
        }

        // Make debug functions available
        window.debugInquiryFiles = debugInquiryFiles;
        window.forceFileDownloadTest = forceFileDownloadTest;
        window.checkCloudflareConnection = checkCloudflareConnection;
        window.fixInquiryFiles = fixInquiryFiles;

        // Make essential functions globally available
        // switchTab is already global
        window.loadInquiries = loadInquiries;
        window.loadOrders = loadOrders;
        window.editInquiry = editInquiry;
        window.deleteInquiry = deleteInquiry;
        window.markAsPurchased = markAsPurchased;
        window.saveInquiryEdit = saveInquiryEdit;
        window.closeEditModal = closeEditModal;
        window.assignPrinterToOrder = assignPrinterToOrder;
        window.updateOrderStatus = updateOrderStatus;
        window.deleteOrder = deleteOrder;
        window.showNotification = showNotification;
        window.showConfirmModal = showConfirmModal;
        window.clearQuoteForm = clearQuoteForm;
        window.refreshInquiries = refreshInquiries;
        window.syncFromInquiries = syncFromInquiries;
        window.showAddOrderModal = showAddOrderModal;
        window.generateInventoryReport = generateInventoryReport;
        window.showAddMaterialModal = showAddMaterialModal;
        window.addMaterialToCategory = addMaterialToCategory;
        window.refreshPrinterStatus = refreshPrinterStatus;
        window.showAddPrinterModal = showAddPrinterModal;
        window.exportSettings = exportSettings;
        window.importSettings = importSettings;
        window.checkCloudflareStatus = checkCloudflareStatus;
        window.forceSyncNow = forceSyncNow;
        window.viewCloudflareStats = viewCloudflareStats;
        window.testCloudConnection = testCloudConnection;
        window.uploadFilesToCloudflare = uploadFilesToCloudflare;
        window.displayUploadedFiles = displayUploadedFiles;

        // Function to completely clean and reset an inquiry
        window.resetInquiry = function(inquiryId) {
            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
            const index = inquiries.findIndex(i => String(i.id) === String(inquiryId));

            if (index !== -1) {
                // Keep basic info but reset files
                inquiries[index].files = [];
                inquiries[index].hasFiles = false;
                localStorage.setItem('inquiries', JSON.stringify(inquiries));
                console.log(`Reset inquiry ${inquiryId} - please re-upload files`);
                loadInquiries();
            }
        };

        // Auto-fix inquiries on load
        setTimeout(fixInquiryFiles, 1000);

        console.log('üéâ 3D Print Business Manager fully restored and operational');
    </script>

    <!-- New modular system -->
    <script src="src/quote-calculator.js"></script>
    <script src="src/inquiries-system.js"></script>
</body>
</html>