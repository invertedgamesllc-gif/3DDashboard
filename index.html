<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Print Business Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0A0A0A;
            --bg-secondary: #1A1A1A;
            --bg-card: #1E1E1E;
            --bg-elevated: #262626;
            --border-primary: #2A2A2A;
            --border-secondary: #3A3A3A;
            --text-primary: #FFFFFF;
            --text-secondary: #B3B3B3;
            --text-muted: #7A7A7A;
            --accent-primary: #22c55e;
            --accent-hover: #16a34a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Cloudflare Usage Bar */
        .cloudflare-usage-bar {
            background: linear-gradient(135deg, #1a1a1a 0%, #262626 100%);
            border-bottom: 1px solid var(--border-primary);
            padding: 12px 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
            font-size: 13px;
        }

        .cf-usage-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #f97316;
        }

        .cf-usage-stats {
            display: flex;
            gap: 2rem;
            flex: 1;
        }

        .cf-usage-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cf-usage-label {
            color: var(--text-muted);
            font-weight: 500;
        }

        .cf-usage-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .cf-usage-bar-wrapper {
            flex: 1;
            max-width: 200px;
        }

        .cf-usage-progress {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }

        .cf-usage-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f97316 0%, #fb923c 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .cf-status-badge {
            padding: 4px 12px;
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border-radius: 12px;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-tabs {
            background: var(--bg-secondary);
            padding: 0 2rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            gap: 0;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .nav-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
            background: rgba(34, 197, 94, 0.05);
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .form-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-secondary);
            color: var(--text-primary);
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.1);
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: rgba(34, 197, 94, 0.9);
            color: white;
        }

        .notification.error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }

        .notification.info {
            background: rgba(59, 130, 246, 0.9);
            color: white;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Inquiries Table Styling to match screenshot */
        #inquiriesTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #inquiriesTable th {
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: #6b7280;
            background: transparent;
            border-bottom: 1px solid #374151;
        }

        #inquiriesTable tbody tr {
            border-bottom: 1px solid #1f2937;
        }

        #inquiriesTable tbody tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        #inquiriesTable td {
            padding: 16px 12px;
            color: #e5e7eb;
            font-size: 14px;
        }

        /* Material badge styling */
        .material-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Quote amount styling */
        .quote-amount {
            color: #22c55e !important;
            font-weight: 600;
            font-size: 16px;
        }

        /* Status badge styling */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
            border: 1px solid rgba(251, 146, 60, 0.3);
        }

        .status-purchased {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* Action buttons styling to match screenshot */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-buttons button {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid;
        }

        .btn-edit {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.3) !important;
        }

        .btn-edit:hover {
            background: rgba(59, 130, 246, 0.25);
        }

        .btn-purchase {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3) !important;
        }

        .btn-purchase:hover {
            background: rgba(34, 197, 94, 0.25);
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3) !important;
        }

        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }

            #inquiriesTable {
                font-size: 12px;
            }

            #inquiriesTable th,
            #inquiriesTable td {
                padding: 8px 6px !important;
                min-width: 60px !important;
            }

            .action-btn {
                padding: 4px 6px !important;
                font-size: 10px !important;
            }

            /* Stack action buttons vertically on mobile */
            #inquiriesTable td:last-child > div {
                flex-direction: column !important;
                gap: 4px !important;
            }

            /* Hide less important columns on mobile */
            #inquiriesTable th:nth-child(4),
            #inquiriesTable td:nth-child(4),
            #inquiriesTable th:nth-child(6),
            #inquiriesTable td:nth-child(6),
            #inquiriesTable th:nth-child(7),
            #inquiriesTable td:nth-child(7) {
                display: none;
            }
        }

        @media (max-width: 480px) {
            #inquiriesTable th:nth-child(3),
            #inquiriesTable td:nth-child(3),
            #inquiriesTable th:nth-child(5),
            #inquiriesTable td:nth-child(5) {
                display: none;
            }
        }

        /* Modal styling improvements */
        .modal {
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal > div {
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translate(-50%, -60%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Cloudflare Usage Bar -->
    <div class="cloudflare-usage-bar" id="cloudflareUsageBar">
        <div class="cf-usage-title">
            ‚òÅÔ∏è Cloudflare
        </div>
        <div class="cf-usage-stats">
            <div class="cf-usage-item">
                <span class="cf-usage-label">Storage:</span>
                <div class="cf-usage-bar-wrapper">
                    <div class="cf-usage-value" id="cfStorageText">0 MB / 10 GB</div>
                    <div class="cf-usage-progress">
                        <div class="cf-usage-progress-fill" id="cfStorageBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="cf-usage-item">
                <span class="cf-usage-label">Files:</span>
                <span class="cf-usage-value" id="cfFilesCount">0</span>
            </div>
            <div class="cf-usage-item">
                <span class="cf-usage-label">Inquiries:</span>
                <span class="cf-usage-value" id="cfInquiriesCount">0</span>
            </div>
            <div class="cf-usage-item">
                <span class="cf-usage-label">Orders:</span>
                <span class="cf-usage-value" id="cfOrdersCount">0</span>
            </div>
        </div>
        <div class="cf-status-badge" id="cfStatusBadge">
            Connected
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('dashboard')">Dashboard</div>
        <div class="nav-tab" onclick="switchTab('calculator')">Quote Calculator</div>
        <div class="nav-tab" onclick="switchTab('inquiries')">Inquiries</div>
        <div class="nav-tab" onclick="switchTab('orders')">Orders</div>
        <div class="nav-tab" onclick="switchTab('inventory')">Inventory</div>
        <div class="nav-tab" onclick="switchTab('printers')">Printers</div>
        <div class="nav-tab" onclick="switchTab('settings')">Settings</div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard -->
        <div class="page-content active" id="dashboard">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Business Dashboard</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">3D Printing Business Management & Analytics</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" style="padding: 8px 16px;">üìä Export Report</button>
                    <button class="btn" style="padding: 8px 16px;">üîÑ Refresh Data</button>
                </div>
            </div>

            <!-- Key Performance Indicators -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 3rem;">
                <div class="card" style="padding: 24px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="background: rgba(34, 197, 94, 0.15); padding: 12px; border-radius: 12px;">
                            <span style="font-size: 24px;">üí∞</span>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.1); padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: #22c55e;">+12% ‚Üó</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px; font-weight: 500;">Daily Revenue</div>
                        <div style="font-size: 32px; font-weight: 800; color: var(--text-primary); line-height: 1; margin-bottom: 4px;">$1,482</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">$124 above yesterday</div>
                    </div>
                </div>

                <div class="card" style="padding: 24px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="background: rgba(59, 130, 246, 0.15); padding: 12px; border-radius: 12px;">
                            <span style="font-size: 24px;">üìã</span>
                        </div>
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: #ef4444;">3 urgent</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px; font-weight: 500;">Active Orders</div>
                        <div style="font-size: 32px; font-weight: 800; color: var(--text-primary); line-height: 1; margin-bottom: 4px;">8</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">3 due today, 5 in progress</div>
                    </div>
                </div>

                <div class="card" style="padding: 24px; background: linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(126, 34, 206, 0.05) 100%); border: 1px solid rgba(147, 51, 234, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="background: rgba(147, 51, 234, 0.15); padding: 12px; border-radius: 12px;">
                            <span style="font-size: 24px;">üñ®Ô∏è</span>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.1); padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: #22c55e;">67% capacity</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px; font-weight: 500;">Printer Fleet</div>
                        <div style="font-size: 32px; font-weight: 800; color: var(--text-primary); line-height: 1; margin-bottom: 4px;">4<span style="font-size: 18px; color: var(--text-muted);">/6</span></div>
                        <div style="font-size: 12px; color: var(--text-secondary);">2 available, 4 printing</div>
                    </div>
                </div>

                <div class="card" style="padding: 24px; background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(234, 88, 12, 0.05) 100%); border: 1px solid rgba(251, 146, 60, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="background: rgba(251, 146, 60, 0.15); padding: 12px; border-radius: 12px;">
                            <span style="font-size: 24px;">üì®</span>
                        </div>
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: #ef4444;">2 urgent</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px; font-weight: 500;">Customer Messages</div>
                        <div style="font-size: 32px; font-weight: 800; color: var(--text-primary); line-height: 1; margin-bottom: 4px;">5</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">2 urgent, 3 inquiries</div>
                    </div>
                </div>
            </div>

            <!-- Business Intelligence -->
            <div style="margin-bottom: 3rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div>
                        <h2 style="font-size: 20px; font-weight: 700; margin: 0; color: var(--text-primary);">Business Intelligence</h2>
                        <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Performance metrics and trends analysis</p>
                    </div>
                </div>

                <!-- Revenue Trend -->
                <div class="card" style="margin-bottom: 2rem; padding: 24px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.03) 0%, rgba(16, 185, 129, 0.01) 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">Revenue Performance</h3>
                            <p style="font-size: 13px; color: var(--text-muted); margin: 4px 0 0 0;">Daily revenue over the past 7 days</p>
                        </div>
                        <div style="font-size: 24px; font-weight: 800; color: #22c55e;">$5,551 Total</div>
                    </div>

                    <div style="display: flex; align-items: end; gap: 12px; height: 140px; padding: 20px 0; background: rgba(255, 255, 255, 0.02); border-radius: 12px;">
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="background: linear-gradient(to top, #22c55e 0%, #16a34a 50%); width: 100%; height: 45%; margin-bottom: 12px; border-radius: 6px 6px 0 0; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);"></div>
                            <span style="font-size: 12px; color: var(--text-primary); font-weight: 600;">Mon</span>
                            <span style="font-size: 11px; color: var(--text-muted);">$450</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="background: linear-gradient(to top, #22c55e 0%, #16a34a 50%); width: 100%; height: 68%; margin-bottom: 12px; border-radius: 6px 6px 0 0; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);"></div>
                            <span style="font-size: 12px; color: var(--text-primary); font-weight: 600;">Tue</span>
                            <span style="font-size: 11px; color: var(--text-muted);">$680</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="background: linear-gradient(to top, #22c55e 0%, #16a34a 50%); width: 100%; height: 72%; margin-bottom: 12px; border-radius: 6px 6px 0 0; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);"></div>
                            <span style="font-size: 12px; color: var(--text-primary); font-weight: 600;">Wed</span>
                            <span style="font-size: 11px; color: var(--text-muted);">$720</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="background: linear-gradient(to top, #22c55e 0%, #16a34a 50%); width: 100%; height: 100%; margin-bottom: 12px; border-radius: 6px 6px 0 0; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);"></div>
                            <span style="font-size: 12px; color: var(--text-primary); font-weight: 600;">Sun</span>
                            <span style="font-size: 11px; color: var(--text-muted);">$1,482</span>
                        </div>
                    </div>
                </div>

                <!-- Business Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem;">
                    <div class="card" style="padding: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 1rem;">üßµ Material Usage</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 13px;">PLA</span>
                            <div style="flex: 1; margin: 0 12px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                                <div style="height: 100%; width: 68%; background: linear-gradient(90deg, #22c55e, #16a34a); border-radius: 3px;"></div>
                            </div>
                            <span style="font-size: 11px; color: var(--text-muted);">68%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 13px;">PETG</span>
                            <div style="flex: 1; margin: 0 12px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                                <div style="height: 100%; width: 18%; background: linear-gradient(90deg, #3b82f6, #2563eb); border-radius: 3px;"></div>
                            </div>
                            <span style="font-size: 11px; color: var(--text-muted);">18%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 13px;">ABS</span>
                            <div style="flex: 1; margin: 0 12px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                                <div style="height: 100%; width: 14%; background: linear-gradient(90deg, #f59e0b, #d97706); border-radius: 3px;"></div>
                            </div>
                            <span style="font-size: 11px; color: var(--text-muted);">14%</span>
                        </div>
                    </div>

                    <div class="card" style="padding: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 1rem;">üé® Popular Colors</h3>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                            <div style="text-align: center;">
                                <div style="width: 32px; height: 32px; background: #000000; border-radius: 50%; margin: 0 auto 4px; border: 2px solid rgba(255,255,255,0.2);"></div>
                                <div style="font-size: 10px; color: var(--text-muted);">Black</div>
                                <div style="font-size: 9px; color: var(--text-secondary);">1.2kg</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="width: 32px; height: 32px; background: #ffffff; border-radius: 50%; margin: 0 auto 4px; border: 2px solid rgba(255,255,255,0.2);"></div>
                                <div style="font-size: 10px; color: var(--text-muted);">White</div>
                                <div style="font-size: 9px; color: var(--text-secondary);">950g</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="width: 32px; height: 32px; background: #dc2626; border-radius: 50%; margin: 0 auto 4px; border: 2px solid rgba(255,255,255,0.2);"></div>
                                <div style="font-size: 10px; color: var(--text-muted);">Red</div>
                                <div style="font-size: 9px; color: var(--text-secondary);">680g</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="width: 32px; height: 32px; background: #2563eb; border-radius: 50%; margin: 0 auto 4px; border: 2px solid rgba(255,255,255,0.2);"></div>
                                <div style="font-size: 10px; color: var(--text-muted);">Blue</div>
                                <div style="font-size: 9px; color: var(--text-secondary);">520g</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="width: 32px; height: 32px; background: #16a34a; border-radius: 50%; margin: 0 auto 4px; border: 2px solid rgba(255,255,255,0.2);"></div>
                                <div style="font-size: 10px; color: var(--text-muted);">Green</div>
                                <div style="font-size: 9px; color: var(--text-secondary);">340g</div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="padding: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 1rem;">üìä Order Status</h3>
                        <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(#22c55e 0% 45%, #f59e0b 45% 75%, #ef4444 75% 85%, #6b7280 85% 100%); position: relative;">
                                <div style="width: 40px; height: 40px; background: var(--bg-card); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></div>
                                <span style="font-size: 12px;">Completed</span>
                            </div>
                            <span style="font-size: 12px; font-weight: 600;">45%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;"></div>
                                <span style="font-size: 12px;">In Progress</span>
                            </div>
                            <span style="font-size: 12px; font-weight: 600;">30%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></div>
                                <span style="font-size: 12px;">Pending</span>
                            </div>
                            <span style="font-size: 12px; font-weight: 600;">25%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quote Calculator -->
        <div class="page-content" id="calculator">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üí∞ Quote Calculator</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Professional quote estimation for 3D printing projects</p>
                </div>
                <button class="btn" onclick="clearQuoteForm()" style="background: rgba(239, 68, 68, 0.8);">
                    üóëÔ∏è Clear Form
                </button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <!-- Input Section -->
                <div class="card" style="padding: 2rem;">
                    <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 1.5rem; color: var(--text-primary);">Project Details</h2>

                    <!-- File Upload Section -->
                    <div class="form-group">
                        <label class="form-label">Upload 3D Files</label>
                        <div style="border: 2px dashed var(--border-primary); border-radius: 8px; padding: 1.5rem; text-align: center; background: rgba(34, 197, 94, 0.05); transition: border-color 0.3s;">
                            <input type="file" id="fileInput" accept=".stl,.obj,.3mf,.gcode,.zip" multiple style="display: none;" onchange="handleFileUpload(event)">
                            <button class="btn" onclick="document.getElementById('fileInput').click()" style="margin-bottom: 8px;">
                                üìÅ Choose Files
                            </button>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 0;">
                                STL, OBJ, 3MF, GCODE, ZIP files supported
                            </p>
                        </div>

                        <!-- File Display -->
                        <div id="fileDisplay" style="margin-top: 12px; display: none;">
                            <div style="background: var(--bg-elevated); border-radius: 8px; padding: 12px; border: 1px solid var(--border-primary);">
                                <h4 style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">üìÅ Uploaded Files</h4>
                                <div id="fileList" style="display: flex; flex-direction: column; gap: 6px;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Material Weight (grams)</label>
                        <input type="number" id="materialWeight" class="form-input" placeholder="Enter weight in grams" oninput="calculateQuote()" min="0" step="0.1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Print Time (hours)</label>
                        <input type="number" id="printTime" class="form-input" placeholder="Enter print time in hours" oninput="calculateQuote()" min="0" step="0.1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Number of Beds</label>
                        <input type="number" id="numBeds" class="form-input" placeholder="Number of printer beds" oninput="calculateQuote()" min="1" step="1" value="1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Labor Time (minutes)</label>
                        <input type="number" id="laborTime" class="form-input" placeholder="Enter labor time in minutes" oninput="calculateQuote()" min="0" step="1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Shipping Cost ($)</label>
                        <input type="number" id="shippingCost" class="form-input" placeholder="Enter shipping cost" oninput="calculateQuote()" min="0" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Material Type</label>
                        <select id="materialType" class="form-input" onchange="calculateQuote()">
                            <option value="PLA">PLA - Standard Quality</option>
                            <option value="PETG">PETG - Chemical Resistant</option>
                            <option value="ABS">ABS - Impact Resistant</option>
                            <option value="TPU">TPU - Flexible</option>
                            <option value="Wood">Wood Fill - Natural Look</option>
                            <option value="Metal">Metal Fill - Premium</option>
                        </select>
                    </div>

                    <!-- Customer Information -->
                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-secondary);">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Customer Information</h3>

                        <div class="form-group">
                            <label class="form-label">Customer Name</label>
                            <input type="text" id="customerName" class="form-input" placeholder="Enter customer name">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Customer Email</label>
                            <input type="email" id="customerEmail" class="form-input" placeholder="Enter customer email">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Project Description</label>
                            <textarea id="projectDescription" class="form-input" placeholder="Brief description of the project" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Quote Display Section -->
                <div class="card" style="padding: 2rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 1.5rem; color: var(--text-primary);">Quote Breakdown</h2>

                    <!-- Total Quote Display -->
                    <div style="text-align: center; margin-bottom: 2rem; padding: 1.5rem; background: rgba(34, 197, 94, 0.1); border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3);">
                        <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 500;">TOTAL QUOTE</div>
                        <div id="totalQuote" style="font-size: 48px; font-weight: 800; color: #22c55e; line-height: 1;">$0.00</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 0.5rem;">Includes all fees and taxes</div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Cost Breakdown</h3>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 14px; color: var(--text-secondary);">Material Cost:</span>
                            <span id="materialCost" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">$0.00</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 14px; color: var(--text-secondary);">Printer Time:</span>
                            <span id="printerCost" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">$0.00</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 14px; color: var(--text-secondary);">Labor Cost:</span>
                            <span id="laborCost" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">$0.00</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 14px; color: var(--text-secondary);">Multi-day Fee:</span>
                            <span id="multidayCost" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">$0.00</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 14px; color: var(--text-secondary);">Additional Beds:</span>
                            <span id="bedCost" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">$0.00</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 14px; color: var(--text-secondary);">Shipping:</span>
                            <span id="displayShippingCost" style="font-size: 14px; font-weight: 600; color: var(--text-primary);">$0.00</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-top: 2px solid rgba(34, 197, 94, 0.3); margin-top: 1rem;">
                            <span style="font-size: 14px; color: var(--text-secondary); font-weight: 600;">Subtotal:</span>
                            <span id="subtotal" style="font-size: 14px; font-weight: 700; color: var(--text-primary);">$0.00</span>
                        </div>
                    </div>

                    <!-- Project Summary -->
                    <div style="margin-bottom: 2rem; padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 8px;">
                        <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">Project Summary</h3>
                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">
                            <div id="summaryWeight">Weight: - grams</div>
                            <div id="summaryTime">Print Time: - hours</div>
                            <div id="summaryMaterial">Material: -</div>
                            <div id="summaryBeds">Beds Required: -</div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn" onclick="quoteCalculator.saveAsInquiry()" style="flex: 1;">
                            üíæ Save to Inquiries
                        </button>
                        <button class="btn btn-secondary" onclick="quoteCalculator.exportQuote()" style="flex: 1;">
                            üìÑ Export Quote
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inquiries -->
        <div class="page-content" id="inquiries">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üìã Customer Inquiries</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Manage customer quotes and project inquiries</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <select id="inquiryFilter" class="form-input" style="width: auto; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border-secondary);" onchange="filterInquiries()">
                        <option value="">All Inquiries</option>
                        <option value="pending">Pending</option>
                        <option value="purchased">Purchased</option>
                        <option value="declined">Declined</option>
                    </select>
                    <button class="btn btn-secondary" onclick="refreshInquiries()" style="padding: 8px 16px;">üîÑ Refresh</button>
                </div>
            </div>

            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="overflow-x: auto;">
                    <table id="inquiriesTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead style="background: rgba(255, 255, 255, 0.05); position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 100px;">Date</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 140px;">Customer</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 180px;">Email</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 80px;">File</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 90px;">Material</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 80px;">Weight</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 70px;">Time</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 80px;">Quote</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 90px;">Status</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 180px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inquiriesTableBody" style="background: var(--bg-card);">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="emptyInquiriesState" style="display: none; text-align: center; padding: 4rem 2rem; color: var(--text-muted);">
                    <div style="font-size: 48px; margin-bottom: 1rem; opacity: 0.5;">üìã</div>
                    <h3 style="font-size: 18px; margin-bottom: 0.5rem; color: var(--text-secondary);">No Inquiries Found</h3>
                    <p style="font-size: 14px;">Customer inquiries will appear here when created from the Quote Calculator.</p>
                </div>
            </div>
        </div>

        <!-- Orders -->
        <div class="page-content" id="orders">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üì¶ Order Management</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Track and manage your 3D printing orders</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <select id="orderFilter" class="form-input" style="width: auto; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border-secondary);" onchange="filterOrders()">
                        <option value="">All Orders</option>
                        <option value="pending">Pending</option>
                        <option value="printing">Printing</option>
                        <option value="completed">Completed</option>
                        <option value="shipped">Shipped</option>
                    </select>
                    <button class="btn btn-secondary" onclick="syncFromInquiries()" style="padding: 8px 16px;">üîÑ Sync from Inquiries</button>
                    <button class="btn" onclick="showAddOrderModal()" style="padding: 8px 16px;">+ Add Order</button>
                </div>
            </div>

            <!-- Order Queue Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 2rem;">
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚è≥</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="pendingOrdersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Pending Orders</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(234, 88, 12, 0.05) 100%); border: 1px solid rgba(251, 146, 60, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">üñ®Ô∏è</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="printingOrdersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Currently Printing</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚úÖ</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="completedOrdersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Completed Orders</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(126, 34, 206, 0.05) 100%); border: 1px solid rgba(147, 51, 234, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">üì¶</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="shippedOrdersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Shipped Orders</div>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="overflow-x: auto;">
                    <table id="ordersTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead style="background: rgba(255, 255, 255, 0.05); position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 80px;">Order ID</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 140px;">Customer</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 150px;">Product</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 100px;">Due Date</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 80px;">Value</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 100px;">Printer</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 90px;">Status</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-secondary); min-width: 180px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="emptyOrdersState" style="display: none; text-align: center; padding: 4rem 2rem; color: var(--text-muted);">
                    <div style="font-size: 48px; margin-bottom: 1rem; opacity: 0.5;">üì¶</div>
                    <h3 style="font-size: 18px; margin-bottom: 0.5rem; color: var(--text-secondary);">No Orders Found</h3>
                    <p style="font-size: 14px;">Orders will appear here when synced from inquiries or added manually.</p>
                </div>
            </div>
        </div>

        <!-- Inventory -->
        <div class="page-content" id="inventory">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üè¶ Material Inventory</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Track your 3D printing material stock and usage</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="generateInventoryReport()" style="padding: 8px 16px;">üìà Generate Report</button>
                    <button class="btn" onclick="showAddMaterialModal()" style="padding: 8px 16px;">+ Add Material</button>
                </div>
            </div>

            <!-- Inventory Overview -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 2rem;">
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">üì¶</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="totalMaterialsCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Total Materials</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%); border: 1px solid rgba(239, 68, 68, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚ö†Ô∏è</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="lowStockCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Low Stock Items</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">üìä</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="totalInventoryValue">$0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Total Inventory Value</div>
                </div>
            </div>

            <!-- Low Stock Alerts -->
            <div id="lowStockAlerts" style="margin-bottom: 2rem; display: none;">
                <div class="card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%); border: 1px solid rgba(239, 68, 68, 0.2);">
                    <h3 style="color: #ef4444; margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        ‚ö†Ô∏è Low Stock Alerts
                    </h3>
                    <div id="lowStockList"></div>
                </div>
            </div>

            <!-- Material Categories -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                <!-- PLA Materials -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #22c55e; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <span style="background: rgba(34, 197, 94, 0.1); padding: 6px; border-radius: 6px; font-size: 14px;">üåø</span>
                            PLA Materials
                        </h3>
                        <button onclick="addMaterialToCategory('PLA')" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Add PLA</button>
                    </div>
                    <div id="plaMaterials"></div>
                </div>

                <!-- PETG Materials -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #3b82f6; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <span style="background: rgba(59, 130, 246, 0.1); padding: 6px; border-radius: 6px; font-size: 14px;">üß™</span>
                            PETG Materials
                        </h3>
                        <button onclick="addMaterialToCategory('PETG')" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Add PETG</button>
                    </div>
                    <div id="petgMaterials"></div>
                </div>

                <!-- ABS Materials -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #f59e0b; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <span style="background: rgba(245, 158, 11, 0.1); padding: 6px; border-radius: 6px; font-size: 14px;">üî•</span>
                            ABS Materials
                        </h3>
                        <button onclick="addMaterialToCategory('ABS')" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Add ABS</button>
                    </div>
                    <div id="absMaterials"></div>
                </div>

                <!-- TPU Materials -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #8b5cf6; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <span style="background: rgba(139, 92, 246, 0.1); padding: 6px; border-radius: 6px; font-size: 14px;">ü§∏</span>
                            TPU Materials
                        </h3>
                        <button onclick="addMaterialToCategory('TPU')" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.3); padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Add TPU</button>
                    </div>
                    <div id="tpuMaterials"></div>
                </div>

                <!-- Specialty Materials -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #6b7280; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <span style="background: rgba(107, 114, 128, 0.1); padding: 6px; border-radius: 6px; font-size: 14px;">‚ú®</span>
                            Specialty Materials
                        </h3>
                        <button onclick="addMaterialToCategory('Specialty')" style="background: rgba(107, 114, 128, 0.1); color: #6b7280; border: 1px solid rgba(107, 114, 128, 0.3); padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Add Special</button>
                    </div>
                    <div id="specialtyMaterials"></div>
                </div>
            </div>
        </div>

        <!-- Printers -->
        <div class="page-content" id="printers">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üñ®Ô∏è Printer Fleet</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Monitor and manage your 3D printer fleet</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="refreshPrinterStatus()" style="padding: 8px 16px;">üîÑ Refresh All</button>
                    <button class="btn" onclick="showAddPrinterModal()" style="padding: 8px 16px;">+ Add Printer</button>
                </div>
            </div>

            <!-- Fleet Overview -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 2rem;">
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚úÖ</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="onlinePrintersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Online</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(234, 88, 12, 0.05) 100%); border: 1px solid rgba(251, 146, 60, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">üñ®Ô∏è</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="printingCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Printing</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚è∏Ô∏è</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="idlePrintersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Idle</div>
                </div>
                <div class="card" style="padding: 16px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%); border: 1px solid rgba(239, 68, 68, 0.2);">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚ö†Ô∏è</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="errorPrintersCount">0</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Errors</div>
                </div>
            </div>

            <!-- Printer Grid -->
            <div id="printerGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 24px;">
                <!-- Printer cards will be dynamically generated here -->
            </div>

            <!-- Empty State -->
            <div id="emptyPrintersState" style="display: none; text-align: center; padding: 4rem 2rem; color: var(--text-muted);">
                <div style="font-size: 48px; margin-bottom: 1rem; opacity: 0.5;">üñ®Ô∏è</div>
                <h3 style="font-size: 18px; margin-bottom: 0.5rem; color: var(--text-secondary);">No Printers Found</h3>
                <p style="font-size: 14px;">Add your first 3D printer to start monitoring your fleet.</p>
                <button class="btn" onclick="showAddPrinterModal()" style="margin-top: 16px;">+ Add Your First Printer</button>
            </div>
        </div>

        <!-- Settings -->
        <div class="page-content" id="settings">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">‚öôÔ∏è Application Settings</h1>
                    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Configure your 3D printing business management system</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="exportSettings()" style="padding: 8px 16px;">üíæ Export Settings</button>
                    <button class="btn btn-secondary" onclick="importSettings()" style="padding: 8px 16px;">üìÅ Import Settings</button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <!-- Business Information -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        üè¢ Business Information
                    </h3>
                    <div class="form-group">
                        <label class="form-label">Company Name</label>
                        <input type="text" id="companyName" class="form-input" placeholder="Your 3D Printing Business" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Email</label>
                        <input type="email" id="contactEmail" class="form-input" placeholder="contact@yourbusiness.com" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="text" id="phoneNumber" class="form-input" placeholder="+1 (555) 123-4567" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Business Address</label>
                        <textarea id="businessAddress" class="form-input" rows="3" placeholder="Your business address..." onchange="saveSettings()"></textarea>
                    </div>
                </div>

                <!-- Application Preferences -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        üéØ Application Preferences
                    </h3>
                    <div class="form-group">
                        <label class="form-label">Default Material Cost ($/kg)</label>
                        <input type="number" id="defaultMaterialCost" class="form-input" value="15" step="0.01" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Labor Rate ($/hour)</label>
                        <input type="number" id="laborRate" class="form-input" value="60" step="0.01" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Printer Time Rate ($/hour)</label>
                        <input type="number" id="printerRate" class="form-input" value="0.56" step="0.01" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select id="currency" class="form-input" onchange="saveSettings()">
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (‚Ç¨)</option>
                            <option value="GBP">GBP (¬£)</option>
                            <option value="CAD">CAD (C$)</option>
                        </select>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        üîî Notification Settings
                    </h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="orderNotifications" onchange="saveSettings()" style="accent-color: var(--accent-primary);">
                            <span>New order notifications</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="printerNotifications" onchange="saveSettings()" style="accent-color: var(--accent-primary);">
                            <span>Printer status notifications</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="lowStockNotifications" onchange="saveSettings()" style="accent-color: var(--accent-primary);">
                            <span>Low stock alerts</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="dueDateNotifications" onchange="saveSettings()" style="accent-color: var(--accent-primary);">
                            <span>Due date reminders</span>
                        </label>
                    </div>
                </div>

                <!-- Folder Settings -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        üìÅ Folder Settings
                    </h3>
                    <div class="form-group">
                        <label class="form-label">STL Files Folder</label>
                        <input type="text" id="stlFolder" class="form-input" placeholder="/path/to/stl/files" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Exports Folder</label>
                        <input type="text" id="exportsFolder" class="form-input" placeholder="/path/to/exports" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Backup Folder</label>
                        <input type="text" id="backupFolder" class="form-input" placeholder="/path/to/backups" onchange="saveSettings()">
                    </div>
                </div>
            </div>

            <!-- Cloudflare Sync Section -->
            <div class="card" style="margin-top: 24px;">
                <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                    ‚òÅÔ∏è Cloudflare Sync
                </h3>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">Cloud storage with 10GB FREE for multi-computer sync.</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Database Status</label>
                        <input type="text" class="form-input" id="cfDatabaseStatus" value="D1 Connected ‚úÖ" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Storage Status</label>
                        <input type="text" class="form-input" id="cfStorageStatus" value="R2 Active (10GB Free)" readonly>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn" onclick="checkCloudflareStatus()">
                        üîç Check Status
                    </button>

                    <div id="cloudflareConnected" style="margin-top: 1rem; padding: 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h4 style="margin: 0; color: #22c55e;">‚úÖ Cloudflare Connected</h4>
                            <span class="badge" style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">Active</span>
                        </div>
                        <p style="font-size: 12px; color: var(--text-muted); margin: 4px 0;">
                            All data syncing to Cloudflare D1 & R2 Storage
                        </p>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button class="btn btn-secondary" onclick="forceSyncNow()" style="padding: 4px 8px; font-size: 12px;">üîÑ Sync Now</button>
                            <button class="btn btn-secondary" onclick="viewCloudflareStats()" style="padding: 4px 8px; font-size: 12px;">üìä View Stats</button>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="testCloudConnection()">
                        üîç Test Connection
                    </button>
                </div>
            </div>

            <!-- Data Management -->
            <div class="card" style="margin-top: 24px;">
                <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                    üìÑ Data Management
                </h3>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">Manage your application data and backups.</p>

                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="createBackup()">
                        üíæ Create Backup
                    </button>
                    <button class="btn btn-secondary" onclick="restoreBackup()">
                        üìÅ Restore Backup
                    </button>
                    <button class="btn" onclick="resetAllData()" style="background: #ef4444;">
                        üóëÔ∏è Reset All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Inquiry Modal -->
    <div id="editInquiryModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; backdrop-filter: blur(4px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 2rem; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 20px; font-weight: 700; margin: 0; color: var(--text-primary);">Edit Inquiry</h2>
                <button onclick="closeEditModal()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">√ó</button>
            </div>

            <form id="editInquiryForm">
                <input type="hidden" id="editInquiryId">

                <div class="form-group">
                    <label class="form-label">Customer Name</label>
                    <input type="text" id="editCustomerName" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Customer Email</label>
                    <input type="email" id="editCustomerEmail" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Project Description</label>
                    <textarea id="editProjectDescription" class="form-input" rows="3"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Material Weight (g)</label>
                        <input type="number" id="editMaterialWeight" class="form-input" step="0.1" min="0" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Print Time (h)</label>
                        <input type="number" id="editPrintTime" class="form-input" step="0.1" min="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Material Type</label>
                    <select id="editMaterialType" class="form-input">
                        <option value="PLA">PLA - Standard Quality</option>
                        <option value="PETG">PETG - Chemical Resistant</option>
                        <option value="ABS">ABS - Impact Resistant</option>
                        <option value="TPU">TPU - Flexible</option>
                        <option value="Wood">Wood Fill - Natural Look</option>
                        <option value="Metal">Metal Fill - Premium</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="editInquiryStatus" class="form-input">
                        <option value="pending">Pending</option>
                        <option value="purchased">Purchased</option>
                        <option value="declined">Declined</option>
                    </select>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="saveInquiryEdit()" style="flex: 1;">üíæ Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()" style="flex: 1;">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10001; backdrop-filter: blur(4px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 2rem; width: 90%; max-width: 400px;">
            <div style="text-align: center;">
                <div style="font-size: 48px; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);" id="confirmTitle">Confirm Action</h3>
                <p style="color: var(--text-secondary); margin-bottom: 2rem; line-height: 1.5;" id="confirmMessage">Are you sure you want to proceed?</p>

                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="closeConfirmModal()" style="flex: 1;">Cancel</button>
                    <button class="btn" onclick="confirmAction()" style="flex: 1; background: #ef4444;" id="confirmButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Order Modal -->
    <div id="addOrderModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; backdrop-filter: blur(4px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 2rem; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 20px; font-weight: 700; margin: 0; color: var(--text-primary);">Add New Order</h2>
                <button onclick="closeAddOrderModal()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">√ó</button>
            </div>

            <form id="addOrderForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Customer Name</label>
                        <input type="text" id="newOrderCustomer" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer Email</label>
                        <input type="email" id="newOrderEmail" class="form-input" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Product/Description</label>
                    <input type="text" id="newOrderProduct" class="form-input" placeholder="Product name or description" required>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Order Value ($)</label>
                        <input type="number" id="newOrderValue" class="form-input" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" id="newOrderDueDate" class="form-input" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Assign to Printer (Optional)</label>
                    <select id="newOrderPrinter" class="form-input">
                        <option value="">No printer assigned</option>
                    </select>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="saveNewOrder()" style="flex: 1;">üíæ Save Order</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddOrderModal()" style="flex: 1;">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Material Modal -->
    <div id="addMaterialModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; backdrop-filter: blur(4px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 2rem; width: 90%; max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 20px; font-weight: 700; margin: 0; color: var(--text-primary);">Add Material</h2>
                <button onclick="closeAddMaterialModal()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">√ó</button>
            </div>

            <form id="addMaterialForm">
                <div class="form-group">
                    <label class="form-label">Material Type</label>
                    <select id="newMaterialType" class="form-input" required>
                        <option value="PLA">PLA</option>
                        <option value="PETG">PETG</option>
                        <option value="ABS">ABS</option>
                        <option value="TPU">TPU</option>
                        <option value="Specialty">Specialty</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Color</label>
                    <input type="text" id="newMaterialColor" class="form-input" placeholder="e.g., Black, White, Red" required>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" id="newMaterialWeight" class="form-input" step="0.1" min="0" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cost per kg ($)</label>
                        <input type="number" id="newMaterialCost" class="form-input" step="0.01" min="0" value="15" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Low Stock Threshold (kg)</label>
                    <input type="number" id="newMaterialThreshold" class="form-input" step="0.1" min="0" value="0.2" required>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="saveNewMaterial()" style="flex: 1;">üíæ Add Material</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddMaterialModal()" style="flex: 1;">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Printer Modal -->
    <div id="addPrinterModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; backdrop-filter: blur(4px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 2rem; width: 90%; max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: 20px; font-weight: 700; margin: 0; color: var(--text-primary);">Add Printer</h2>
                <button onclick="closeAddPrinterModal()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">√ó</button>
            </div>

            <form id="addPrinterForm">
                <div class="form-group">
                    <label class="form-label">Printer Name</label>
                    <input type="text" id="newPrinterName" class="form-input" placeholder="e.g., Bambu X1C #1" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Printer Model</label>
                    <select id="newPrinterModel" class="form-input" required>
                        <option value="Bambu X1C">Bambu X1C</option>
                        <option value="Bambu P1S">Bambu P1S</option>
                        <option value="Bambu A1">Bambu A1</option>
                        <option value="Prusa MK4">Prusa MK4</option>
                        <option value="Ender 3">Ender 3</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">IP Address (Optional)</label>
                        <input type="text" id="newPrinterIP" class="form-input" placeholder="192.168.1.100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="newPrinterStatus" class="form-input">
                            <option value="idle">Idle</option>
                            <option value="printing">Printing</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="saveNewPrinter()" style="flex: 1;">üíæ Add Printer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddPrinterModal()" style="flex: 1;">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Basic tab switching
        function switchTab(tabName) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });

            // Remove active from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected page
            document.getElementById(tabName).classList.add('active');

            // Mark tab as active
            event.target.classList.add('active');

            // Load inquiries when switching to inquiries tab
            if (tabName === 'inquiries') {
                loadInquiries();
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Quote Calculator Functions
        function calculateQuote() {
            // Debug to catch when values are unexpectedly high
            const materialWeightRaw = document.getElementById('materialWeight').value;
            const printTimeRaw = document.getElementById('printTime').value;
            console.log('calculateQuote called with raw values:', { materialWeightRaw, printTimeRaw });

            // Get input values (using original variable names from formula)
            const K3 = parseFloat(materialWeightRaw) || 0; // weight in grams
            const L3 = parseFloat(printTimeRaw) || 0; // time in hours
            const M3 = parseInt(document.getElementById('numBeds').value) || 1; // number of beds
            const N3 = parseFloat(document.getElementById('laborTime').value) || 0; // labor in minutes
            const O3 = parseFloat(document.getElementById('shippingCost').value) || 0; // shipping cost

            // Validate reasonable ranges
            if (K3 > 10000) { // > 10kg seems unreasonable
                console.warn('Material weight seems too high:', K3);
                document.getElementById('materialWeight').value = '';
                return;
            }
            if (L3 > 200) { // > 200 hours seems unreasonable
                console.warn('Print time seems too high:', L3);
                document.getElementById('printTime').value = '';
                return;
            }

            // Constants from original CSV formula
            const C4 = 1.1; // efficiency multiplier
            const C5 = 0.56; // printer cost per hour
            const C6 = 60; // labor rate per hour ($60/hr)
            const C7 = 2.5; // bed cost
            const C8 = 5; // multi-day multiplier
            const C9 = 15; // material cost per kg ($15/kg)

            // Calculate multi-day fee: IF(L3>24, L3/24*C8, 0)
            const multidayFee = L3 > 24 ? (L3 / 24) * C8 : 0;

            // Material cost: K3/1000*C9*C4 (convert grams to kg)
            const materialCostCalc = (K3 / 1000) * C9 * C4;

            // Labor cost: N3/60*C6 (convert minutes to hours)
            const laborCostCalc = (N3 / 60) * C6;

            // Printer cost: L3*C5
            const printerCostCalc = L3 * C5;

            // Bed cost: (M3-1)*C7
            const bedCostCalc = (M3 - 1) * C7;
            const shippingCostCalc = O3;

            // Subtotal before multiplier
            const subtotalBeforeMultiplier = multidayFee + materialCostCalc + laborCostCalc + printerCostCalc + bedCostCalc + O3;

            // Apply the original complex multiplier: (1.095/0.5) = 2.19
            const totalQuote = Math.round(subtotalBeforeMultiplier * (1.095 / 0.5) * 100) / 100;

            // Update display elements if they exist
            if (document.getElementById('totalQuote')) {
                document.getElementById('totalQuote').textContent = `$${totalQuote.toFixed(2)}`;
            }
            if (document.getElementById('materialCost')) {
                document.getElementById('materialCost').textContent = `$${materialCostCalc.toFixed(2)}`;
            }
            if (document.getElementById('printerCost')) {
                document.getElementById('printerCost').textContent = `$${printerCostCalc.toFixed(2)}`;
            }
            if (document.getElementById('laborCost')) {
                document.getElementById('laborCost').textContent = `$${laborCostCalc.toFixed(2)}`;
            }
            if (document.getElementById('multidayCost')) {
                document.getElementById('multidayCost').textContent = `$${multidayFee.toFixed(2)}`;
            }
            if (document.getElementById('bedCost')) {
                document.getElementById('bedCost').textContent = `$${bedCostCalc.toFixed(2)}`;
            }
            if (document.getElementById('displayShippingCost')) {
                document.getElementById('displayShippingCost').textContent = `$${shippingCostCalc.toFixed(2)}`;
            }
            if (document.getElementById('subtotal')) {
                document.getElementById('subtotal').textContent = `$${subtotalBeforeMultiplier.toFixed(2)}`;
            }

            // Update project summary if exists
            if (document.getElementById('summaryWeight')) {
                document.getElementById('summaryWeight').textContent = `Weight: ${materialWeight} grams`;
            }
            if (document.getElementById('summaryTime')) {
                document.getElementById('summaryTime').textContent = `Print Time: ${printTime} hours`;
            }
            if (document.getElementById('summaryMaterial')) {
                document.getElementById('summaryMaterial').textContent = `Material: ${document.getElementById('materialType').value}`;
            }
            if (document.getElementById('summaryBeds')) {
                document.getElementById('summaryBeds').textContent = `Beds Required: ${numBeds}`;
            }

            return totalQuote;
        }

        function clearQuoteForm() {
            // Clear all input fields
            document.getElementById('materialWeight').value = '';
            document.getElementById('printTime').value = '';
            document.getElementById('numBeds').value = '1';
            document.getElementById('laborTime').value = '0';
            document.getElementById('shippingCost').value = '0';
            document.getElementById('materialType').selectedIndex = 0;
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('projectDescription').value = '';

            // Reset all display values
            document.getElementById('totalQuote').textContent = '$0.00';
            document.getElementById('materialCost').textContent = '$0.00';
            document.getElementById('printerCost').textContent = '$0.00';
            document.getElementById('laborCost').textContent = '$0.00';
            document.getElementById('multidayCost').textContent = '$0.00';
            document.getElementById('bedCost').textContent = '$0.00';
            document.getElementById('displayShippingCost').textContent = '$0.00';
            document.getElementById('subtotal').textContent = '$0.00';

            // Reset project summary
            document.getElementById('summaryWeight').textContent = 'Weight: - grams';
            document.getElementById('summaryTime').textContent = 'Print Time: - hours';
            document.getElementById('summaryMaterial').textContent = 'Material: -';
            document.getElementById('summaryBeds').textContent = 'Beds Required: -';

            // Clear uploaded files
            uploadedFiles = [];
            pendingFiles = [];
            displayUploadedFiles();

            showNotification('Quote form cleared successfully', 'success');
        }

        async function saveQuoteToInquiries() {
            console.log('üî• saveQuoteToInquiries called');
            showNotification('üîç Starting save process...', 'info');

            // Get form data
            const customerName = document.getElementById('customerName').value;
            const customerEmail = document.getElementById('customerEmail').value;
            const projectDescription = document.getElementById('projectDescription').value;
            const totalQuote = document.getElementById('totalQuote').textContent;
            const materialWeight = document.getElementById('materialWeight').value;
            const printTime = document.getElementById('printTime').value;
            const materialType = document.getElementById('materialType').value;

            console.log('Form data:', { customerName, materialWeight, printTime, totalQuote });
            console.log('Pending files:', pendingFiles);

            // Validate required fields (only require name, weight and time)
            console.log('üìù Validation check:', { customerName, materialWeight, printTime });
            if (!customerName || !materialWeight || !printTime) {
                console.log('‚ùå Validation failed - missing required fields');
                showNotification('Please fill in customer name, weight, and print time', 'error');
                return;
            }
            console.log('‚úÖ Validation passed');

            // Upload files first if there are pending files
            let uploadResult = { success: true, files: [] };
            if (pendingFiles && pendingFiles.length > 0) {
                console.log('Uploading', pendingFiles.length, 'files to Cloudflare...');
                uploadResult = await uploadFilesToCloudflare();
                if (!uploadResult.success) {
                    showNotification('Failed to upload files', 'error');
                    return;
                }
                console.log('Upload successful!');
            } else {
                console.log('No files to upload');
            }

            console.log('Files uploaded:', uploadResult.files);

            // Create inquiry object with uploaded files
            const inquiry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                customerName: customerName,
                customerEmail: customerEmail || 'No email',
                projectDescription: projectDescription,
                materialWeight: materialWeight,
                printTime: printTime,
                materialType: materialType || 'PLA',
                totalQuote: totalQuote,
                status: 'pending',
                files: uploadResult.files,
                hasFiles: uploadResult.files.length > 0
            };

            // Save to Cloudflare D1 database
            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'http://localhost:8787';
                console.log('Saving inquiry to Cloudflare at:', workerUrl);
                console.log('Inquiry data:', inquiry);

                const response = await fetch(`${workerUrl}/api/inquiries`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(inquiry)
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Inquiry saved to Cloudflare D1:', result);

                    // Get existing inquiries from localStorage
                    let inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');

                    // Add new inquiry
                    inquiries.unshift(inquiry);

                    // Save to localStorage
                    localStorage.setItem('inquiries', JSON.stringify(inquiries));

                    // Clear pending files
                    pendingFiles = [];
                    uploadedFiles = [];

                    // Reload inquiries to show the new one immediately
                    await loadInquiries();

                    // Switch to inquiries tab to show the saved quote
                    document.querySelectorAll('.page-content').forEach(page => {
                        page.classList.remove('active');
                    });
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.getElementById('inquiries').classList.add('active');
                    document.querySelector('.nav-tab[onclick*="inquiries"]').classList.add('active');

                    showNotification(`‚úÖ Quote saved successfully for ${customerName}!`, 'success');

                    // Clear form after saving
                    setTimeout(() => {
                        clearQuoteForm();
                    }, 500);
                } else {
                    const errorText = await response.text();
                    console.error('Cloudflare error:', response.status, errorText);
                    throw new Error(`Failed to save to Cloudflare: ${response.status} ${errorText}`);
                }
            } catch (error) {
                console.error('Error saving inquiry:', error);

                // Still save to localStorage even if server fails
                let inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
                inquiries.unshift(inquiry);
                localStorage.setItem('inquiries', JSON.stringify(inquiries));
                await loadInquiries();

                // Switch to inquiries tab to show the saved quote
                document.querySelectorAll('.page-content').forEach(page => {
                    page.classList.remove('active');
                });
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.getElementById('inquiries').classList.add('active');
                document.querySelector('.nav-tab[onclick*="inquiries"]').classList.add('active');

                showNotification('‚ö†Ô∏è Saved locally (Cloudflare may be offline)', 'warning');

                // Clear form after saving
                setTimeout(() => {
                    clearQuoteForm();
                    pendingFiles = [];
                    uploadedFiles = [];
                }, 500);
            }
        }

        function exportQuote() {
            const customerName = document.getElementById('customerName').value || 'Customer';
            const totalQuote = document.getElementById('totalQuote').textContent;
            const materialWeight = document.getElementById('materialWeight').value;
            const printTime = document.getElementById('printTime').value;
            const materialType = document.getElementById('materialType').value;
            const projectDescription = document.getElementById('projectDescription').value;

            if (!materialWeight || !printTime) {
                showNotification('Please enter at least weight and print time to export', 'error');
                return;
            }

            // Create quote text
            const quoteText = `
3D PRINTING QUOTE
=================

Customer: ${customerName}
Date: ${new Date().toLocaleDateString()}

PROJECT DETAILS:
- Material Weight: ${materialWeight} grams
- Print Time: ${printTime} hours
- Material Type: ${materialType}
- Description: ${projectDescription || 'No description provided'}

COST BREAKDOWN:
- Material Cost: ${document.getElementById('materialCost').textContent}
- Printer Time: ${document.getElementById('printerCost').textContent}
- Labor Cost: ${document.getElementById('laborCost').textContent}
- Multi-day Fee: ${document.getElementById('multidayCost').textContent}
- Additional Beds: ${document.getElementById('bedCost').textContent}
- Shipping: ${document.getElementById('displayShippingCost').textContent}

TOTAL QUOTE: ${totalQuote}

Generated by 3D Print Business Manager
            `.trim();

            // Create and download file
            const blob = new Blob([quoteText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Quote_${customerName.replace(/\s+/g, '_')}_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showNotification('Quote exported successfully', 'success');
        }

        // Initialize calculator
        function initializeCalculator() {
            // Set default values
            document.getElementById('numBeds').value = '1';
            document.getElementById('laborTime').value = '0';
            document.getElementById('shippingCost').value = '0';

            // Calculate initial quote (should be $0.00)
            calculateQuote();
        }

        // Create quoteCalculator object for button calls
        window.quoteCalculator = {
            saveAsInquiry: async function() {
                console.log('üöÄ Save button clicked!');
                showNotification('üîÑ Save button clicked...', 'info');
                try {
                    await saveQuoteToInquiries();
                } catch (error) {
                    console.error('‚ùå Error in saveAsInquiry:', error);
                    showNotification('‚ùå Error saving inquiry: ' + error.message, 'error');
                }
            },
            exportQuote: function() {
                exportQuote();
            }
        };

        // Auto-initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCalculator();
            loadInquiries(); // Initialize inquiries on page load
        });

        // ===== INQUIRIES MANAGEMENT SYSTEM =====

        // Global variables for modal state
        let currentConfirmAction = null;
        let currentInquiryId = null;

        // Load and display inquiries - ONLY FROM CLOUDFLARE
        window.loadInquiries = async function() {
            // Clear any old localStorage data
            localStorage.removeItem('inquiries');

            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'http://localhost:8787';
                const response = await fetch(`${workerUrl}/api/inquiries`);

                if (!response.ok) {
                    throw new Error('Failed to load inquiries from Cloudflare');
                }

                const cloudflareData = await response.json();
                const cloudflareInquiries = cloudflareData.inquiries || [];

                // Convert Cloudflare format to display format
                const inquiries = cloudflareInquiries.map(cfInquiry => ({
                    id: cfInquiry.id,
                    timestamp: cfInquiry.created_at || new Date().toISOString(),
                    customerName: cfInquiry.customer_name,
                    customerEmail: cfInquiry.customer_email,
                    projectDescription: cfInquiry.project_description,
                    materialWeight: cfInquiry.material_weight,
                    printTime: cfInquiry.print_time,
                    materialType: cfInquiry.material_type,
                    totalQuote: cfInquiry.total_quote,
                    status: cfInquiry.status,
                    files: cfInquiry.files || [],
                    hasFiles: (cfInquiry.files || []).length > 0
                }));

                // Sort by timestamp descending
                inquiries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Display inquiries
                displayInquiries(inquiries);
            } catch (error) {
                console.error('Error loading from Cloudflare:', error);
                // Show empty state
                displayInquiries([]);
                showNotification('Unable to load inquiries from cloud', 'error');
            }
        };

        // Helper functions for badges
        function getStatusBadge(status) {
            const badges = {
                'pending': '<span style="display: inline-block; padding: 4px 10px; background: rgba(251, 146, 60, 0.2); color: #fb923c; border-radius: 6px; font-size: 12px; font-weight: 500; border: 1px solid rgba(251, 146, 60, 0.3);">‚è≥ Pending</span>',
                'purchased': '<span style="display: inline-block; padding: 4px 10px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 6px; font-size: 12px; font-weight: 500; border: 1px solid rgba(34, 197, 94, 0.3);">‚úÖ Purchased</span>',
                'declined': '<span style="display: inline-block; padding: 4px 10px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border-radius: 6px; font-size: 12px; font-weight: 500; border: 1px solid rgba(239, 68, 68, 0.3);">‚ùå Declined</span>'
            };
            return badges[status] || badges['pending'];
        }

        function getMaterialBadge(material) {
            return `<span style="display: inline-block; padding: 4px 10px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 4px; font-size: 12px; font-weight: 500;">${material}</span>`;
        }

        // Display inquiries in the table
        function displayInquiries(inquiries) {
            const tableBody = document.getElementById('inquiriesTableBody');
            const emptyState = document.getElementById('emptyInquiriesState');

            if (inquiries.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tableBody.innerHTML = inquiries.map(inquiry => {
                const date = new Date(inquiry.timestamp).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                const statusBadge = getStatusBadge(inquiry.status);
                const materialBadge = getMaterialBadge(inquiry.materialType || 'PLA');

                return `
                    <tr style="border-bottom: 1px solid #1f2937;">
                        <td style="padding: 16px 12px; color: #e5e7eb;">${date}</td>
                        <td style="padding: 16px 12px; color: #e5e7eb;">${inquiry.customerName}</td>
                        <td style="padding: 16px 12px; color: #9ca3af;">${inquiry.customerEmail || 'No email'}</td>
                        <td style="padding: 16px 12px; color: #9ca3af;">${(inquiry.hasFiles || (inquiry.files && inquiry.files.length > 0)) ?
                            `<div style="display: flex; align-items: center; gap: 8px; color: #22c55e;">
                                üìÑ ${inquiry.files.length} file${inquiry.files.length > 1 ? 's' : ''}
                                <button onclick="downloadFile('${inquiry.files?.[0]?.file_key || inquiry.files?.[0]?.filename || 'file'}', '${inquiry.files?.[0]?.original_name || 'download'}')"
                                    style="padding: 2px 6px; background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 3px; font-size: 10px; cursor: pointer;">‚¨áÔ∏è</button>
                            </div>` :
                            'No file'}</td>
                        <td style="padding: 16px 12px;">${materialBadge}</td>
                        <td style="padding: 16px 12px; color: #e5e7eb;">${inquiry.materialWeight}g</td>
                        <td style="padding: 16px 12px; color: #e5e7eb;">${inquiry.printTime}h</td>
                        <td style="padding: 16px 12px; color: #22c55e; font-weight: 600;">${typeof inquiry.totalQuote === 'number' ? '$' + inquiry.totalQuote.toFixed(2) : inquiry.totalQuote}</td>
                        <td style="padding: 16px 12px;">${statusBadge}</td>
                        <td style="padding: 16px 12px;">
                            <div style="display: flex; gap: 8px; flex-wrap: nowrap;">
                                <button onclick="editInquiry('${inquiry.id}')"
                                    style="padding: 5px 10px; background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap;">
                                    ‚úèÔ∏è Edit
                                </button>
                                ${inquiry.status !== 'purchased' ?
                                    `<button onclick="markAsPurchased('${inquiry.id}')"
                                        style="padding: 5px 10px; background: rgba(34, 197, 94, 0.15); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap;">
                                        üí∞ Purchase
                                    </button>` : ''
                                }
                                <button onclick="deleteInquiry('${inquiry.id}')"
                                    style="padding: 5px 10px; background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }


        // Refresh inquiries
        window.refreshInquiries = function() {
            loadInquiries();
            showNotification('Inquiries refreshed successfully', 'success');
        };

        // Make button functions globally accessible
        function editInquiry(id) { window.editInquiry(id); }
        function markAsPurchased(id) { window.markAsPurchased(id); }
        function deleteInquiry(id) { window.deleteInquiry(id); }

        // Clear all data function for development
        window.clearAllData = function() {
            if (confirm('This will clear ALL data including inquiries, orders, and settings. Are you sure?')) {
                localStorage.removeItem('inquiries');
                localStorage.removeItem('orders');
                localStorage.removeItem('inventory');
                localStorage.removeItem('printers');
                localStorage.removeItem('appSettings');
                localStorage.removeItem('test_inquiries');
                localStorage.removeItem('uploadedFiles');
                loadInquiries();
                showNotification('All data cleared successfully', 'success');
            }
        };

        // Filter inquiries
        window.filterInquiries = function() {
            const filter = document.getElementById('inquiryFilter').value;
            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');

            if (!filter) {
                displayInquiries(inquiries);
                return;
            }

            const filtered = inquiries.filter(inquiry => inquiry.status === filter);
            displayInquiries(filtered);
        };

        // Edit inquiry
        window.editInquiry = function(inquiryId) {
            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
            const inquiry = inquiries.find(i => i.id === inquiryId);

            if (!inquiry) {
                showNotification('Inquiry not found', 'error');
                return;
            }

            // Populate edit form
            document.getElementById('editInquiryId').value = inquiry.id;
            document.getElementById('editCustomerName').value = inquiry.customerName;
            document.getElementById('editCustomerEmail').value = inquiry.customerEmail;
            document.getElementById('editProjectDescription').value = inquiry.projectDescription || '';
            document.getElementById('editMaterialWeight').value = inquiry.materialWeight;
            document.getElementById('editPrintTime').value = inquiry.printTime;
            document.getElementById('editMaterialType').value = inquiry.materialType;
            document.getElementById('editInquiryStatus').value = inquiry.status;

            // Show modal
            document.getElementById('editInquiryModal').style.display = 'block';
        };

        // Close edit modal
        window.closeEditModal = function() {
            document.getElementById('editInquiryModal').style.display = 'none';
        };

        // Save inquiry edit
        window.saveInquiryEdit = function() {
            const inquiryId = parseInt(document.getElementById('editInquiryId').value);
            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
            const inquiryIndex = inquiries.findIndex(i => String(i.id) === String(inquiryId));

            if (inquiryIndex === -1) {
                showNotification('Inquiry not found', 'error');
                return;
            }

            // Validate required fields
            const customerName = document.getElementById('editCustomerName').value.trim();
            const customerEmail = document.getElementById('editCustomerEmail').value.trim();
            const materialWeight = document.getElementById('editMaterialWeight').value;
            const printTime = document.getElementById('editPrintTime').value;

            if (!customerName || !customerEmail || !materialWeight || !printTime) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            // Update inquiry
            inquiries[inquiryIndex] = {
                ...inquiries[inquiryIndex],
                customerName: customerName,
                customerEmail: customerEmail,
                projectDescription: document.getElementById('editProjectDescription').value.trim(),
                materialWeight: materialWeight,
                printTime: printTime,
                materialType: document.getElementById('editMaterialType').value,
                status: document.getElementById('editInquiryStatus').value
            };

            // Recalculate quote with new values
            const newQuote = calculateQuoteForInquiry(
                parseFloat(materialWeight),
                parseFloat(printTime),
                1, // numBeds default
                0, // laborTime default
                0  // shipping default
            );

            inquiries[inquiryIndex].totalQuote = `$${newQuote.toFixed(2)}`;

            // Save to localStorage
            localStorage.setItem('inquiries', JSON.stringify(inquiries));

            // Auto-sync edit to Cloudflare
            setTimeout(async () => {
                showNotification('‚òÅÔ∏è Syncing inquiry changes to Cloudflare...', 'info');
                try {
                    await syncToCloudflare('inquiry', inquiry);
                    showNotification('‚úÖ Changes synced to Cloudflare', 'success');
                    console.log('‚òÅÔ∏è Inquiry synced to Cloudflare:', inquiryId);
                } catch (error) {
                    console.error('Sync error:', error);
                }
            }, 500);

            // Close modal and refresh display
            closeEditModal();
            loadInquiries();
            showNotification('‚úÖ Inquiry updated successfully', 'success');
        };

        // Calculate quote for inquiry (simplified version)
        function calculateQuoteForInquiry(weight, time, beds = 1, laborMin = 0, shipping = 0) {
            const C4 = 1.1; // efficiency
            const C5 = 0.56; // printer cost/hr
            const C6 = 60; // labor rate/hr
            const C7 = 2.5; // bed cost
            const C8 = 5; // multi-day multiplier
            const C9 = 15; // material cost/kg

            const multidayFee = time > 24 ? (time / 24) * C8 : 0;
            const materialCost = (weight / 1000) * C9 * C4;
            const laborCost = (laborMin / 60) * C6;
            const printerCost = time * C5;
            const bedCost = (beds - 1) * C7;

            const subtotal = multidayFee + materialCost + laborCost + printerCost + bedCost + shipping;
            return Math.round(subtotal * (1.095 / 0.5) * 100) / 100;
        }

        // Mark as purchased
        window.markAsPurchased = function(inquiryId) {
            showConfirmModal(
                'Mark as Purchased',
                'Are you sure you want to mark this inquiry as purchased? This will change its status and could move it to orders.',
                () => {
                    const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
                    const inquiryIndex = inquiries.findIndex(i => String(i.id) === String(inquiryId));

                    if (inquiryIndex !== -1) {
                        inquiries[inquiryIndex].status = 'purchased';
                        inquiries[inquiryIndex].purchaseDate = new Date().toISOString();
                        localStorage.setItem('inquiries', JSON.stringify(inquiries));
                        loadInquiries();
                        showNotification('Inquiry marked as purchased', 'success');
                    }
                }
            );
        };

        // Helper function to get Cloudflare URL
        function getCloudflareUrl() {
            return localStorage.getItem('cloudflareWorkerUrl') || 'http://localhost:8787';
        }

        // Delete inquiry - ONLY FROM CLOUDFLARE
        window.deleteInquiry = function(inquiryId) {
            // Convert to string for consistent comparison
            const idStr = String(inquiryId);

            showConfirmModal(
                'Delete Inquiry',
                `Are you sure you want to delete this inquiry? This action cannot be undone.`,
                async () => {
                    try {
                        const cloudflareUrl = getCloudflareUrl();
                        let deletedFromCloudflare = false;

                        // Delete from Cloudflare only
                        console.log('Deleting inquiry from Cloudflare:', idStr);

                        const response = await fetch(`${cloudflareUrl}/api/inquiries/${idStr}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            console.log('Successfully deleted from Cloudflare');
                            deletedFromCloudflare = true;
                        } else if (response.status === 404) {
                            throw new Error('Inquiry not found in database');
                        } else {
                            const errorText = await response.text();
                            throw new Error(`Failed to delete: ${errorText}`);
                        }

                        // Reload the inquiries display
                        await loadInquiries();

                        // Show success notification
                        showNotification('‚úÖ Inquiry deleted successfully', 'success');
                    } catch (error) {
                        console.error('Unexpected error during delete:', error);
                        showNotification('‚ùå Error occurred while deleting - ' + error.message, 'error');
                    }
                }
            );
        };

        // Download file from Cloudflare R2
        window.downloadFile = async function(fileKey, originalName) {
            try {
                showNotification('üì• Downloading file...', 'info');

                // Get the Cloudflare worker URL
                const cloudflareUrl = getCloudflareUrl();
                if (!cloudflareUrl) {
                    showNotification('‚ùå Cloudflare not configured', 'error');
                    return;
                }

                if (!fileKey) {
                    showNotification('‚ùå File key not found', 'error');
                    return;
                }

                // Download from Cloudflare R2
                // Don't encode the forward slashes in the path
                const response = await fetch(`${cloudflareUrl}/api/download/${fileKey}`);

                if (!response.ok) {
                    throw new Error(`Download failed: ${response.statusText}`);
                }

                // Get the blob and create download
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = originalName || fileKey || 'download';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('‚úÖ File downloaded successfully', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showNotification(`‚ùå Failed to download: ${error.message}`, 'error');
            }
        };

        // Show confirmation modal
        function showConfirmModal(title, message, action) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            currentConfirmAction = action;
            document.getElementById('confirmModal').style.display = 'block';
        }

        // Close confirmation modal
        window.closeConfirmModal = function() {
            document.getElementById('confirmModal').style.display = 'none';
            currentConfirmAction = null;
        };

        // Confirm action
        window.confirmAction = function() {
            if (currentConfirmAction) {
                currentConfirmAction();
            }
            closeConfirmModal();
        };

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const editModal = document.getElementById('editInquiryModal');
            const confirmModal = document.getElementById('confirmModal');

            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
        });

        // Handle escape key to close modals
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeEditModal();
                closeConfirmModal();
            }
        });

        // ===== ORDERS MANAGEMENT SYSTEM =====

        // Initialize orders system
        window.loadOrders = function() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            displayOrders(orders);
            updateOrderStats(orders);
            populatePrinterOptions();
        };

        // Display orders in table
        function displayOrders(orders) {
            const tableBody = document.getElementById('ordersTableBody');
            const emptyState = document.getElementById('emptyOrdersState');

            if (orders.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tableBody.innerHTML = orders.map(order => {
                const dueDate = new Date(order.dueDate);
                const isOverdue = dueDate < new Date();
                const statusBadge = getOrderStatusBadge(order.status);
                const dueDateFormatted = dueDate.toLocaleDateString();

                return `
                    <tr style="border-bottom: 1px solid var(--border-secondary); ${isOverdue ? 'background: rgba(239, 68, 68, 0.05);' : ''}">
                        <td style="padding: 16px 12px; color: var(--text-primary); font-weight: 600;">#${order.id.toString().slice(-4)}</td>
                        <td style="padding: 16px 12px; color: var(--text-primary);">${order.customerName}</td>
                        <td style="padding: 16px 12px; color: var(--text-secondary); font-size: 13px;">${order.product}</td>
                        <td style="padding: 16px 12px; color: ${isOverdue ? '#ef4444' : 'var(--text-secondary)'}; font-size: 13px;">${dueDateFormatted}</td>
                        <td style="padding: 16px 12px; color: #22c55e; font-weight: 700;">$${order.value}</td>
                        <td style="padding: 16px 12px; color: var(--text-secondary); font-size: 13px;">${order.assignedPrinter || 'Unassigned'}</td>
                        <td style="padding: 16px 12px;">${statusBadge}</td>
                        <td style="padding: 16px 12px;">
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                <button onclick="updateOrderStatus(${order.id})" class="action-btn" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Status</button>
                                <button onclick="assignPrinterToOrder(${order.id})" class="action-btn" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Assign</button>
                                <button onclick="deleteOrder(${order.id})" class="action-btn" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get order status badge
        function getOrderStatusBadge(status) {
            const badges = {
                'pending': '<span style="background: rgba(251, 146, 60, 0.1); color: #f59e0b; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">‚è≥ Pending</span>',
                'printing': '<span style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">üñ®Ô∏è Printing</span>',
                'completed': '<span style="background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">‚úÖ Completed</span>',
                'shipped': '<span style="background: rgba(147, 51, 234, 0.1); color: #9333ea; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">üì¶ Shipped</span>'
            };
            return badges[status] || badges['pending'];
        }

        // Update order statistics
        function updateOrderStats(orders) {
            const pending = orders.filter(o => o.status === 'pending').length;
            const printing = orders.filter(o => o.status === 'printing').length;
            const completed = orders.filter(o => o.status === 'completed').length;
            const shipped = orders.filter(o => o.status === 'shipped').length;

            document.getElementById('pendingOrdersCount').textContent = pending;
            document.getElementById('printingOrdersCount').textContent = printing;
            document.getElementById('completedOrdersCount').textContent = completed;
            document.getElementById('shippedOrdersCount').textContent = shipped;
        }

        // Filter orders
        window.filterOrders = function() {
            const filter = document.getElementById('orderFilter').value;
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');

            if (!filter) {
                displayOrders(orders);
                return;
            }

            const filtered = orders.filter(order => order.status === filter);
            displayOrders(filtered);
        };

        // Sync from inquiries
        window.syncFromInquiries = function() {
            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
            const purchasedInquiries = inquiries.filter(i => i.status === 'purchased');
            const existingOrders = JSON.parse(localStorage.getItem('orders') || '[]');

            let newOrdersCount = 0;
            purchasedInquiries.forEach(inquiry => {
                // Check if order already exists
                const exists = existingOrders.find(o => o.inquiryId === inquiry.id);
                if (!exists) {
                    const newOrder = {
                        id: Date.now() + Math.random(),
                        inquiryId: inquiry.id,
                        customerName: inquiry.customerName,
                        customerEmail: inquiry.customerEmail,
                        product: inquiry.projectDescription || `${inquiry.materialType} Print`,
                        value: inquiry.totalQuote.replace('$', ''),
                        dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 7 days from now
                        status: 'pending',
                        assignedPrinter: null,
                        createdAt: new Date().toISOString()
                    };
                    existingOrders.push(newOrder);
                    newOrdersCount++;
                }
            });

            localStorage.setItem('orders', JSON.stringify(existingOrders));
            loadOrders();
            showNotification(`Synced ${newOrdersCount} new orders from inquiries`, 'success');
        };

        // Show add order modal
        window.showAddOrderModal = function() {
            populatePrinterOptions();
            document.getElementById('addOrderModal').style.display = 'block';
        };

        // Close add order modal
        window.closeAddOrderModal = function() {
            document.getElementById('addOrderModal').style.display = 'none';
            document.getElementById('addOrderForm').reset();
        };

        // Save new order
        window.saveNewOrder = function() {
            const customerName = document.getElementById('newOrderCustomer').value.trim();
            const customerEmail = document.getElementById('newOrderEmail').value.trim();
            const product = document.getElementById('newOrderProduct').value.trim();
            const value = document.getElementById('newOrderValue').value;
            const dueDate = document.getElementById('newOrderDueDate').value;
            const assignedPrinter = document.getElementById('newOrderPrinter').value;

            if (!customerName || !customerEmail || !product || !value || !dueDate) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const newOrder = {
                id: Date.now(),
                customerName,
                customerEmail,
                product,
                value: parseFloat(value).toFixed(2),
                dueDate,
                status: 'pending',
                assignedPrinter: assignedPrinter || null,
                createdAt: new Date().toISOString()
            };

            orders.unshift(newOrder);
            localStorage.setItem('orders', JSON.stringify(orders));
            closeAddOrderModal();
            loadOrders();
            showNotification('Order added successfully', 'success');
        };

        // Update order status
        window.updateOrderStatus = function(orderId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const orderIndex = orders.findIndex(o => o.id === orderId);

            if (orderIndex === -1) return;

            const currentStatus = orders[orderIndex].status;
            const statusOptions = ['pending', 'printing', 'completed', 'shipped'];
            const currentIndex = statusOptions.indexOf(currentStatus);
            const nextStatus = statusOptions[(currentIndex + 1) % statusOptions.length];

            orders[orderIndex].status = nextStatus;
            orders[orderIndex].updatedAt = new Date().toISOString();

            localStorage.setItem('orders', JSON.stringify(orders));
            loadOrders();
            showNotification(`Order status updated to ${nextStatus}`, 'success');
        };

        // Assign printer to order
        window.assignPrinterToOrder = function(orderId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const orderIndex = orders.findIndex(o => o.id === orderId);
            const printers = JSON.parse(localStorage.getItem('printers') || '[]');

            if (orderIndex === -1) return;

            const availablePrinters = printers.filter(p => p.status === 'idle' || p.status === 'online');
            if (availablePrinters.length === 0) {
                showNotification('No available printers for assignment', 'error');
                return;
            }

            const printerName = availablePrinters[0].name;
            orders[orderIndex].assignedPrinter = printerName;
            orders[orderIndex].status = 'printing';

            // Update printer status
            const printerIndex = printers.findIndex(p => p.name === printerName);
            if (printerIndex !== -1) {
                printers[printerIndex].status = 'printing';
                printers[printerIndex].currentJob = `Order #${orderId.toString().slice(-4)}`;
                localStorage.setItem('printers', JSON.stringify(printers));
            }

            localStorage.setItem('orders', JSON.stringify(orders));
            loadOrders();
            showNotification(`Order assigned to ${printerName}`, 'success');
        };

        // Delete order
        window.deleteOrder = function(orderId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = orders.find(o => o.id === orderId);

            if (!order) return;

            showConfirmModal(
                'Delete Order',
                `Are you sure you want to delete order #${orderId.toString().slice(-4)} for ${order.customerName}?`,
                () => {
                    const updatedOrders = orders.filter(o => o.id !== orderId);
                    localStorage.setItem('orders', JSON.stringify(updatedOrders));
                    loadOrders();
                    showNotification('Order deleted successfully', 'success');
                }
            );
        };

        // ===== INVENTORY MANAGEMENT SYSTEM =====

        // Initialize inventory system
        window.loadInventory = function() {
            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
            displayInventoryByCategory(inventory);
            updateInventoryStats(inventory);
            checkLowStock(inventory);
        };

        // Display inventory by material category
        function displayInventoryByCategory(inventory) {
            const categories = ['PLA', 'PETG', 'ABS', 'TPU', 'Specialty'];

            categories.forEach(category => {
                const categoryInventory = inventory.filter(item => item.type === category);
                const containerId = category.toLowerCase() + 'Materials';
                const container = document.getElementById(containerId);

                if (!container) return;

                if (categoryInventory.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 20px;">No materials in this category</div>';
                    return;
                }

                container.innerHTML = categoryInventory.map(item => createMaterialCard(item)).join('');
            });
        }

        // Create material card HTML
        function createMaterialCard(material) {
            const usagePercentage = ((material.initialWeight - material.currentWeight) / material.initialWeight * 100).toFixed(1);
            const isLowStock = material.currentWeight <= material.lowStockThreshold;

            return `
                <div class="card" style="padding: 12px; margin-bottom: 8px; ${isLowStock ? 'border: 1px solid #ef4444; background: rgba(239, 68, 68, 0.05);' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${material.color} ${material.type}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">$${material.costPerKg}/kg</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: var(--text-secondary);">${material.currentWeight}kg / ${material.initialWeight}kg</div>
                            ${isLowStock ? '<div style="font-size: 10px; color: #ef4444; font-weight: 600;">LOW STOCK</div>' : ''}
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; margin-bottom: 8px;">
                        <div style="height: 100%; background: ${isLowStock ? '#ef4444' : '#22c55e'}; width: ${100 - usagePercentage}%; border-radius: 3px;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 10px; color: var(--text-muted);">${usagePercentage}% used</div>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="useMaterial(${material.id})" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 2px 6px; border-radius: 3px; font-size: 9px; cursor: pointer;">Use</button>
                            <button onclick="restockMaterial(${material.id})" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 2px 6px; border-radius: 3px; font-size: 9px; cursor: pointer;">Restock</button>
                            <button onclick="deleteMaterial(${material.id})" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 2px 6px; border-radius: 3px; font-size: 9px; cursor: pointer;">Delete</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update inventory statistics
        function updateInventoryStats(inventory) {
            const totalMaterials = inventory.length;
            const lowStockItems = inventory.filter(item => item.currentWeight <= item.lowStockThreshold).length;
            const totalValue = inventory.reduce((sum, item) => sum + (item.currentWeight * item.costPerKg), 0);

            document.getElementById('totalMaterialsCount').textContent = totalMaterials;
            document.getElementById('lowStockCount').textContent = lowStockItems;
            document.getElementById('totalInventoryValue').textContent = `$${totalValue.toFixed(2)}`;
        }

        // Check and display low stock alerts
        function checkLowStock(inventory) {
            const lowStockItems = inventory.filter(item => item.currentWeight <= item.lowStockThreshold);
            const alertContainer = document.getElementById('lowStockAlerts');
            const alertList = document.getElementById('lowStockList');

            if (lowStockItems.length === 0) {
                alertContainer.style.display = 'none';
                return;
            }

            alertContainer.style.display = 'block';
            alertList.innerHTML = lowStockItems.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; margin-bottom: 4px;">
                    <span style="font-size: 13px;">${item.color} ${item.type} - ${item.currentWeight}kg remaining</span>
                    <button onclick="restockMaterial(${item.id})" style="background: #22c55e; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">Restock</button>
                </div>
            `).join('');
        }

        // Show add material modal
        window.showAddMaterialModal = function() {
            document.getElementById('addMaterialModal').style.display = 'block';
        };

        // Close add material modal
        window.closeAddMaterialModal = function() {
            document.getElementById('addMaterialModal').style.display = 'none';
            document.getElementById('addMaterialForm').reset();
        };

        // Add material to specific category
        window.addMaterialToCategory = function(category) {
            document.getElementById('newMaterialType').value = category;
            showAddMaterialModal();
        };

        // Save new material
        window.saveNewMaterial = function() {
            const type = document.getElementById('newMaterialType').value;
            const color = document.getElementById('newMaterialColor').value.trim();
            const weight = parseFloat(document.getElementById('newMaterialWeight').value);
            const cost = parseFloat(document.getElementById('newMaterialCost').value);
            const threshold = parseFloat(document.getElementById('newMaterialThreshold').value);

            if (!type || !color || !weight || !cost || !threshold) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
            const newMaterial = {
                id: Date.now(),
                type,
                color,
                initialWeight: weight,
                currentWeight: weight,
                costPerKg: cost,
                lowStockThreshold: threshold,
                createdAt: new Date().toISOString()
            };

            inventory.push(newMaterial);
            localStorage.setItem('inventory', JSON.stringify(inventory));
            closeAddMaterialModal();
            loadInventory();
            showNotification(`${color} ${type} added to inventory`, 'success');
        };

        // Use material
        window.useMaterial = function(materialId) {
            const amount = parseFloat(prompt('Enter amount to use (kg):'));
            if (!amount || amount <= 0) return;

            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
            const materialIndex = inventory.findIndex(m => m.id === materialId);

            if (materialIndex === -1) return;

            if (amount > inventory[materialIndex].currentWeight) {
                showNotification('Not enough material in stock', 'error');
                return;
            }

            inventory[materialIndex].currentWeight = Math.max(0, inventory[materialIndex].currentWeight - amount);
            inventory[materialIndex].lastUsed = new Date().toISOString();

            localStorage.setItem('inventory', JSON.stringify(inventory));
            loadInventory();
            showNotification(`Used ${amount}kg of ${inventory[materialIndex].color} ${inventory[materialIndex].type}`, 'success');
        };

        // Restock material
        window.restockMaterial = function(materialId) {
            const amount = parseFloat(prompt('Enter amount to restock (kg):'));
            if (!amount || amount <= 0) return;

            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
            const materialIndex = inventory.findIndex(m => m.id === materialId);

            if (materialIndex === -1) return;

            inventory[materialIndex].currentWeight += amount;
            inventory[materialIndex].lastRestocked = new Date().toISOString();

            localStorage.setItem('inventory', JSON.stringify(inventory));
            loadInventory();
            showNotification(`Restocked ${amount}kg of ${inventory[materialIndex].color} ${inventory[materialIndex].type}`, 'success');
        };

        // Delete material
        window.deleteMaterial = function(materialId) {
            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
            const material = inventory.find(m => m.id === materialId);

            if (!material) return;

            showConfirmModal(
                'Delete Material',
                `Are you sure you want to delete ${material.color} ${material.type} from inventory?`,
                () => {
                    const updatedInventory = inventory.filter(m => m.id !== materialId);
                    localStorage.setItem('inventory', JSON.stringify(updatedInventory));
                    loadInventory();
                    showNotification('Material deleted from inventory', 'success');
                }
            );
        };

        // Generate inventory report
        window.generateInventoryReport = function() {
            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
            if (inventory.length === 0) {
                showNotification('No inventory data to export', 'error');
                return;
            }

            const reportData = inventory.map(item => ({
                Type: item.type,
                Color: item.color,
                'Current Weight (kg)': item.currentWeight,
                'Initial Weight (kg)': item.initialWeight,
                'Cost per kg': `$${item.costPerKg}`,
                'Total Value': `$${(item.currentWeight * item.costPerKg).toFixed(2)}`,
                'Low Stock Threshold': `${item.lowStockThreshold}kg`,
                'Status': item.currentWeight <= item.lowStockThreshold ? 'LOW STOCK' : 'IN STOCK'
            }));

            const csv = convertToCSV(reportData);
            downloadCSV(csv, `inventory_report_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification('Inventory report generated', 'success');
        };

        // ===== PRINTER MANAGEMENT SYSTEM =====

        // Initialize printers system
        window.loadPrinters = function() {
            const printers = JSON.parse(localStorage.getItem('printers') || '[]');
            displayPrinters(printers);
            updatePrinterStats(printers);
        };

        // Display printers
        function displayPrinters(printers) {
            const printerGrid = document.getElementById('printerGrid');
            const emptyState = document.getElementById('emptyPrintersState');

            if (printers.length === 0) {
                printerGrid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            printerGrid.innerHTML = printers.map(printer => createPrinterCard(printer)).join('');
        }

        // Create printer card
        function createPrinterCard(printer) {
            const statusColors = {
                'online': '#22c55e',
                'printing': '#f59e0b',
                'idle': '#3b82f6',
                'offline': '#6b7280',
                'error': '#ef4444'
            };

            const statusColor = statusColors[printer.status] || '#6b7280';
            const progress = printer.progress || 0;

            return `
                <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">${printer.name}</h3>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">${printer.model}</div>
                        </div>
                        <div style="background: ${statusColor}20; color: ${statusColor}; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; border: 1px solid ${statusColor}40;">
                            ${printer.status.charAt(0).toUpperCase() + printer.status.slice(1)}
                        </div>
                    </div>

                    ${printer.status === 'printing' ? `
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 12px; color: var(--text-secondary);">Current Job: ${printer.currentJob || 'Unknown'}</span>
                                <span style="font-size: 12px; color: var(--text-secondary);">${progress}%</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px;">
                                <div style="height: 100%; background: #f59e0b; width: ${progress}%; border-radius: 3px;"></div>
                            </div>
                        </div>
                    ` : ''}

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; font-size: 12px;">
                        <div>
                            <div style="color: var(--text-muted);">IP Address</div>
                            <div style="color: var(--text-secondary);">${printer.ipAddress || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-muted);">Last Seen</div>
                            <div style="color: var(--text-secondary);">${getTimeAgo(printer.lastSeen)}</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        ${printer.status === 'printing' ? `
                            <button onclick="pausePrinter(${printer.id})" style="background: rgba(251, 146, 60, 0.1); color: #f59e0b; border: 1px solid rgba(251, 146, 60, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; flex: 1;">‚è∏Ô∏è Pause</button>
                        ` : printer.status === 'idle' || printer.status === 'online' ? `
                            <button onclick="assignJobToPrinter(${printer.id})" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; flex: 1;">üñ®Ô∏è Assign Job</button>
                        ` : ''}
                        <button onclick="refreshPrinter(${printer.id})" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">üîÑ</button>
                        <button onclick="deletePrinter(${printer.id})" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }

        // Update printer statistics
        function updatePrinterStats(printers) {
            const online = printers.filter(p => p.status === 'online' || p.status === 'idle').length;
            const printing = printers.filter(p => p.status === 'printing').length;
            const idle = printers.filter(p => p.status === 'idle').length;
            const errors = printers.filter(p => p.status === 'error' || p.status === 'offline').length;

            document.getElementById('onlinePrintersCount').textContent = online;
            document.getElementById('printingCount').textContent = printing;
            document.getElementById('idlePrintersCount').textContent = idle;
            document.getElementById('errorPrintersCount').textContent = errors;
        }

        // Show add printer modal
        window.showAddPrinterModal = function() {
            document.getElementById('addPrinterModal').style.display = 'block';
        };

        // Close add printer modal
        window.closeAddPrinterModal = function() {
            document.getElementById('addPrinterModal').style.display = 'none';
            document.getElementById('addPrinterForm').reset();
        };

        // Save new printer
        window.saveNewPrinter = function() {
            const name = document.getElementById('newPrinterName').value.trim();
            const model = document.getElementById('newPrinterModel').value;
            const ipAddress = document.getElementById('newPrinterIP').value.trim();
            const status = document.getElementById('newPrinterStatus').value;

            if (!name || !model) {
                showNotification('Please fill in printer name and model', 'error');
                return;
            }

            const printers = JSON.parse(localStorage.getItem('printers') || '[]');
            const newPrinter = {
                id: Date.now(),
                name,
                model,
                ipAddress: ipAddress || null,
                status,
                currentJob: null,
                progress: 0,
                lastSeen: new Date().toISOString(),
                createdAt: new Date().toISOString()
            };

            printers.push(newPrinter);
            localStorage.setItem('printers', JSON.stringify(printers));
            closeAddPrinterModal();
            loadPrinters();
            showNotification(`${name} added to printer fleet`, 'success');
        };

        // Populate printer options in order form
        function populatePrinterOptions() {
            const printers = JSON.parse(localStorage.getItem('printers') || '[]');
            const orderPrinterSelect = document.getElementById('newOrderPrinter');

            if (!orderPrinterSelect) return;

            const availablePrinters = printers.filter(p => p.status === 'idle' || p.status === 'online');
            orderPrinterSelect.innerHTML = '<option value="">No printer assigned</option>' +
                availablePrinters.map(p => `<option value="${p.name}">${p.name} (${p.model})</option>`).join('');
        }

        // Printer actions
        window.pausePrinter = function(printerId) {
            showNotification('Printer pause command sent (simulation)', 'info');
        };

        window.assignJobToPrinter = function(printerId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const pendingOrders = orders.filter(o => o.status === 'pending' && !o.assignedPrinter);

            if (pendingOrders.length === 0) {
                showNotification('No pending orders available for assignment', 'info');
                return;
            }

            const printers = JSON.parse(localStorage.getItem('printers') || '[]');
            const printerIndex = printers.findIndex(p => p.id === printerId);
            const orderToAssign = pendingOrders[0];

            if (printerIndex !== -1) {
                printers[printerIndex].status = 'printing';
                printers[printerIndex].currentJob = `Order #${orderToAssign.id.toString().slice(-4)}`;
                printers[printerIndex].progress = 0;

                // Update order
                const orderIndex = orders.findIndex(o => o.id === orderToAssign.id);
                if (orderIndex !== -1) {
                    orders[orderIndex].assignedPrinter = printers[printerIndex].name;
                    orders[orderIndex].status = 'printing';
                }

                localStorage.setItem('printers', JSON.stringify(printers));
                localStorage.setItem('orders', JSON.stringify(orders));
                loadPrinters();
                loadOrders();
                showNotification(`Job assigned to ${printers[printerIndex].name}`, 'success');

                // Simulate progress
                setTimeout(() => simulatePrintProgress(printerId), 2000);
            }
        };

        // Simulate print progress
        function simulatePrintProgress(printerId) {
            const printers = JSON.parse(localStorage.getItem('printers') || '[]');
            const printerIndex = printers.findIndex(p => p.id === printerId);

            if (printerIndex === -1 || printers[printerIndex].status !== 'printing') return;

            printers[printerIndex].progress = Math.min(100, (printers[printerIndex].progress || 0) + Math.random() * 10);
            localStorage.setItem('printers', JSON.stringify(printers));
            loadPrinters();

            if (printers[printerIndex].progress < 100) {
                setTimeout(() => simulatePrintProgress(printerId), 3000);
            } else {
                // Print completed
                printers[printerIndex].status = 'idle';
                printers[printerIndex].currentJob = null;
                printers[printerIndex].progress = 0;
                localStorage.setItem('printers', JSON.stringify(printers));
                loadPrinters();
                showNotification(`Print job completed on ${printers[printerIndex].name}`, 'success');
            }
        }

        window.refreshPrinter = function(printerId) {
            const printers = JSON.parse(localStorage.getItem('printers') || '[]');
            const printerIndex = printers.findIndex(p => p.id === printerId);

            if (printerIndex !== -1) {
                printers[printerIndex].lastSeen = new Date().toISOString();
                localStorage.setItem('printers', JSON.stringify(printers));
                loadPrinters();
                showNotification('Printer status refreshed', 'success');
            }
        };

        window.deletePrinter = function(printerId) {
            const printers = JSON.parse(localStorage.getItem('printers') || '[]');
            const printer = printers.find(p => p.id === printerId);

            if (!printer) return;

            showConfirmModal(
                'Delete Printer',
                `Are you sure you want to remove ${printer.name} from your printer fleet?`,
                () => {
                    const updatedPrinters = printers.filter(p => p.id !== printerId);
                    localStorage.setItem('printers', JSON.stringify(updatedPrinters));
                    loadPrinters();
                    showNotification('Printer removed from fleet', 'success');
                }
            );
        };

        window.refreshPrinterStatus = function() {
            loadPrinters();
            showNotification('All printer statuses refreshed', 'success');
        };

        // ===== SETTINGS MANAGEMENT SYSTEM =====

        // Initialize settings
        window.loadSettings = function() {
            const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');

            // Populate form fields
            if (settings.companyName) document.getElementById('companyName').value = settings.companyName;
            if (settings.contactEmail) document.getElementById('contactEmail').value = settings.contactEmail;
            if (settings.phoneNumber) document.getElementById('phoneNumber').value = settings.phoneNumber;
            if (settings.businessAddress) document.getElementById('businessAddress').value = settings.businessAddress;
            if (settings.defaultMaterialCost) document.getElementById('defaultMaterialCost').value = settings.defaultMaterialCost;
            if (settings.laborRate) document.getElementById('laborRate').value = settings.laborRate;
            if (settings.printerRate) document.getElementById('printerRate').value = settings.printerRate;
            if (settings.currency) document.getElementById('currency').value = settings.currency;
            if (settings.stlFolder) document.getElementById('stlFolder').value = settings.stlFolder;
            if (settings.exportsFolder) document.getElementById('exportsFolder').value = settings.exportsFolder;
            if (settings.backupFolder) document.getElementById('backupFolder').value = settings.backupFolder;

            // Set checkboxes
            document.getElementById('orderNotifications').checked = settings.orderNotifications !== false;
            document.getElementById('printerNotifications').checked = settings.printerNotifications !== false;
            document.getElementById('lowStockNotifications').checked = settings.lowStockNotifications !== false;
            document.getElementById('dueDateNotifications').checked = settings.dueDateNotifications !== false;
        };

        // Save settings
        window.saveSettings = function() {
            const settings = {
                companyName: document.getElementById('companyName').value,
                contactEmail: document.getElementById('contactEmail').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                businessAddress: document.getElementById('businessAddress').value,
                defaultMaterialCost: document.getElementById('defaultMaterialCost').value,
                laborRate: document.getElementById('laborRate').value,
                printerRate: document.getElementById('printerRate').value,
                currency: document.getElementById('currency').value,
                stlFolder: document.getElementById('stlFolder').value,
                exportsFolder: document.getElementById('exportsFolder').value,
                backupFolder: document.getElementById('backupFolder').value,
                orderNotifications: document.getElementById('orderNotifications').checked,
                printerNotifications: document.getElementById('printerNotifications').checked,
                lowStockNotifications: document.getElementById('lowStockNotifications').checked,
                dueDateNotifications: document.getElementById('dueDateNotifications').checked,
                lastSaved: new Date().toISOString()
            };

            localStorage.setItem('appSettings', JSON.stringify(settings));
            showNotification('Settings saved successfully', 'success');
        };

        // Export settings
        window.exportSettings = function() {
            const allData = {
                settings: JSON.parse(localStorage.getItem('appSettings') || '{}'),
                inquiries: JSON.parse(localStorage.getItem('inquiries') || '[]'),
                orders: JSON.parse(localStorage.getItem('orders') || '[]'),
                inventory: JSON.parse(localStorage.getItem('inventory') || '[]'),
                printers: JSON.parse(localStorage.getItem('printers') || '[]'),
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `3d_print_manager_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showNotification('Settings and data exported successfully', 'success');
        };

        // Import settings
        window.importSettings = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);

                        if (data.settings) localStorage.setItem('appSettings', JSON.stringify(data.settings));
                        if (data.inquiries) localStorage.setItem('inquiries', JSON.stringify(data.inquiries));
                        if (data.orders) localStorage.setItem('orders', JSON.stringify(data.orders));
                        if (data.inventory) localStorage.setItem('inventory', JSON.stringify(data.inventory));
                        if (data.printers) localStorage.setItem('printers', JSON.stringify(data.printers));

                        showNotification('Settings and data imported successfully', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } catch (error) {
                        showNotification('Invalid backup file format', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        // Other settings functions
        window.testCloudConnection = function() {
            showNotification('Testing cloud connection... (simulation)', 'info');
            setTimeout(() => {
                showNotification('Cloud connection test completed', 'success');
            }, 2000);
        };

        window.createBackup = function() {
            exportSettings(); // Use the same export functionality
        };

        window.restoreBackup = function() {
            importSettings(); // Use the same import functionality
        };

        window.resetAllData = function() {
            showConfirmModal(
                'Reset All Data',
                'Are you sure you want to reset ALL application data? This action cannot be undone!',
                () => {
                    localStorage.clear();
                    showNotification('All data has been reset', 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            );
        };

        // ===== UTILITY FUNCTIONS =====

        // Get time ago helper
        function getTimeAgo(dateString) {
            if (!dateString) return 'Never';
            const now = new Date();
            const date = new Date(dateString);
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        // Convert to CSV
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';

            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');
            const csvRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                }).join(',');
            });

            return [csvHeaders, ...csvRows].join('\n');
        }

        // Download CSV
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Update page load initialization
        document.addEventListener('DOMContentLoaded', async function() {
            initializeCalculator();
            loadInquiries();
            loadOrders();
            loadInventory();
            loadPrinters();
            loadSettings();

            // Initialize default data if empty
            initializeDefaultData();

            // Check Cloudflare connection
            await checkCloudflareConnection();
        });

        // Initialize default data
        function initializeDefaultData() {
            // Add sample inventory if empty
            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
            if (inventory.length === 0) {
                const sampleInventory = [
                    { id: 1, type: 'PLA', color: 'Black', initialWeight: 1.0, currentWeight: 0.7, costPerKg: 15, lowStockThreshold: 0.2, createdAt: new Date().toISOString() },
                    { id: 2, type: 'PLA', color: 'White', initialWeight: 1.0, currentWeight: 0.8, costPerKg: 15, lowStockThreshold: 0.2, createdAt: new Date().toISOString() },
                    { id: 3, type: 'PETG', color: 'Clear', initialWeight: 1.0, currentWeight: 0.9, costPerKg: 18, lowStockThreshold: 0.2, createdAt: new Date().toISOString() },
                    { id: 4, type: 'ABS', color: 'Red', initialWeight: 1.0, currentWeight: 0.1, costPerKg: 16, lowStockThreshold: 0.2, createdAt: new Date().toISOString() }
                ];
                localStorage.setItem('inventory', JSON.stringify(sampleInventory));
            }

            // Add sample printers if empty
            const printers = JSON.parse(localStorage.getItem('printers') || '[]');
            if (printers.length === 0) {
                const samplePrinters = [
                    { id: 1, name: 'Bambu X1C #1', model: 'Bambu X1C', status: 'idle', ipAddress: '192.168.1.101', currentJob: null, progress: 0, lastSeen: new Date().toISOString(), createdAt: new Date().toISOString() },
                    { id: 2, name: 'Bambu P1S #1', model: 'Bambu P1S', status: 'printing', ipAddress: '192.168.1.102', currentJob: 'Order #1234', progress: 65, lastSeen: new Date().toISOString(), createdAt: new Date().toISOString() },
                    { id: 3, name: 'Bambu A1 #1', model: 'Bambu A1', status: 'online', ipAddress: '192.168.1.103', currentJob: null, progress: 0, lastSeen: new Date().toISOString(), createdAt: new Date().toISOString() }
                ];
                localStorage.setItem('printers', JSON.stringify(samplePrinters));
            }
        }

        // File upload handling for quote calculator
        let uploadedFiles = [];
        let pendingFiles = []; // Store files to upload later

        // Global file storage for inquiries
        window.globalFileStorage = window.globalFileStorage || {};

        // New function to upload files to Cloudflare with loading bar
        async function uploadFilesToCloudflare() {
            console.log('uploadFilesToCloudflare called');
            console.log('pendingFiles:', pendingFiles);

            if (!pendingFiles || pendingFiles.length === 0) {
                console.log('No pending files to upload');
                return { success: true, files: [] };
            }

            console.log('Found', pendingFiles.length, 'files to upload');

            // Show loading bar
            const loadingBar = document.createElement('div');
            loadingBar.id = 'uploadLoadingBar';
            loadingBar.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000;
                    background: #2a2a2a; border: 1px solid #3b82f6; border-radius: 12px; padding: 24px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
                    <div style="color: #e5e7eb; font-size: 16px; margin-bottom: 12px;">‚òÅÔ∏è Uploading to Cloudflare...</div>
                    <div style="width: 300px; height: 8px; background: #374151; border-radius: 4px; overflow: hidden;">
                        <div style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #22c55e);
                            border-radius: 4px; transition: width 0.3s ease; animation: progress 2s ease-in-out infinite;"
                            id="uploadProgress"></div>
                    </div>
                    <div style="color: #9ca3af; font-size: 12px; margin-top: 8px; text-align: center;"
                        id="uploadStatus">Preparing upload...</div>
                </div>
                <style>
                    @keyframes progress {
                        0% { width: 0%; }
                        50% { width: 70%; }
                        100% { width: 100%; }
                    }
                </style>
            `;
            document.body.appendChild(loadingBar);

            const cloudflareWorkerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'http://localhost:8787';
            const formData = new FormData();

            console.log('Creating FormData with files:');
            for (let file of pendingFiles) {
                console.log('Adding file to FormData:', {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    isFile: file instanceof File
                });
                formData.append('files', file);
            }

            try {
                // Update status
                document.getElementById('uploadStatus').textContent = `Uploading ${pendingFiles.length} file(s)...`;

                console.log('Attempting upload to:', `${cloudflareWorkerUrl}/api/upload`);
                console.log('Files to upload:', pendingFiles.length);

                const response = await fetch(`${cloudflareWorkerUrl}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                console.log('Upload response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Upload failed with status:', response.status, 'Error:', errorText);
                    throw new Error(`Upload failed: ${response.status} - ${errorText || response.statusText}`);
                }

                const result = await response.json();

                // Update progress to 100%
                document.getElementById('uploadProgress').style.width = '100%';
                document.getElementById('uploadStatus').textContent = 'Upload complete!';

                // Update storage display - use the correct function name
                if (typeof updateCloudflareUsageBar === 'function') {
                    await updateCloudflareUsageBar();
                }

                // Clear pending files
                pendingFiles = [];
                uploadedFiles = result.files || [];

                // Remove loading bar on success
                setTimeout(() => {
                    if (document.body.contains(loadingBar)) {
                        document.body.removeChild(loadingBar);
                    }
                }, 1000);

                return { success: true, files: result.files || [] };
            } catch (error) {
                console.error('Upload error details:', {
                    message: error.message,
                    stack: error.stack,
                    error: error
                });

                // Show error in loading bar
                document.getElementById('uploadStatus').textContent = `Upload failed: ${error.message}`;

                setTimeout(() => {
                    if (document.body.contains(loadingBar)) {
                        document.body.removeChild(loadingBar);
                    }
                }, 3000);

                showNotification(`Upload failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function handleFileUpload(event) {
            const files = Array.from(event.target.files);

            if (files.length === 0) {
                showNotification('‚ùå No files selected', 'error');
                return;
            }

            console.log('Files selected for later upload:', files.map(f => f.name));

            // Store files for later upload (don't upload immediately)
            pendingFiles = files;

            // Display files locally without uploading yet
            uploadedFiles = pendingFiles.map((file, index) => ({
                id: Date.now() + index,
                name: file.name,
                size: file.size,
                type: file.type,
                pending: true // Mark as not uploaded yet
            }));

            displayUploadedFiles();
            showNotification(`üìÅ ${files.length} file(s) ready to upload when saving`, 'info');

            // Store globally for inquiry access (but mark as pending)
            const currentTimestamp = Date.now();
            window.globalFileStorage[currentTimestamp] = uploadedFiles;
            window.currentFileSession = currentTimestamp;

            console.log('üìÅ Files ready for upload:', uploadedFiles);

            // Auto-estimate weight for STL files
            const stlFile = files.find(f => f.name.toLowerCase().endsWith('.stl'));
            if (stlFile) {
                const estimatedWeight = Math.round(stlFile.size / 10000);
                if (estimatedWeight > 0) {
                    const weightInput = document.getElementById('materialWeight');
                    if (weightInput && !weightInput.value) {
                        weightInput.value = estimatedWeight;
                        calculateQuote();
                        showNotification(`üìä Auto-estimated weight: ${estimatedWeight}g from STL`, 'info');
                    }
                }
            }
        }

        function displayUploadedFiles() {
            const fileDisplay = document.getElementById('fileDisplay');
            const fileList = document.getElementById('fileList');

            if (!fileDisplay || !fileList) {
                console.warn('File display elements not found');
                return;
            }

            if (uploadedFiles.length === 0) {
                fileDisplay.style.display = 'none';
                return;
            }

            fileDisplay.style.display = 'block';
            fileList.innerHTML = uploadedFiles.map(file => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(34, 197, 94, 0.1); border-radius: 6px; border: 1px solid rgba(34, 197, 94, 0.2); margin-bottom: 6px;">
                    <div>
                        <span style="color: #22c55e; font-weight: 600;">üìÑ ${file.name}</span>
                        <span style="color: var(--text-muted); margin-left: 8px;">(${(file.size/1024).toFixed(1)}KB)</span>
                    </div>
                    <button onclick="removeUploadedFile(${file.id})" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 16px; padding: 4px;">√ó</button>
                </div>
            `).join('');

            console.log('‚úÖ Displayed', uploadedFiles.length, 'uploaded files');
        }

        function removeUploadedFile(fileId) {
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
            displayUploadedFiles();
            showNotification('üìÅ File removed', 'info');
        }

        // Save quote to inquiries with server sync
        async function saveToInquiries() {
            const customerName = document.getElementById('customerName')?.value || '';
            const customerEmail = document.getElementById('customerEmail')?.value || '';

            if (!customerName) {
                showNotification('‚ùå Please enter customer name', 'error');
                return;
            }

            // Make sure we have uploaded files
            console.log('Current uploaded files:', uploadedFiles);

            const materialWeight = document.getElementById('materialWeight')?.value || 0;
            const printTime = document.getElementById('printTime')?.value || 0;
            const totalQuote = document.getElementById('totalQuote')?.textContent || '$0.00';

            const inquiryId = Date.now();

            // Create inquiry with proper file data including server references
            const inquiry = {
                id: inquiryId,
                timestamp: new Date().toISOString(),
                date: new Date().toISOString(),
                customerName: customerName,
                customerEmail: customerEmail,
                materialWeight: materialWeight,
                printTime: printTime,
                materialType: document.getElementById('materialType')?.value || 'PLA',
                material: document.getElementById('materialType')?.value || 'PLA',
                totalQuote: totalQuote,
                status: 'pending',
                files: uploadedFiles.map(f => ({
                    name: f.name,
                    size: f.size,
                    type: f.type,
                    id: f.id,
                    serverFilename: f.serverFilename, // Server filename for downloads
                    serverPath: f.serverPath,
                    hasData: true
                })),
                hasFiles: uploadedFiles.length > 0,
                fileName: uploadedFiles.length > 0 ? uploadedFiles[0].name : null
            };

            console.log('üíæ Saving inquiry with server files:', {
                customer: customerName,
                hasFiles: inquiry.hasFiles,
                fileCount: inquiry.files.length,
                fileNames: inquiry.files.map(f => f.name),
                serverFiles: inquiry.files.map(f => f.serverFilename)
            });

            // Save to server first
            try {
                const response = await fetch('/api/inquiries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(inquiry)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Inquiry saved to server:', result);

                    // Also save locally for quick access
                    let inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
                    inquiries.unshift(inquiry); // Add to beginning instead of end
                    localStorage.setItem('inquiries', JSON.stringify(inquiries));

                    showNotification(`‚úÖ Quote for ${customerName} saved with ${inquiry.files.length} 3D file(s)!`, 'success');

                    // Clear form and refresh
                    clearFormAndRefresh();

                    // Reload inquiries to show the new one
                    loadInquiries();
                } else {
                    throw new Error('Failed to save to server');
                }
            } catch (error) {
                console.error('Save error:', error);

                // Fallback to local storage
                let inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
                inquiries.push(inquiry);
                localStorage.setItem('inquiries', JSON.stringify(inquiries));

                showNotification(`‚úÖ Quote saved locally for ${customerName}`, 'success');
                clearFormAndRefresh();
            }
        }

        function clearFormAndRefresh() {
            // Clear form but don't lose file references
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';

            // Clear uploaded files for next inquiry
            uploadedFiles = [];
            displayUploadedFiles();

            // Refresh inquiries to show the new one
            setTimeout(() => {
                loadInquiries();
            }, 500);
        }

        // Download files from inquiry - download actual 3D files from server
        async function downloadInquiryFiles(inquiryId) {
            console.log('üîç Downloading 3D files for inquiry:', inquiryId);

            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
            // Convert to string for comparison since IDs might be numbers or strings
            const inquiry = inquiries.find(i => String(i.id) === String(inquiryId));

            if (!inquiry) {
                console.error('Inquiry not found:', inquiryId, 'Available:', inquiries.map(i => i.id));
                showNotification('‚ùå Inquiry not found', 'error');
                return;
            }

            console.log('Found inquiry:', inquiry);
            console.log('Inquiry files:', inquiry.files);
            console.log('Has files flag:', inquiry.hasFiles);

            // Check if inquiry has files
            if (!inquiry.files || inquiry.files.length === 0) {
                console.error('No files in inquiry:', inquiry);
                showNotification('‚ö†Ô∏è No 3D files attached to this inquiry', 'warning');
                return;
            }

            console.log('Files to download:', inquiry.files);

            // Download files from server
            try {
                let downloadCount = 0;

                for (const file of inquiry.files) {
                    console.log('Processing file:', file);

                    // Check if file has server reference
                    if (file.serverFilename) {
                        console.log('Downloading from server:', file.serverFilename);
                        // Download actual 3D file from server
                        const response = await fetch(`/api/download-inquiry-file/${file.serverFilename}`);

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = file.name; // Use original filename with .stl/.3mf/.obj extension
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                            downloadCount++;
                            console.log('‚úÖ Downloaded 3D file:', file.name);
                        } else {
                            console.warn(`Failed to download ${file.name} from server`);
                        }
                    } else {
                        console.warn(`No server file reference for ${file.name}`);
                    }
                }

                if (downloadCount > 0) {
                    showNotification(`‚úÖ Downloaded ${downloadCount} 3D file(s)`, 'success');
                } else {
                    showNotification('‚ö†Ô∏è No files could be downloaded - please re-upload', 'warning');
                }
            } catch (error) {
                console.error('Download error:', error);
                showNotification('‚ùå Error downloading 3D files', 'error');
            }
        }

        // Make file upload functions global
        window.handleFileUpload = handleFileUpload;
        window.displayUploadedFiles = displayUploadedFiles;
        window.removeUploadedFile = removeUploadedFile;
        window.saveToInquiries = saveToInquiries;
        window.downloadInquiryFiles = downloadInquiryFiles;

        // Cloudflare connection functions
        async function checkCloudflareStatus() {
            showNotification('üîç Checking Cloudflare status...', 'info');

            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'http://localhost:8787';
                const response = await fetch(`${workerUrl}/api/sync-status`);
                const result = await response.json();

                if (result.connected) {
                    document.getElementById('cfDatabaseStatus').value = `D1 Connected ‚úÖ (${result.stats.inquiries} inquiries)`;
                    document.getElementById('cfStorageStatus').value = `R2 Active (${result.stats.files} files)`;
                    showNotification('‚úÖ Cloudflare connected!', 'success');
                    return result;
                } else {
                    showNotification('‚ùå Cloudflare connection error', 'error');
                }
            } catch (error) {
                console.error('Cloudflare status error:', error);
                showNotification('‚ùå Error checking Cloudflare status', 'error');
            }
        }

        // Sync data to Cloudflare
        async function syncToCloudflare(type, data) {
            try {
                const response = await fetch('/api/cloudflare/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, data })
                });
                return await response.json();
            } catch (error) {
                console.error('Cloudflare sync error:', error);
                throw error;
            }
        }

        async function syncAllDataToDrive() {
            showNotification('üîÑ Syncing all data to Google Drive...', 'info');

            try {
                const response = await fetch('/api/google/sync-all', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('‚úÖ All data synced to Google Drive', 'success');
                    console.log('‚òÅÔ∏è Sync complete:', result);
                    return true;
                } else {
                    showNotification('‚ö†Ô∏è Some data could not be synced', 'warning');
                    return false;
                }
            } catch (error) {
                console.error('Sync error:', error);
                showNotification('‚ùå Failed to sync to Google Drive', 'error');
                return false;
            }
        }

        function viewCloudflareStats() {
            window.open('http://localhost:8787/api/sync-status', '_blank');
            showNotification('üìä Opening Cloudflare stats', 'info');
        }

        async function forceSyncNow() {
            await syncAllDataToDrive();
        }

        async function testCloudConnection() {
            showNotification('üß™ Testing Cloudflare connection...', 'info');
            try {
                const response = await fetch('/api/cloudflare/test');
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úÖ Cloudflare test successful!', 'success');
                } else {
                    showNotification('‚ùå Cloudflare test failed', 'error');
                }
            } catch (error) {
                console.error('Test error:', error);
                showNotification('‚ùå Connection test failed', 'error');
            }
        }

        async function forceSyncNow() {
            showNotification('üîÑ Checking Cloudflare connection...', 'info');
            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'http://localhost:8787';
                const response = await fetch(`${workerUrl}/api/sync-status`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (result.connected) {
                    showNotification('‚úÖ Cloudflare sync successful!', 'success');
                    // Update the UI with the latest stats
                    await updateCloudflareUsageBar();
                    await loadInquiries(); // Refresh inquiries
                } else {
                    showNotification('‚ùå Cloudflare not connected', 'error');
                }
            } catch (error) {
                console.error('Sync error:', error);
                showNotification('‚ùå Sync failed - Check if Cloudflare worker is running', 'error');
            }
        }

        function syncPendingFilesToDrive() {
            const pendingFiles = JSON.parse(localStorage.getItem('pendingDriveFiles') || '[]');

            if (pendingFiles.length > 0) {
                showNotification(`‚òÅÔ∏è Syncing ${pendingFiles.length} files to Google Drive...`, 'info');

                // In real app, would upload files to Google Drive here
                setTimeout(() => {
                    showNotification(`‚úÖ ${pendingFiles.length} files synced to Google Drive`, 'success');
                }, 3000);
            }
        }

        // Make Google Drive functions global
        window.checkCloudflareStatus = checkCloudflareStatus;
        window.syncToCloudflare = syncToCloudflare;
        window.viewCloudflareStats = viewCloudflareStats;
        window.forceSyncNow = forceSyncNow;
        window.testCloudConnection = testCloudConnection;

        // Check Cloudflare connection on page load
        async function checkCloudflareConnection() {
            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'http://localhost:8787';
                const response = await fetch(`${workerUrl}/api/sync-status`);
                const status = await response.json();

                if (status.connected) {
                    // Always show connected for Cloudflare
                    const connectedDiv = document.getElementById('cloudflareConnected');
                    if (connectedDiv) {
                        connectedDiv.style.display = 'block';
                    }
                    console.log(`‚úÖ Cloudflare connected: ${status.stats.files} files, ${status.stats.inquiries} inquiries`);

                    // Update status fields
                    if (document.getElementById('cfDatabaseStatus')) {
                        document.getElementById('cfDatabaseStatus').value = `D1 Connected ‚úÖ (${status.stats.inquiries} inquiries)`;
                    }
                    if (document.getElementById('cfStorageStatus')) {
                        document.getElementById('cfStorageStatus').value = `R2 Active (${status.stats.files} files)`;
                    }

                    // Update usage bar
                    await updateCloudflareUsageBar();
                }
            } catch (error) {
                console.log('‚ùå Cloudflare connection failed:', error);
                // Show failed status
                const connectedDiv = document.getElementById('cloudflareConnected');
                if (connectedDiv) {
                    connectedDiv.innerHTML = `
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px; padding: 1rem;">
                            <h4 style="margin: 0; color: #ef4444;">‚ùå Cloudflare Sync Failed</h4>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 4px 0;">
                                Connection to Cloudflare worker failed. Using local storage only.
                            </p>
                            <button class="btn btn-secondary" onclick="checkCloudflareStatus()" style="padding: 4px 8px; font-size: 12px;">üîÑ Retry</button>
                        </div>
                    `;
                }
            }
        }

        // Update Cloudflare usage bar
        async function updateCloudflareUsageBar() {
            try {
                const workerUrl = localStorage.getItem('cloudflareWorkerUrl') || 'http://localhost:8787';
                const response = await fetch(`${workerUrl}/api/sync-status`);
                const data = await response.json();

                if (data.connected && data.stats) {
                    // Update file count
                    document.getElementById('cfFilesCount').textContent = data.stats.files || 0;

                    // Update inquiries count
                    document.getElementById('cfInquiriesCount').textContent = data.stats.inquiries || 0;

                    // Update orders count
                    document.getElementById('cfOrdersCount').textContent = data.stats.orders || 0;

                    // Calculate storage (mock calculation - in real app would come from server)
                    const storageUsedMB = (data.stats.files || 0) * 5; // Assume 5MB per file average
                    const storageUsedGB = (storageUsedMB / 1024).toFixed(2);
                    const storagePercent = (storageUsedMB / (10 * 1024)) * 100; // 10GB limit

                    // Update storage display
                    const storageText = storageUsedMB < 1024
                        ? `${storageUsedMB} MB / 10 GB`
                        : `${storageUsedGB} GB / 10 GB`;

                    document.getElementById('cfStorageText').textContent = storageText;
                    document.getElementById('cfStorageBar').style.width = `${Math.min(storagePercent, 100)}%`;

                    // Update status badge
                    document.getElementById('cfStatusBadge').textContent = 'Connected';
                    document.getElementById('cfStatusBadge').style.background = 'rgba(34, 197, 94, 0.1)';
                    document.getElementById('cfStatusBadge').style.color = '#22c55e';
                }
            } catch (error) {
                console.error('Failed to update Cloudflare usage bar:', error);

                // Show disconnected status
                document.getElementById('cfStatusBadge').textContent = 'Offline';
                document.getElementById('cfStatusBadge').style.background = 'rgba(239, 68, 68, 0.1)';
                document.getElementById('cfStatusBadge').style.color = '#ef4444';
            }
        }

        // Make it globally available
        window.updateCloudflareUsageBar = updateCloudflareUsageBar;

        // Already handled in main DOMContentLoaded above

        // Debug file saving issue
        function debugInquiryFiles() {
            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
            console.log('üìã Debug: Current inquiries:', inquiries);

            inquiries.forEach(inquiry => {
                console.log(`Inquiry ${inquiry.id}:`, {
                    customer: inquiry.customerName,
                    hasFiles: inquiry.hasFiles,
                    files: inquiry.files,
                    fileName: inquiry.fileName
                });
            });

            const pendingFiles = JSON.parse(localStorage.getItem('pendingDriveFiles') || '[]');
            console.log('üìÅ Pending Drive files:', pendingFiles);
        }

        // Force add download link for testing
        function forceFileDownloadTest(inquiryId) {
            const inquiry = {
                id: inquiryId,
                customerName: 'Test Customer',
                files: [{ name: 'test_file.stl', size: 12345, type: 'model/stl' }],
                hasFiles: true
            };

            // Test download
            downloadInquiryFiles(inquiryId);
        }

        // Function to fix existing inquiries with missing file data
        function fixInquiryFiles() {
            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
            let fixed = 0;

            inquiries.forEach(inquiry => {
                // If inquiry has timestamp property, convert to id
                if (inquiry.timestamp && !inquiry.id) {
                    inquiry.id = new Date(inquiry.timestamp).getTime();
                }

                // Fix files array if it's missing or malformed
                if (inquiry.hasFiles && (!inquiry.files || inquiry.files.length === 0)) {
                    // Try to reconstruct from fileName
                    if (inquiry.fileName) {
                        inquiry.files = [{
                            name: inquiry.fileName,
                            size: 0,
                            type: 'model/stl',
                            serverFilename: null // Will need re-upload
                        }];
                    }
                    fixed++;
                }
            });

            if (fixed > 0) {
                localStorage.setItem('inquiries', JSON.stringify(inquiries));
                console.log(`‚úÖ Fixed ${fixed} inquiries with missing file data`);
                loadInquiries();
            }
        }

        // Make debug functions available
        window.debugInquiryFiles = debugInquiryFiles;
        window.forceFileDownloadTest = forceFileDownloadTest;
        window.checkCloudflareConnection = checkCloudflareConnection;
        window.fixInquiryFiles = fixInquiryFiles;

        // Function to completely clean and reset an inquiry
        window.resetInquiry = function(inquiryId) {
            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
            const index = inquiries.findIndex(i => String(i.id) === String(inquiryId));

            if (index !== -1) {
                // Keep basic info but reset files
                inquiries[index].files = [];
                inquiries[index].hasFiles = false;
                localStorage.setItem('inquiries', JSON.stringify(inquiries));
                console.log(`Reset inquiry ${inquiryId} - please re-upload files`);
                loadInquiries();
            }
        };

        // Auto-fix inquiries on load
        setTimeout(fixInquiryFiles, 1000);

        console.log('üéâ 3D Print Business Manager fully restored and operational');
    </script>

    <!-- New modular system -->
    <script src="src/quote-calculator.js"></script>
    <script src="src/inquiries-system.js"></script>
</body>
</html>